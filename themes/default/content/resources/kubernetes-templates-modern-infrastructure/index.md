---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Kubernetes Templates: Modern Infrastructure"
title: "Kubernetes Templates: Modern Infrastructure"
meta_desc: |
    Explore how the new Kubernetes Templates from Pulumi can help you stand up a basic Kubernetes cluster and web application in this episode of Modern...
url_slug: kubernetes-templates-modern-infrastructure
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Kubernetes Templates: Modern Infrastructure"
  description: |
    Explore how the new Kubernetes Templates from Pulumi can help you stand up a basic Kubernetes cluster and web application in this episode of Modern Infrastructure. We'll set up a Google Kubernetes Engine cluster, use Pulumi, Python, and Poetry to use two templates together, and add in a provider resource to pass the 'kubeconfig' from the cluster to the application.  Learn more about the templates: â–º Kubernetes Cluster on Google Cloud: https://www.pulumi.com/templates/kubernetes/gcp/\ â–º Web Application on Kubernetes: https://www.pulumi.com/templates/kubernetes-application/web-application/ â–º Explore all of the Pulumi Templates: https://www.pulumi.com/templates/  Find the codeðŸ‘‰ https://github.com/pulumi/pulumitv/tree/master/2022-11-mi-k8s-templates  âœ… Get Started with Pulumi: https://pulumip.us/Get-Started âœ… Create a Pulumi account. It's free: https://pulumip.us/Sign-Up-OpenSource  00:00 Intro 01:02 Setting up the templates 05:39 Putting everything into one root 08:35 Creating the root Python file and modifying files 19:39 Running the code 20:49 Getting the output 21:30 Tearing it all down 22:58 Conclusion
  sortable_date: 2022-12-08T22:18:38Z
  youtube_url: https://www.youtube.com/embed/EunA77UGWOo
transcript: |
    Hey Cloud engineers, Laura here and welcome to modern infrastructure today. We're gonna be talking a little bit about our TTI templates that we've built here at Pulumi. So when you're setting up your TTI systems for the first time, you have to set up all of your infrastructure, including all the nodes, all the networking that you need and you need to set up your actual application, which is getting all your cluster together so that all the pods are running so that you have everything you need to be able to run your application. We've actually made some different templates here at Pulumi to be able to set up that infrastructure. So we're going to just take those two templates and run them and put them together so that we can have our application on Pulumi. We're gonna be using Python today with poetry. I have a couple of things already set up for us and we're gonna be using Google Kubernetes engine or GKE on the Google Cloud. Let's go see what this looks like on our terminal. All right, here we are in the terminal and we're gonna just take a look and see what I already have set up. I've got an application directory or an app directory and an infrastructure directory or an info directory. These are where I'm gonna be running my templates and putting those in here. I've already set up poetry. So let's see what that looks like pi project dot to. So there's a couple of things in here to pay attention to one. I've already installed, Pulumi Pulumi GCP and Pulumi Kubernetes in terms of all of my dependencies. And then the other thing is that I do have this package in here for the actual current running directory. We're gonna need that when we run our poetry instance. So just a couple of things to keep in mind. But let's head into the app directory and we're gonna do an install. So we're gonna use the Pulumi new command and we're gonna do this web app uh dash kubernetes, dash Python. This is the template that we have running. So when I run this, it's going to ask me for some sensible defaults. So in this case, I do want to actually name this template something very specific. Uh just because app isn't gonna be really de defined enough to be able to do this. So I'm going to call it, let's see, let's call it Miks app just for fun. And so we'll call it that and it's just gonna give me a default program here or project description. I am gonna want the DEV stack now it's gonna ask me for a couple of things. We don't want to use the default here when it comes to the name space because Google Kubernetes engine or GKE is gonna have some issues with it. So I'm just gonna call it fake dash ns for fake name space. You can call it whatever you want. This is what I chose to use. I only need one replica and it's just gonna go and create the virtual environment. This does take a few moments. So if you're running this on a machine that's uh might take a little bit longer, it happens. Um This virtual environment is not going to matter in the end because we're about to delete it. But in case this does take a little bit of time for you, we will take a moment. All right. And after a little bit of movie magic letting that go and install, we're gonna keep moving here. Now, there's a couple things to know. Since I don't need that virtual environment, we're gonna actually just remove it. I know it takes a little bit of time to get set up. But this is one of the things with using poetry. So we don't need the VM and we don't need requirements dot text either because we already have that in our poetry project. So we're just removing those. And now if we take a look at what's in here, you'll find, we just have uh the get ignore the Pulumi dot Dev dot Yaml, the Pulumi dot Yaml and the Duma dunder dot pi. So let's go up and we're gonna go into the infrastructure directory and we're about to do the same thing. So we're gonna do a Pulumi new and this one's going to be Kubernetes net even. I can't remember how to spell it sometimes GCP Python because we're gonna be using Python on both of these. You don't have to um if you choose to use, go for both of these, if you choose to do javascript, whatever you want to do. But in this case, I'm using Python because it's a little bit easier for me to do all of the importing. Again, it's gonna ask me for some sensible defaults. I'm just gonna call this Infra Mik eight just for fun. So we're gonna do this. We have a stack name of Dev. It's gonna ask me a couple of different things. So I have this running into Pulumi development, but you need to pull this out of your cluster or your uh GCP account, your Google cloud account yourself. Um This just happens to be the one that I'm working on. So my little sandbox and then I have a region that it's already gonna give me. So when I start this up, it's going to go through, I think it asks me one more question or two more questions and then we have our virtual environment. Yeah. So there's a node per zone and a couple of other things. Once we set up this virtual environment, it's gonna take a minute. Let's have some Movie Magic. All right. And after our little bit of Movie Magic, we already have the infrastructure directory. Now, ready to go again. We're just going to go and remove those old bits of virtual environment and the requirements dot text file. Uh because we don't really need that right now. So we're just going to remove those and we can then take a look at what's in the directory again. We just have these little bits and pieces. So let's hop up one directory. Now, here's where the fun begins because we're gonna now take everything and put it all together. So the first thing we need to do is get our Pulumi dot yaml on our Pulumi dot dev dot Yaml, all set up here in our current directory in this root directory, by the way. So this is where we are. Whoop has a that would help. This is where we are right now. The dot Idea directory is because of my ID E that's been opened in the background. So we have our application directory that is now full, our infrastructure directory that is now full and our po poetry project information, that's our lock file and our actual configuration file all set and ready to go. So the first thing we're gonna do is we're just going to touch means just generate a file with nothing in it. And then I want to go and pull out the infra directories, Pulumi dot Yaml file. And I just want to put that into the Pulumi dot Yaml file that we have here in this local directory. So this command, all that does is it copies the values out. And one of the things we want to do here and we will just do it real quick is we're going to go in here and just delete this virtual environment lines because we don't need it anymore. We're gonna be using poetry. So there's that and then we're also going to pull out all of the our dot DEV configurations that we already had from those sensible defaults. So, what we wanna do here is a touch Pulumi dot Dev dot Yaml. And then we're gonna take the app directories, Pulumi dot Dev dot Yaml. And we're also gonna take the info directories, Pulumi dot Dev dot Yaml and just dump it into our Pulumi dot Dev dot Yaml here. So then again, if we take a look at what's here, oop Pulumi dot Dev dot Yaml, we'll find all of the configuration values. So we have a little bit of cleaning up to do there. So let's go do that right here in our terminal while we are in here. So we don't need this line. And then the other thing is we don't need these name spaces, those name spaces are generated every time that you have an application. And in this case, we don't really need them because we're gonna be running this all as one program, one project. So the only thing we need is in terms of name spacing is this GCP one, everything else can come out. So we're gonna save that and now we should be just about ready to go through and add in our dunder main dunder dot pie. So in this case, I'm gonna go do this in my ID E just to make it a little bit cleaner. And so that you can follow along with what I'm doing, but you also certainly can do this in your terminal if you want to run it there. So let's switch over to the ID E OK? And here we are in my ID E. So I've got everything set up uh just as before, but we want to create a new Python file here in the root of the repo. So it's just gonna be main dunder, dunder, main. So double underscore is dunder, by the way, dunder, main dunder dot pi with pie. There we go. And we're gonna use this to import some various bits and pieces. So from Pulumi itself, I actually want to import the export command. And so what I wanna do is I'm just gonna call that Pulumi as there we go as Pulumi underscore export. I wanna have that one and I also wanna have the output command or the output class. I'm gonna import that as well. So we're gonna have that one in there. Now, from here, we're actually gonna import our application code. So import app dot main and I'm gonna import that as my app code just to make things easy. I also want to import my Infra Main as Infra code. OK? So there's a couple of things that we need to do to our application code to make it actually work. But for now, let's start pulling in some bits and pieces. So I'm just gonna define a variable infer it's gonna be the actual Infra code itself. So that's now going to run our infrastructure code from here. I'm gonna get a cube config and that is going to be this Infra code dot cluster underscore coop config where is that coming from? Let's go take a look. So here in the Duma Dunder dot pi inside of infrastructure, we have our various bits and pieces getting created. Here's where we get our configuration variables, we create a network, we create a sub network as well. And then we set up our close and with that cluster, we have a service account, a node pool. And then here is the cube config getting built down here at the very, very bottom and it gets exported right here on line 1 22. So if you're following along and you're digging around in the code, this is exactly what gets generated with that Pulumi new command. I haven't modified this code at all. So this is what you should exactly see. So we don't need to modify this code specifically. We do need to modify the application code. However, so this application code, if you were running it directly, you would be getting a name space, a configuration map which has all of our details about our engine X config. And then we have our deployment, that's our little web server that's going to be running our engine X system. And then we have the service that actually exposes everything along with a couple of exports that you can or cannot use. In this case, we need to wrap it in its own function so that we have a function that we can call in our root duma dunder dot pi. So these are some small changes that we need to do. So first things first, let's make a new function and let's let's just call it C create app and we're gonna be passing it a cube config cobe comp value that we're gonna be passing in here. Let me, let me actually, it's called Coup Confit because then that's a little bit easier for all of us. And then I'm gonna take all of these lines and we want to indent them. All right. So everything should be all set to go here. And one thing I'm gonna change that this is one of my things I am going to name this Andre Factor it just because it drives me crazy not to be using sneak case. Um But this is just a me, this is a me thing. So that should now be all set to go. So we have our create app in here and we're gonna be passing in this cube config value. Now, we do need to create a context for this meaning a specific provider that we're going to be using because we need to pass in a configuration value that's coming in from the outside. You can do that by setting a custom provider. So you're setting up a Kubernetes provider, which is what interprets all the kubernetes code inside of Pulumi. But we're going to be creating a one that is custom that takes in that cube config. So this is this new provider. So create a custom. Uh I'm just gonna call it, create provider uh instance for us to use. Ok. So from here, we're gonna just call it new underscore provider and this is going to be the Kubernetes dot provider itself. And I'm just gonna call it app provider because it's inside of my app directory and it's going to be passing in the whoop cube config this is a um uh property that you're able to be able to pass in. So coup config val in this case. And then one more thing I want to make sure it's using the correct name space and that's that K eight name space that we already have defined up on line eight. So from here, the one thing you need to do for every single one of these resources is we need to pass in this option to use the Pulumi um resource option. We need to specifically use a new provider. So you just put in here, use that new provider. You got to do this for every single one. So we're gonna do that real quick and we have that Pulumi and resource provider or resource options and then provider in here. And it's new underscore provider and same thing here, go all the way down to the bottom and it's uh Pulumi whoop. It would help if I could spell Pulumi, I really should be using those type ends a little bit more. It always helps though to type things out when you're learning something new instead of relying on your ID ES type in just because sometimes you will not learn that uh muscle memory to be able to type it all out yourself. So it's always good just to work on typing it all out yourself. So if you ever get a chance to just code and vim, sometimes that can be a really good thing for you. All right. Now that we have all these resource options already in here, there are a couple more things that we need to do first things first, we do need to modify this service because we need this to be a um a load balancer type instead of a cluster IP type on Google Kubernetes engine. Uh Just one of those things that is something you need to remember to do load bouncer, you certainly can do it as an IP. But then you have to add a lot of stuff. This is the simplest way to modify this specific template to dump me out with an end point, which is really what I want out as this template just for this specific use case. And then last but not least I, I need to return something. So in this case, I'm just gonna return the um web server service, I'm gonna return that little piece that comes from there. Uh So that gives me my IP so web server service dot status because this is where it is status dot apply. So this is one of our output applies that we will use to actually take a output un nest it. So like unwrap it all out and be able to pass it off to something else so that it's ready to go once it's been defined instead of just being a future. So this is just gonna be a lambda and I like to use vowel as my lambda. That's just kind of my thing. So vowel load balancer because I am looking for the load balancer value and I wanna just get the ingress, whoop ingress and I want the first value remember this is zero indexed. I want the IP from there. So this is what we have to do to make our main code work with app main dot pi. And again, if you're following along, there should be a github repo that I'll be linking in the description at once. I have everything all loaded onto youtube. So here, what we just need to do is finish out writing this code and we are going to now get the infrastructure app underscore Infra and this is gonna be an apply. So Coco dot apply and Lamb duck again, I just use V just it's a thing for value app dot create app. So who should be app underscore code? That's why it's not giving me what I want app code dot Create. There it is and it's looking for that coup config value. Remember? So in this case, we're just passing in coup the value or coup config there it is. So this is going to return exactly what I want. And then I do have to run one more Pulumi export so that it shows up on my um on my terminal when we're ready to run this. So Pulumi export and we're just gonna call this endpoint URL. And then here we want that App Infra. So App underscore Infra because remember it's already returning the output. I don't really need to put anything else here. It's gonna return a string. So this is the one value that I need, oh almost, it's gonna return it as a secret because reasons. So we're just gonna call it unsere. So if you didn't know you can hit unsere, it's not exactly the safest thing, but occasionally this happens with Pulumi. So we're gonna say unsere meaning take it unwrap it and don't return it to me as a secret. So this is that app Infra right there. So this is everything we need to be able to take these two templates, wrap them together and return the entire stack all built. So all of my nodes, my cluster, my networking, all of those pieces alongside the web application itself. Let's go see what exactly this does you ready? I think I am. Let's go back to my terminal. All right, and we're back in the terminal ready to go and we're gonna get started here. The one thing we do need to do is actually initialize that stack because remember we just copied the values into our system. So we're just gonna do a Pulumi stack, select DEV and this is gonna initialize us and we're ready to go. So we're gonna be running poetry. So we start out with poetry run. You certainly can put this all in an interactive poetry shell. I choose not to. This is just as easy. So poetry r Pulumi up and this is going to take a little bit once we get going, but I'm just going to show you how it gets started note that there's only six resources that are getting created. When in reality, we have about nine or 10. It's because of how everything is deeply wrapped on that apply. It's not able to notice what else should be in the resource graph, but we know it's there. So we're going to just hit. Yes and away we go. So there'll be a little bit of movie magic here speeding us all the way through. All right, and there we have it, we have 11 resources created. We have all of our outputs that we need, including that endpoint URL. Let's see what happens. We can actually just curl that. So Pulumi stack, output end point URL and notice that I'm passing that in as a variable in bash or in this case is CS H but same rough idea here. So when I curl that, we're gonna get back that NX home page, which is the default little home page that NX will send whenever it's all set up and ready to go. So we have our web server ready to change. And now you can go in and start changing all of your application code and your cluster is up and running pretty cool if you ask me. So always when you're trying something out new like this, make sure that you tear everything down, make sure you use Pulumi run or poetry run. Pulumi destroy dash Y Now, one thing to know is that because our graph wasn't perfect when we did that preview. Remember, it didn't have all of our application resources in the graph already. It's not going to know that the resources that are on that cluster are dependent on the cluster itself. So when it starts doing this, destroy, what we're gonna find is that it's going to delete the cluster sometimes before it actually starts deleting that name space and sometimes even the deployment and things like that, you'll know that sometimes that happens if it does, what you need to do is as long as the cluster is removed, meaning that the system can no longer talk to the cluster, the cluster has been deleted. You can actually go into states and remove those pieces for the actual web app that we've generated. So anything that is while this is going, anything here that says Kubernetes Colon app slash V one or core slash V one here on the next line, any of these ones. Oh Not that one, these ones, the ones that say crinet here at the beginning. So if you run into any of those, we can actually see what that one will look like. This delete will take a moment to do. And there we have it folks everything all together to do a cabernet cluster just using the Pulumi templates so that you actually have your web app up and running. We will see you soon for another modern infrastructure. Otherwise please go ahead check out some of the links down in the description. Be sure to subscribe and we will see you soon. Take care.

---
