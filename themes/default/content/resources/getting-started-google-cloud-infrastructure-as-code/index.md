---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Getting Started with Google Cloud & Infrastructure as Code"
title: "Getting Started with Google Cloud & Infrastructure as..."
meta_desc: |
    Google Cloud’s product offering is continuously evolving, and infrastructure tools often can’t keep up with the speed of innovation. Pulumi’s Googl...
url_slug: getting-started-google-cloud-infrastructure-as-code
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Getting Started with Google Cloud & Infrastructure as Code"
  description: |
    Google Cloud’s product offering is continuously evolving, and infrastructure tools often can’t keep up with the speed of innovation. Pulumi’s Google Cloud Native provider is built directly from the Google Cloud API, bringing power of familiar programming languages to Google Cloud without sacrificing on latest features.  In this workshop, we’ll use the Google Cloud native provider to build infrastructure using Pulumi’s TypeScript SDK and examine some of the features not previously possible.
  sortable_date: 2021-06-21T18:48:02Z
  youtube_url: https://www.youtube.com/embed/2CHXNWiREBE
transcript: |
    Well, I make that one minute past the hour. So let's get started. We don't want everyone, everybody uh you know, waiting for, for the late arrivals forever. So um let's just start with a couple of introductory things. Um I am Lee Briggs. I'm a developer advocate here at Pulumi today. We're going to be doing some straightforward introductions to the Pulumi tool and Google Cloud specifically. Um You should have got an email yesterday, that kind of detailed a few set up steps that you should have hopefully had a chance to do. Um If you did get a chance to do those set up steps, you will be able to follow along with me and type out the actual infrastructure code configuration as we go along. If you did not have a chance to set up those um to set up to do that pre prerequisite work, I will be sharing a link with you so that you can join me NVS code live share and actually take a look at what I'm doing. So hopefully, regardless of the preparation that you've had a chance to do for this, for this workshop, you'll be able to get an idea of what it's like to actually use Pulumi and use the tool. We have changed the format of these, these kind of workshop webinars. Previously, we did a bunch of slides and a bunch of introduction. I want to get people's hands on keyboards as fast as possible. So we've changed it up a little bit and it's a little bit less, it's formal, it's a little bit less. Um You know, the idea is that we're just gonna kind of take you through some of the basics of what Pulumi does. Um And so this is, uh, you know, this is supposed to be an organic type thing. I will probably make mistakes, but we'll figure out those mistakes together. Um And so it's not a polished type type event. You know, I'm not here to, to kind of sell you on the tool. I'm here to get your hands on the keyboard and actually using it. So with all that in mind, let's get started, there's a couple of things that we need to do before we're actually diving into our ID. So what we're gonna do is very quickly, I'm going to guide you through the process of creating a plume account if you haven't already done. So, um and then what we're going to do is I'm gonna set up my environment and get my ID up and running so that we can, um you know, we can actually start writing some code and doing some Google cloud stuff. So hopefully everyone's excited but let's get, let's get uh let's get started. I'm just gonna set up my screen sharing, bear with me one second and it looks like screen sharing is enabled. Hopefully everybody can see my screen. I'm also gonna turn off the video. Uh I've had some problems in the past with my internet bandwidth, so I'm gonna turn off the video. Uh So you don't have to see my uh my lovely face this morning or this evening where depending on where you are. Um But if anybody does want to ask any questions, I'm quite happy to turn that back on. So let's turn that off and hopefully everyone can see my screen. So first things, first, we need to set up a Pulumi account. Um And so, um you'll see that I'm logged into github um as my Elbrick's Plume user. Um And this is recommended if you have a github account. Um What we're gonna be doing is using our hub account, our as our, as our identity provider to kind of configure our Pulumi user. So, um what we'll do is uh we'll head to www dot Pulumi dot com. Um I, I understand that's probably not the biggest um you know, the, the best um best tech size. So let's zoom in a little bit. Um So Pulumi dot com in the top right hand corner, you'll see a couple of links um such as docs and Slack, what I'd like you to do if you haven't set up a Pulumi account, just hit the sign in button here, which should open a new page. Um And then you should be presented with these four options to actually sign into Pulumi. Um I would highly recommend if you do have a github account using github to actually sign up for your account. All Pulumi accounts are as you can see here free forever for individual use. So we'll be doing individual Pulumi projects today. So you get a free Pulumi account. It's not gonna cost you anything. You're not gonna have to put in a credit card. Um And so you, I would highly recommend getting this done at this point so that you can kind of get, get started and, and get provisioning infrastructure at any minute now. So uh I am gonna click on this get link and it, it should take you to this github page which is asking you to authorize the Pulumi console. We need access to your github email address so that we can actually verify your identity. Um And we also need a read only access to um to your github repo, your organizations and teams. Uh Pulumi web service kind of shows you some visualizations on your github account when you actually push Pulumi code to your github repo. Uh So we only need read only access all of the work that Pulumi does to provision resources in Google Cloud is done locally on your machine. We never need any kind of credentials from you at all. Um And so this is all read only uh the Pulumi uh the Pulumi console doesn't need access to anything and doesn't need right access to anything um in your Google Cloud account. So I'm gonna hit authorize Pulumi like so and you should get taken to a page like this, which means that you have successfully set up your Pulumi account. Um So you are now ready to get started with Pulumi and actually start provisioning resources. There is a final thing that you to do on your local machine though. I'm just gonna take my watch off because it's annoying me. Um There is a final thing that you need to do on your local machine though and you need to log in as that user. Um And so what we're gonna do now, I'm gonna very quickly guide you through what that looks like. Um Let me switch to my, well, the screen there we go. Um So on your local machine, you should have a Pulumi command line interface if you have uh um if you have installed it already, if you haven't installed it, um then there are instructions if you do uh if you head to Pulumi dot com. Um and look at the get started documentation on the left hand side here, there is a download and install set of instructions which I will post in the chat so that everybody can see it. Um But you need to have this command line interface installed. How this works is Pulumi will locally provision your resources and then it will tell this Pulumi console here. Uh It will tell the Pulumi console what the result of provisioning those resources are. I'll talk a little bit more about that as we kind of get into actually writing some code. Um So make sure you've got the Pulumi command line installed and then what you need to do is type Pulumi log in. And you can see I'm already logged into my account. When you type Pulumi log in, it will give you uh it should open a web browser for you on your local machine which will guide you through kind of setting things up. I'm not going to go through that process again because I don't want to break this, this uh break my environment. Uh So you just need to make sure you type the Pulumi log in command and it should open a browser and ask you to sign in again to Pulumi. Um And you should be able to um kind of click through those screens and you will be ready to go to actually provision Pulumi code. I want to make sure that everybody has a chance to actually do that. So I'm just going to wait a second, just take a quick pause, make sure everybody's kind of logged in and ready to go if you are planning on following along with us and actually kind of provisioning stuff together. Um, if you don't want to do that, as I already mentioned, then what I'll do in a few minutes is I'll be sharing access to my ID. Um, we can do, uh, you can actually follow along, uh, by, by logging into the ID as well. So I'll get that set up and we'll wait for everybody to make sure that um you know, we'll make sure everybody is getting uh getting to a place where they can um they can actually join us. OK? I just sent a link in the chat. It's also in the handouts tab within um within big Mara. So there is a link, uh a read only link to my visual code live environment. Um If you want to follow along with me and watch the kind of things and watch what I'm doing, uh then feel free to just open that link. Um And you should be able to actually see um as I'm typing things out, you should be able to actually look at my environment and be able to actually get an idea of what's happening and what's going on while I'm provisioning. Um You know, while I'm provisioning things. So just take a second, make sure anybody who wants to join in has that opportunity and then we'll get started. Let's we can start actually provisioning some, some infrastructure using uh infrastructures code allow, it's probably not gonna work. There we go. If you are trying to use the link and it isn't working, please let us know in big marker and I can get that, make sure that's, that's gonna get sorted and taken care of. There we go. Ok, let's get started. Shall we? Um let's uh let's actually provision some infrastructure source code. So we have um in our terminal here, we have this um git repo which I have configured for you. The link is in the handouts. I'm gonna bring it up again on the, the page here. So um it's at, that's not the right one. There we go. So here's the link to the actual content of the actual um of the actual workshop today. Um So there's a couple of things that I want to bring your attention to. Uh The first is there's this www root um directory which contains four files. It contains an index dot html, which is just a very, very simple web app. Um It contains a four or four page and it also contains a Docker file which is just an engine X Docker file which copies all of the configuration into the Docker image. And then also there is a engine configuration which actually serves the index page. Um What we're going to be doing over the course of this workshop is we're going to use two Google cloud services to provision this application this really, really simple, straightforward application. So first we're going to provision this as a static site using Google cloud storage. And then after that, we're going to build this do a file and we're going to push it to Google cloud image registry and we're gonna use Google's cloud run. The idea here is just to get you an idea of what using Google cloud platform with Pulumi typescript SDK looks like. So we're not going to be building anything too elaborate today. We're not going to be building anything, you know, a huge multi, multi dimensional multi, you know, um micro service architecture. It's just kind of the idea is just to get and get you used to um what using Pulumi looks like. And so we've got three what we call labs. The first one is relatively simple. We're going to create a new project and install some dependencies. The second one, we're actually going to deploy a static website. So as I already mentioned, we're going to upload those html files to a Google cloud storage bucket. And then finally, we're going to use a Google cloud run to actually confit, you know, to actually run our application again. So those are going to be the three steps. It's probably going to take us about an hour, maybe a little bit longer. It may end up not taking that long. Um But, and I've just noticed I've type out the, the title, look at this Um So if you want to send a pull request to fix that, then uh please feel free to do that. Um So we're gonna kind of do that in, in that order. So we're gonna set up our project and then we're going to provision these static files to a Google cloud bucket, uh storage bucket. And then we're gonna provision a doer image with Google cloud run and hopefully that will give you an idea of what using Pulumi looks like. So let's get started. Um The first thing that I want you to do if you are following along is fork or clone this repo um and then clone it to your local machine. So you'll see. I have it cloned locally here. Um And what we're going to do within this particular um within this particular um uh within this particular directory. Sorry, my brain just switched off for a second there. Uh What we're going to be do doing here is we're just going to create a new directory using the make directory command. So if you are familiar with this, we're gonna do MC directory or M CD. Um My first GCP app like, so Pulumi needs an empty directory in order to actually uh bootstrap projects. Um And what we're gonna do is we're gonna use the Pulumi new command to actually populate this directory. So we need to navigate into it using the CD command. My first GCP app and I'll verify that this is an empty directory, um, to make sure there's nothing in here. Um And so what we, we obviously know that we want to provision something with Pulumi. So we're going to bootstrap what we call a Pulumi project and we're going to do that using the Pulumi new command. Um, so I'm gonna type Pulumi New and hit enter and you'll see that it actually, if you hit enter at this point, you have a bunch of different, um you know, a bunch of different templates that you can use to actually, um you know, to actually get started. So we're going to be using typescript today. We're going to be using typescript with Google Cloud. You can see there's a bunch of different options here. Um Like generally you would just kind of choose the one you want. Um But what we're going to be doing is um we're gonna actually do this from, from scratch. Um So I wanted to show you the Pulumi new command and all the options that you have available. But what you can also do is just exit out of that or select it if you want, but I'm going to exit out and put Pulumi new typescript like so um then it will prompt you for some options. So, um it's gonna ask you for a project name. Um By default, the project name is the name of the directory that you created. So our project name is gonna be my first GCP app. So I'm gonna hit enter and use that as the default. The second thing it's gonna prompt you for is a description. Um descriptions are really useful because it allows you to actually um put some information in there. Perhaps if you collaborate with colleagues is a great example, you put some information in there about what is actually happening within this project. Um This is probably likely your first project or you certainly haven't got a whole bunch of them. Uh So you can just maybe use the default for this particular um workshop. So we're going to do a minimal typescript Pulumi application. The next thing that it's gonna ask you for is a stack name. Uh stacks are a mechanism within Pulumi to use to, to reuse your code in different configuration environments. I'm not going to be going through stacks today. If you are interested in getting started with stacks and understanding them, we do do an introduction to Pulumi workshop which will allow you to kind of get hands on with what stacks are and how they work. Um Mainly um mainly we're gonna use the DEV stack today. We're not gonna be switching between stacks for this particular workshop. So you can just use the default DEV and then once you've kind of populated all these values, Pulumi will go ahead and take care of bootstrapping the project for you. If you are a typescript developer, if you used a bunch of typescript before. If you've done a bunch of React work, this is very similar to what Create React App does. It's going to install all of the dependencies that you actually need and populate the directory so that it has everything that you need in it. So if we take a look at this, you'll see there's a bunch of different files in here. Now, we have no modules because we're doing tight groups. So we need to install all our dependencies. We have an index dot TS which is where our code is going to go. We have a package dot JSON, which is because this is obviously a um this is obviously a text program. It has all of our dependencies in a package dot Json. And then finally, the one that you might not be familiar with is this Pulumi dot Yaml file. Uh This is just going to contain information about the Pulumi project that you've created. So for example, it's gonna say my first GCP app, which is the name of the project that we created. You'll see the description that we selected there is in here and then there's also the actual run time. So as you may know, Pulumi supports a variety of different uh language sdks. So we need to actually tell Pulumi the Pulumi command line interface, which of those run times we are going to use. So in this particular case, we're going to be doing no Js today, if we have created a Python application, it would say Python, if it was gonna be go, it would have go. Um And so this is the only thing that's kind of different from a standard type script. Um You know, a, a standard typescript project. Take a quick pause there, make sure everybody's up to date. If there is any problems we do have, I do have Zach with me today helping out in the, uh, in the chat. So please feel free to ask any questions or if you're stuck at any point. We've got Zach on hand to help out. And if, if there's anything that, um, you know, Zach thinks that is gonna be useful or relevant for the for the whole group, he will, he will kind of chime in and say we have a question from the chat. This is supposed to be interactive. So please feel free to, to kind of jump in with questions in the chat at any point. I'll take a quick pause there and make sure everybody's got their Pulumi project bootstrapped and then we'll get, we'll keep going. Ok? Uh I just want to make sure before we continue. Um II, I did mention in the email that we sent out that you are going to need to be authenticated to Google Cloud to actually kind of follow along today. So what I just recommend everybody do is very quickly type G cloud off list. Um like, so, and you can see this will show you the credential accounts and you'll see that I have an active account here. Um Just to make sure that you are um kind of up and running. And then also you should all have a, a project, a Google cloud project configured within your environment. We're going to be setting that in a few moments. Um I want to make sure that everybody is, um you know, has a project up and running. Um So what we need to do at this stage is actually configure Pulumi and tell Pulumi which project we're going to actually use, deploy all of our infrastructure to the way that we do that is we use the, the Pulumi config command. So I'm gonna just quickly get this out of my history. Um You can see here, there is a plume config set uh configuration command and we're going to set the GCP project. My project is called L bricks. Um So that's obviously the one I'm specifying. Um what you should do is use the project name that you have available to you. So, um uh if you want to take a look at where this is, if you want to just copy this command rather than type it out, uh You can see it's, it's step five at the end of um at the end of the first lab here. Um So make sure that you've set your Google cloud project. Um and I'm gonna hit enter like so and what that actually does we take a look inside our directory. You'll see that a new file has appeared. We have this Pulumi dot dev dot yaml, this is where stacks come in. So if you wanted to provision infrastructure to multiple projects, you can set a project per stack. And if I have a look at this command, if I open it up, you can see that it's got this GCP project configuration setting, which is specific to this DEV stack. Um So if I created a new stack, I could have a different project, which is really useful because obviously with infrastructure's code, you want to make sure that things are repeatable and you're doing things over and over and, and then sorry that, that it's easy to provision between your development and your production environment. Um And so stacks will allow you to do that. It makes it easy to actually, um you know, it makes it easy to actually use the code that you have over and over again. Um And so make sure that you've kind of configured your GCP project like so, and you've configured it and there should be a Pulumi dot dev dot YAML, OK. One more piece of set up that we need to do before we actually start writing code, uh We actually need to install the mechanism that Pulumi uses to talk to Google cloud. Um And the way that we do that is using the package manager for our language of choice. Um So we will use M PM. Um One of the more popular parts of the package management ecosystem in, in um in the javascript community. Uh Obviously, if you prefer to use yarn, you could use Yan instead, but we highly recommend M PM. Um And so what we're gonna do is type M PM install at Pulumi forward slash GCP. And what this will do is it installs the node Js um node module for go for Pulumi GCP. So that you can actually start writing code for your Google cloud provider. If you have used other infrastructures code tools, this is where Pulumi differentiates itself. So we will use the standard language ecosystem um instead of kind of a custom language or a custom mechanism between install these providers, we just use the language ecosystem that you are already using in your application development life cycle. If you're a javascript programmer, you've probably used MP MA dozen hundreds of times perhaps by now. Um And again, you're just using those same mechanisms that you would normally use inside your application life cycle. So we're using M PM to install our Google cloud dependency. Um And we're just, we're just kind of running it and it's, it's going to get set up within our project. And so we should be able to see that in our package dot JSON, you'll see that we've added a new dependency for GCP. Um And it's kind of constrained it to the to the 5.8 0.0 version of the GCP, Google cloud um provider. Um And this allows us now we're ready with a simple M PM install. We're now ready to actually provision things in our GCP. Uh you know, in our GCP account, which I think is really awesome, especially if you're like a front end developer and you are kind of getting started with infrastructures code. This is really, really helpful because you're not kind of having to learn a whole new ecosystem and a whole new set of tools. Oh, sorry, I was on the other, I was on the other thing that hopefully that should have accepted. Uh You know, I'm doing two things at once here. So uh great to see the people are joining in with the uh with the VS code um option as well. I'll, I'll just wait a minute to make sure everyone's up and running. Um If you do want to join the session, um it's in the actual chat. So just click on that link and you should be able to actually see um you know, join my VS code live share too. OK. So let's take a look at our open editors. Um And now open files. So you can see here we've got a new directory um within my first GCP app like. So, um and so what we're gonna be want to do is, oh, sorry, let me get my words right. What we're going to want to do here is open up our index dot TS file so that we can actually start writing some Pulumi code. Um, so let's open that up. I'm gonna just quickly zoom in a little bit so that everybody can get a better view. There we go. Hopefully that is nice and nice and, uh, nice and unviable for everybody. Um So this is a bare bones Pulumi program. Um We haven't actually imported out a GCP provider yet. Um And so, uh you can see, I've imported the Pulumi SDK by default when we do a Pulumi new that just kind of takes care of it for you. But we want to do, we wanted to provision things in Google Cloud. So the next thing that we want to do is do import all as GCP from uh Pulumi GCP like. So, um so this is going to import the actual Pulumi SDK for Google Cloud into our project, which will allow us to actually provision things within Pulumi. And again, it's using standard typescript. There's nothing special about this at all. If you have written typescript before, this will seem familiar to you. Um So, you know, if you have like created React applications is a great example. This is all the same workflow and the same thing, but we're going to use it for our infrastructure as code instead. And that's the end of the first lab. So the first lab is just getting you set up, it's getting you installed, getting everything available and ready to you, making sure that you have the project set correctly, installing the GCP provider. And then we kind of take, we took a look around our new project and looked at all the different files in there just to verify that it's basically an M PM. Uh, you know, it's an M PM project. Take a quick pause there, make sure everybody is up to date. And then what we're gonna do is we're gonna move on to slab two. We're going to actually create our static website so you can just hit this link at the bottom if you are following along and you'll see there's a bunch of code in here. Um I wrote this uh last night and this morning. So uh there may be a few mistakes in there. We'll figure it out together. Uh I wanted to make this feel like just as much as I, I wanted to make this feel like it was just us creating uh infrastructure together. So there may be a few mistakes in here, but we'll hopefully get an idea of what the actual workflow for um provisioning Google cloud resources looks like. Ok. So we already talked about what we're gonna be doing. We're going to be provisioning a um a Google cloud um storage bucket and then we're going to upload some content to it to make a static website. Um And so let's go ahead and do that. Um So in order to do this within Google Cloud, there's a few things that we need to do, we need to provision a new G CS bucket and then we need to make sure that all of the actual objects that we upload have read like public read permissions. And then finally, what we need to do is upload those objects and we're going to do a couple of different things here that kind of show you the power of Pulumi and using typescript to actually do infrastructures code. But let's start nice and straightforward. Let's actually provision our bucket. So what do we do to provision a new resource within Google cloud? What we do is we create a variable in our language of choice. Um Whether that be typescript or Python or go, we create a variable and then we assign the value of a resource creation to that variable. So if you've used typescript before this will see, seem pretty familiar. So we're going to declare a constant and let's call it bucket. That seems like a good thing to call our bucket resource. Um And then what we're going to do is assign the value from the Google cloud provider. So we do new GCCP dot And this is where I want to just take a quick moment here to show you what we get in terms of the value from using um a standard typescript library. And this is this applies to all of Pulumi different language SDK. But by using a well defined kind of type safe language like typescript, we get all of this auto complete um from our ID. If you are a software developer by trade, rather than maybe a DEV OPS engineer or you've never used or you've used ID ES in your past, this is super, super valuable because it means you have all this discover about Google Cloud directly from your ID. And we know that we want to create um a bucket. So let's just start typing and we should get storage. And then if I hit dot Again, you can see these are all the different things I can do within the storage name space within Google Cloud. So we know we want to create a bucket. So let's do let's create a bucket and then let's, let's see what our ID is telling us, what are the actual things that we need to pass to a bucket in order to create it. Well, we need a name. So the unique name of the resource, there's a set of arguments and then there's some options and you can see that we are not, we haven't finished rounding out our Google cart bucket. It's expecting 1 to 3 arguments, but we have zero at the moment. So let's get this fixed and make sure that our bucket is actually gonna work properly. Um So let's give it a name. Uh I am going to call it website and it needs to be a string. Uh And then we, and then you can see, I need to provide some arguments uh which is uh an arguments bag. Um And so what, what do we need to provide in the arguments? Well, we need to tell Google cloud which location we're going to actually store this bucket in. So if I start typing location, you can see, um it gives me all of the different options that I, that I need to specify. Uh because it's typescript, uh it's given us a uh it's telling us that that is optional. Um If we need it to be, um, we want to specify a, a location. So I'm gonna do location is us and I can examine this, I can go to the definition here for this bucket and actually look at all the different things that I need to actually specify. Um Again, this is just a, this is just a, um, you know, this is just a standard typescript library. Um So we, you can see these are all the different things that I want to be able to specify. And you can see there's options in here as well. So like if we wanted to, we could specify some encryption options and we can also specify the project directly or we can say the requester pays. Um And all different kinds of things here. But you can hopefully get an idea that um because this is just a standard typescript library, we can follow the same, um you know, we can follow the same ideas within our software development life cycle. Um And so I think this is super powerful and it makes me, when I'm provisioning my infrastructure, it makes me way more productive um when I'm actually provisioning stuff. So that's step one done. And let's, you know, because we're good software developers. Let's add a comment, uh create a Google GCP storage bucket in the US. Uh And we need to round this out. OK. Um The next thing that we wanna do is specify a set of AC LS on this bucket so that when we upload the files to the Google cloud bucket, when they get uploaded, we need to make sure that they have like all users have access to them. Otherwise when our users visit our static website, they're going to end up with, um you know, they're gonna end up with a uh a request denied and we don't want to do that because this is a static website. So let's create a new variable called AC L and we'll do new GCP dot storage dot default access control, default object access control. And so this is saying that when we're uploading our files, any file that gets uploaded to Google cloud uh to this Google cloud bucket should have this particular AC L added to it. And we're gonna again give this a name because every resource in Pulumi needs a name and then we're gonna look at the different arguments that we need to provide. And there are some required arguments for this particular um for this particular um resource. The bucket resource has no required argument. So you didn't kind of see this error. But he let, let, let's talk a little bit about what we're getting from our ID E here, right? If you've ever used another um infrastructures code tool, you might have noticed that the feedback loop for that infrastructures code tool can be a little bit frustrating because you might not know about the things that you've missed until you've already tried to provision something um with Pulumi because we have this strongly typed API and these strongly typed stks, we can actually know which values are required and which values are not required. Um And so this is really, really useful. It gives you this much better feedback loop while you're, while you're defining your infrastructure. So I know before I even try and run this Pulumi program, then I need to actually populate some of these properties, the bucket, the entity and the role. So I can be much more confident when I do go to provision my infrastructure that it is defined correctly because the actual library itself is giving us that information. So let's let's give it what it needs to know. So we need to specify a role and we're going to specify the reader role and then we're gonna specify an entity. So let's specify all users. And then finally, the thing that's missing, let's just have a look and make sure that the um uh let's have a look here and see what the uh ID is telling us. It's telling us that the bucket is missing. Um And so that's the final thing that we need to populate. But I want to just take a moment and talk about what we're gonna do here. So we're gonna say book it like so and then we, what we wanna do is we want to assign this AC L to this bucket that we've created. Um And so what we need to do is specify the bucket name, but we don't want hard code it. So what we don't want to do is do this right? Because then Pulumi will not know the relationship between these two particular things and it will create them um in a uh in a, in a, in any order. Uh What we actually want to do is tell this uh default access control resource that we want to use this particular bucket, right? So what we can do is we can use the variable so bucket like, so dot And you can see what we're gonna see what we're gonna be provided with here is what we call Pulumi outputs. Um And this is when we create a Pulumi, when we create a GCP bucket, that API call has a bunch of responses such as the name of the book created and whether encryption was enabled or whether the request to pay object was enabled. So what we do is we actually specify the name of the bucket from the actual bucket variable here. And what this will do is it creates the relationship between these two resources. This is what allows us to use an imperative language as in typescript and create decorative infrastructure because we have these outputs that kind of get returned from the Polo API and we can pass them to other resources to create a dependency graph between them. Um And this is really, really powerful because it means that you um don't have to think about state storage. You don't have to think about the ordering of things. Pulumi takes care of all of that for you. So we created a default access control. Um The next part of the uh you know, the next part of this is that we need to actually upload our objects, right? So let's go and do that. Now, what I could do here is I could just say, um you know, I could I know what the files are um that are in my um they're in my wwwww roots directory here. Um But let's just get a, a little bit fancy with this and let's use a typescript loop in order to actually create resources. Because what I want to show you here is that you can be a lot more expressive than other infrastructure as code tools because we have the full power of little typescript at our disposal. So what I'm going to do here is I'm going to create an array of all the files. So index dot html, let me scroll there we go, index dot html and 404 dot html like. So these are the two files that we want to upload to our static website. Um And so we created an array. If you are familiar with typescript, this looks, this should look pretty familiar. And then what we can do is use the map function to operate on every item in that array. This might be new to you if you are used to other infrastructure as code tools because ultimately, we get all of the power of typescript at our disposal. So what I'm gonna do is type map like so and then what we're gonna use is use the actual name of those files. So let's do name like so and then what we can do within this loop is we can actually use the new constructor to actually create a bucket object for each one of these files. So we can do new GCP. Let me scroll this down. So we don't get the GCP dot storage dot bucket object and then we can specify the name as index dot html, which is, um, you know what our, our, our 404. And then we, and then like, like with our previous, um, you know, with our two previous examples, there are some required values here. So we need to make sure that we specify the bucket that we're going to upload our bucket object to. And if you are, you know, thinking about what we just did earlier, we can specify the actual bucket name. So we don't actually need to, um you know, we don't need to um hard code that name. We can just get it as an output from our previous resource. And then we also need to specify the source of that bucket. Um This is an optional parameter, but we do need to specify the source. So let's do new Pulumi dot asset dot file archive and then we need to specify the path to the actual file. Um And if we look at where this is in our directory, it's outside of my first GCP app and in www route. So what I'm gonna do here is do up one level www route forward slash and I can use string interpolation here for name like so and then finally, we're going to do something a little bit different here. We're actually going to hard code the name of this resource and I'll talk a little bit more about this in a few moments. But what I'm gonna do is specify the name property uh to the actual name from this loop here. Um So we're gonna just kind of loop through all of, we're going to loop through this array and we're actually going to create a new bucket object with the name of index dot html and 404 dot html. But we're also going to specify the name specifically. Now, you'll notice that we have a relationship between this bucket object and this bucket here. But we also need to make sure that be that we have this AC L created before these bucket objects get all loaded. Because what will happen if we run this Pulumi program right now is that this is dependent on this. So it will create the bucket and then it will create the default object access control for that bucket. And then there's a dependency between this bucket object and this bucket. So this these two resources will happen at the same time. So we'll get, it will create the default objects access control and it will also create the bucket object at the same time because those things can happen in parallel. What I noticed when I kind of ran through this example is because these were happening at the same time because this access control wasn't available when the objects were uploaded, they were actually getting uploaded as private files rather than public files. So what I'm gonna do here is I'm going to create a an an explicit dependency between these bucket objects and this uh default object asset control like so, so I'm gonna say it depends on AC L like. So now you only need to specify that something depends on another resource if there is no input, that has an output from another resource. So we don't need to explicitly as an example of this, we don't need to explicitly specify the bucket here. We don't need to do that because you can see already there is already a dependency between the bucket and the bucket object name. And so it's going to do things in the right order. But if you do need a little bit more flexibility around your, around your dependencies, you can use depends on which is part of the options bag here. If there aren't any questions about that, then just drop them in the chat. I'm quite happy to explain a little bit more. Um But yeah, that's, that's just create, that's just allowing us to create the actual dependency between two different resources. OK? One final step before we, before we provision our static site, we need to know what the URL is gonna be of our static site website. So we can do this using exporting constants from our project. Um So let's go ahead and do that. We're going to export constant URL equals Pulumi dot interpolate. Why are we using Pulumi on interpolate? Well, let's finish this off and then I'll talk a little bit about what Pulumi interpolate does storage dot Google API S dot com forward slash bucket dot name forward slash index dot HML. So this is going to return to us a website URL at storage dot google API S dot com with the bucket name in it and also a pending end hix dot hmln. Why are we using Pulumi dot interpolate? Well, as I already mentioned to you when we create our bucket, it it it it goes to the API of the Google Cloud platform and creates a bucket and it's going to create a bucket with a specific name, but Pulumi doesn't know what that name is going to be until that API response has come back from Google Cloud, right? And so what Pulumi, excuse me, what Pulumi interpolate is going to do is it's going to allow us to actually create this string with this already known value of, you know, http Google stars API S. But it's also going to allow us to insert the bucket name into here while we when that value is known. So it's basically saying, wait for the response from the API and then build this string. So let's comment this here so that we understand what's going on here. Build the URL when the bucket name is returned from the Google cloud API like so, so this is what Pa Pulumi interpolate does. There is a blog post that I have that I wrote that explains a little bit more about this. I'm just going to share this in the in the chat. Uh It's called understanding Pulumi imply apply. Um I would highly recommend reading through this to get an idea of what is actually happening. Pulumi interpolate is just a wrapper around what we call apply. So the same concepts apply to um Pulumi interpolate. But hopefully that that link will give you an idea of what's actually happening here. And it's just basically to give a very brief summary, it's just basically saying wait for something to happen and then do something. Um And that allows you to interpolate strings with eventual strings. So this is our static website. We've built it, it's up and running, it's ready to go. Um All we need to do now is we need to run Pulumi up to actually provision this infrastructure. So let's head back to my terminal. Uh What I'm gonna do is run Pulumi up and I have an error. Excellent um failed to compute archive hash www index at TM. What did I do? Ah I used the wrong resource. So this is not a file archive. It is just a file file. So let's go and fix it. So what what happened there is I used a file archive. I let my own complete get away with me and it's trying to find an actual Taba or a zip file. So let's change this to file asset like so there we go. That looks much better. Let's Ron Pulumi up there we go. That looks a lot like it. So you can see it's going to create some resources here. Um You can see it's going to create a website bucket and a default access control and a bucket object A 404 html and in html. And I can take a look at the details here and you can see it's, uh, you know, it's, it, it looks pretty good. Um Let's take a look at what the actual website name is going to be though. So the actual book it that we've created, we called it website, right? But it added this random string on the end here. Why did Pulumi do that? The reason that it does that is that a lot of like pro provide cloud providers, their API S are immutable like you can't replace that, you can't replace um certain resources. So in order to allow you to do things like blue green deploys, um we are um Pulumi will automatically append these values here to the end of different resources unless you specify a name implicitly, which is what we did for the name of the files itself. So we, we explicitly said that we want it to be called index dot html because we don't want to have index dot html, dash a bunch of random strings for our website. So we actually explicitly specified the name, you can override Pulumi auto naming on a per resource basis. So using a random string for the bucket is totally OK. But using a random string for the actual index website is definitely not. So we've seen both examples of that. So what we're going to do is just hit. Yes. And you can see notice the order that that happened in it happened pretty quickly, but notice the order that it happened in it created the bucket and then it created the default object access access control because the bucket. So this resource, the default object access control relies on the bucket. And then once that had created because we have this explicit depends on here. It created the bucket object after the object access control was created. So that should mean that we should be able to access our website. So I'm going to copy this URL here and I'm gonna take it to my browser and I'm gonna do this. Excellent. We have a working uh we have a working website um on a Google cloud bucket, but our website doesn't really work properly because how can you have a server address and a host name on a static website? This isn't really what we want from our little sample application. We actually want these values to be populated. So that's why in a few moments, I'm just gonna take a quick pause, but in a few moments, we're going to upload this as a docket image and run it in Google cloud run instead. Uh Thanks for letting us know that if you, you are depending on the way you um authenticate to Google Cloud, you may need to run Glod off application default log in uh before you actually. Um So uh our Google Cloud account is just a sandbox. So depending on what happens there, it looks like the question that Paul, it looks like your Google Cloud account does not allow. Um It looks like somebody has set some policy on your account that doesn't allow you to do to publish objects from a bucket. So that looks like a configuration issue at your Google cloud level. Um What you might want to do just to actually get this working properly. Um Paul is um just um you know, don't specify an AC L um and that it won't let you actually view the website. Um but it will allow you to actually complete your ploy program. Um And so uh you might just want to comment this out like so and then comment this out. Um That should allow you to get to a place where your provisioning request uh runs. That doesn't look like it does look to me like there is a totally understandable policy within your organization that does not allow you to expose files from a bucket, which is a very good security policy. Uh But obviously for this particular example, um that's obviously going to be a problem. So I do I do apologize for that. Um Hopefully, um hopefully the next step you'll be able to get this running. OK. So we already mentioned our website is not doing what we expect it to do. So, in order to fix this, let's go and create a new, um let's go and create a new resource. Um So, what we're going to do now is let's just take a look at this file again. So in our WW what we're gonna do is we're going to use this, do a file and we're going to build it um using Pulumi, we're going to build this, we're going to actually upload it to a GCR image and then we're also going to um upload it and run it in Google cloud room. Um So we need to add an additional dependency to our um Pulumi project. Before we do that, we need to install the Docker provider. And again, we've already done this with Google cloud. We're gonna run M PM install at Pulumi forward slash docker like so, and it's already installed for me. So you may see a little bit more feedback and output. Um So this will allow us to actually build Docker images locally. Um Before you do continue, I would highly recommend making sure Docker is running. So you can see I have a bunch of docket images built locally, so run like a docket images. Um uh Docket info is what I'm looking for. Just make sure you have DACA running locally. I have run this workshop before and completely forgot to start the Docker client. Um So just make sure you actually have do a running. So, docket info should return a successful, um you know, successfully, basically. Ok. And of course, don't forget to install the Docker provider as well. So make sure that's installed in your environment as well. And again, you should be able to verify that it's there in our package dot JSON like. So uh at Pulumi dot co like so, and as with our GCP provider, the next thing that we need to do is actually import that library. So import all as Docker from app Pulumi Docker like so, so just do that at the top to make sure that we're actually able to build that Docker image. OK? So, what we're gonna do now is we're going to uh we're going to move on to the next lab. So let's go back to my web browser real quick. Um You have, you are here. Um You've, you've run your Pulumi up and you have your created uh files. Um So we're gonna move on to lab three, which is deploy with D A. So what are we going to do here? We're going to build the Docker image using the Pulumi Doer provider and then we're going to configure a cloud run service to actually run that image. Um And we're going to do it in the same project just to keep things nice and simple. Um So we're going to provision the same application twice. Um You may need to run this command to actually make sure that do can talk to Google Cloud because we're gonna be using the Docker API locally. So we'll need to run G cloud off, do a loin. I think that's what it is configure Docker G card off, configure Docker like so, and it should tell you that you have credential helpers for GCR dot IO of G cloud. And that what that, what that does is it allows us to build our docket image and then push it to our GCR uh repository. We're gonna do this in Pulumi, but it is gonna use the Docker API. So make sure you've kind of run that little command there. OK? So what we're gonna do is we're gonna start like at the end of our Pulumi project, let me get rid of this. Um And we're gonna create a docket image and because we're using typescript, we can do a lot of variable, we can use it, we can, we can declare a variable. So let's do constant image name equals my first GCP app like so and then we're gonna create an image variable very similar to what we did with our other resources for our static website. Uh But instead of using the GCP provider, we're gonna do new Doer dot image example. And again, we're going to get some information from our ID that says we are missing some required options. So we need to specify an image name and then we also need to specify some build information. So let's go ahead and do that image name. We're gonna need to use Pulumi interpolate here because we're gonna push this docket image to our Google cloud project and um you'll need to make sure that you um have this Google Cloud project configured like you did before. Um So let's do Pulumi dot interpolate GCR dot IO forward slash GCP dot config dot project. So we're actually grabbing, if you remember earlier, we did a Google, we actually configured the name of the project that we're going to use each project within Google Cloud has a GCR image repository set up already. So we can just grab this value directly from our configuration. Um And actually, um you know, not have to hard code anything at all. Um Which I think is super nice because that what that means is that when we, if we were to create a new stack, we can just rerun this over and over again. Um And then I'm also going to specify the image name like so uh and then we need to specify a tag. I'm just gonna call it latest for now. Um Just to kind of keep it simple. You might consider calling this version 1.0 0.0 but I'm just gonna call it latest, we're still getting errors from our ID because we have not specified anything to build. So we specified the name of our docket image, but we haven't actually specified an image name, sorry, a build anything to build when we build this docker image. So let's specify it. Let's specify build like so and then we need to say that the context ie the docket image that we want to build is in the WWW root folder, which is one level above. So we're going to do upper level www root like so, so this is actually gonna look when we run our Pulumi program, it's gonna look in this directory for a Docker file and if it finds one, it's going to build it. Um And hopefully it will find it because it's still, it's definitely there. Um So we're going to um specify that like so um and then hopefully um in a second when we run our plume up, it will go and build that image and it will push it to um it will automatically push it to our GCIGCR repository like so OK, now that we've specified an image that we want to run and it's been pushed to GCR. The next thing that we want to do is actually tell Google's cloud run to run this image. So using the same familiar pattern that we've already used, let's do let's create a value, call container, a variable, call container and then we can go back to our GCP um provider. So GCP dot cloud run dot service. So, and we'll call this web app for now and then we need to specify a bunch of different options here. So we're going to specify a name for the container and we're going to give it a hard coded name in this particular situation rather than let auto name take care of it. Google's cloud run likes to have specific names. So we're just going to specify, we're going hard code the name of web app and then we need to specify a location and I'm gonna run mine in us central one and then when you specify a template, so the template is a things like what the image name is going to be some specification. So let's populate this, let's get it all populated. So template spec and inside the spec, we have an array of containers that we want to run. By the way, if you don't want to type all this out, it is in the lab here. So you can just copy and paste this. If you want, I'm gonna type it out because I want everybody to make sure that they see the process. But if you don't want to type this out, then please feel free to copy and paste it. So what do we need to specify in containers? We need to specify an image. And of course, using our dependency graph, we can actually specify the image dot image name. So again, this is going to create dependency between a dependency graph between our Google cloud service and our image because we're doing an output from image into our cloud run um you know, into our cloud run uh service. Uh We also need to specify some ports like so uh so we're gonna say container port and we know it's engine X. So we know it's going to run on par 80 because it's a web server. So let's specify the container part of 80 and then what we need to specify some request limits and I don't want anybody to get charged any money here. So we're gonna make these really small resource limits. So let's make it requests is a tiny amount of memory. So 64 megabit megabits, CPU 200 M and then limits. Uh let's do upper bound limits of 256 AM I and then CPU 1000 M. So that's just probably just about one call. Um So that's fleshed out our Google cloud resource. Um There's one last thing that we need to specify in our specification here. We just need to say how many concurrent requests we want to serve. I think I looked this up before 80 is the upper limit for concurrent requests for the free tier. Um So I'm gonna specify that as 80. So I'll take a pause there because there's a lot to type out. Um If there are anybody, if everybody's having any problems just jump into the chat. Um, oh, I just noticed Paul that you're having the same. Er, it looks like it does look like there's some corporate policy there. Um, again, it's a totally understandable corporate policy. Um, but it looks like that might, might be what you're running into. What I would recommend is just kind of yank all of this stuff. Um, all of the bucket stuff. Hopefully the Google cloud stuff will sorry, the cloud run stuff will will go a little bit smoother. Ok. Close that out. Ok. Final thing. We need to allow unrestricted access from the public to actually look at our Google cloud container. So our cloud container, so we're going to use an I AM member resource for this. So let's do constant I am equals new GCP dot cloud run dot I am member website and this has a bunch of dependencies. So let's have a look at what our ID is telling us. We have some I member maps, we need a member, a role and a service. So let's specify our service container dot name again, creating these dependencies between these resources. We know that our location is us central one because we already specified it. And we also want to specify a role. So we're gonna do run dot Invoca. I'm not going to pretend to understand Google's naming policy for these roles. Um This is just the one that I managed to get it working using and then we want all users like so Paul, you may run into another problem here because this is very, very permissive. Um and it may be that your your Google Card policy does not allow this, do apologize for that. Um You know, I do understand not everybody has the benefits of a sandbox account at their disposal where they can kind of do a bunch of testing. Um Hopefully you're getting some value out of this even if you are getting errors uh that are kind of enforced by your policy. OK. So what we've done is we're building a Docker image, we're running it in cloud run and then we're going to specify that anybody who visits that cloud run. URL can actually view the URL. The final thing that we need to do is we need to export the actual URL that we're gonna use. Um these URL. Um these constants are unique. So we're going to give this another name. We're going to do export con container, UR equals container dot statuses and statuses is an array. So we're gonna use the first element in the array and then we're going to specify the URL. So this will again, it will export our URL for our cloud room container and allow us to actually visit it and actually look at our running application, OK? I'm just going to hit save, make sure everything is saved and then let's run Pulumi up again. Let's see what we get here. Create, it's building our image so you can see in the background. It's built a Docker image. Yours may take a little bit longer than mine because I already built this docket image earlier when I was practicing. Um So it's just gonna build your Docker image. Let's look a little, you'll see that our container output our container URL is not known yet because that's gonna get returned from the Google Cloud api. So it's gonna tell you that it will eventually have a container URL, but we don't know what it is yet. So it's still not populated. I want to draw your attention to another thing as well. We've updated our existing Pulumi program and we already have a static website in here. We already have a bunch of resources in here. It's only creating the resources that have been added since I've updated my Pulumi program. So it's only gonna do the things that it needs to do. We're using an imperative language, but we're still getting a decorative result. This is the power of the Pulumi engine. This is the power of the Pulumi resource graph. Um So you can write this imperative code and Pulumi will magically turn it into a decorative. Um It's incredibly power um and it will allow you to be really, really iterative. So we can, you can build out your Pulumi projects over time and do things over time. And then when you run it in its final form, it will create everything. So let's perform this update. Let's let's run it. Let's see what happens. Building image, pushing to GCR dot IO forward slash L bricks, pushing those limit image layers. And you'll notice of course, because we've created the dependency between the cloud run service and the actual I AM member that it didn't start creating the cloud run service until the image was created. Um So the dependencies are actually building between them and you can see my image push succeeded. Um My cloud run service has been created and then my I AM member has been created and we have got our cloud run URL has been returned. I'm gonna grab this URL. I'm gonna be fancy instead of copying it and I'm gonna do PB copy and then I'm gonna head to my web browser and the moment of truth. Look at that we have a, we have a valid date, we have a valid server name and we have a valid server address even though it is a linked local address. And you can also notice the request IP is working correctly. How does the dependency work with build of the docket image and running it with cloud run? OK. That's a great question, Anish. Um So what's happened right? Is we have specified an image name of GCR dot IO like a remote. We, we we've specified a name of a remote image repository. So the way the dependency works is that this docket image um this Docker image resource is going to build an image locally and then push it to a remote image registry and the output the actual image this image name here that we have created doesn't get returned from the Docker API until all of those processes are finished, right? So if you think about the steps that are being taken here, it's going, it's going to do Docker build dock a push. And then when that push finishes that push will return an image name with the actual remote URL. And that's how the dependency gets created because it doesn't actually return this image name until this has been finished creating. And that is, that's how those dependencies get created. Hopefully, that gives you an idea. It's mainly like if we hadn't specified a remote image repository here, if we hadn't specified that the dependencies would not work, um Or at least it wouldn't like the actual um the actual build one work because it would still wait for that image to be pushed. Um But then the actual cloud run service would still wait until that image has been pushed. But if we push it to a different URL as an example, it would probably fail to start. Um So hopefully that gives you an idea. Can we reference location in from cloud room block in the ion block? Let's find out, shall we um location. I don't actually know the answers. I find out container dot uh Oh no, it's image. No, it's not. It is I am member block. So what we're gonna do is we're gonna specify the location is container. So the the the actual answer is if there is an output, look at that. Yes, we can. Let's try that. Shall we? That's a great question. Thank you very much Anish. Um So let's specify the location here instead of hard coding it. OK? Now I'm learning things today. Um And then we're gonna rerun our Pulumi up. We should see no changes here because the location is still the same, but we've just specified it as an output. So we're getting this warning error because my docker environment is not configured properly, but you'll notice there's no changes here. So the answer to your question is absolutely yes. I'm actually going to update this workshop to make this, use this output here because this is a much better way of doing things. So, thank you very much for the great question. And um and, and the fact that you asked that question is giving me hope that the understanding of how this works um is kind of coming across. Um So, um yeah, that was a really, really awesome question. So, what we're gonna do now, the final thing that we're gonna do is I'm going to destroy all this stuff. So I'm gonna run Pulumi destroy and you can see he's gonna tear all this stuff down. I think so. So we're gonna delete the IM member, delete the bucket object just to make sure these things don't stay running. Um You don't have to do this, but I just want to show you an example of what happens. We've destroyed all our, our infrastructure. I'm gonna run Pulumi up. Yes, because we've destroyed our infrastructure. It's gonna recreate everything but notice it's going to build the docket image and the bucket, all those things like it's going to create these things in, in, in parallel because the there's no dependency between these storage objects and these image objects. They're two different dependency graphs. So this speeds up our image, our push, it doesn't do things in a in a in the or it doesn't do things in the order in our program. It does things um in an order that needs to do things. So there's no dependency between these things. It will just go ahead and, and create them. So we should get two new um two new URL S here any minute. Now, once this cloud room service is finished creating it's taking longer than I expected. Well, I, I guess something has happened with my cloud room service at this point. I don't know what's going on there. Oh, no, there it is just took a little bit longer than I expected. The joy of cloud providers. You see, you just never know what thing what's going to happen. Um So you can see we should have two new URL S now. Um we got a new website bucket. Um So the different, there's a different URL but that's, that shows you the repeatability of um you know, the repeatability of this infrastructures code mechanism. We've just recreated all of our infrastructure with a single Pulumi up. Um and we can do this over and over and over again. Um Which is what you really want from your infrastructures code, right? You wanna be able to repeat things and do them over and over again. So that's uh just over an hour. Um That's all we have time for today. Um If you did enjoy this workshop, we have other workshops coming up. Um We're gonna get the schedule uh taken care of pretty soon. I'm gonna stop sharing my screen. I hope you got uh some, you know, I hope this was in uh an informative um you know, an informative informative workshop. Um I usually send out a poll here and I was a little bit um a little bit um unorganized this morning, didn't get a chance to uh to put the poll together. Uh But if you did enjoy this workshop, please let us know uh we have the Pulumi Community Slack um at slack dot Pulumi dot com. Please feel free to draw, uh you know, please feel free to join us uh Slack dot Pulumi dot com. Um if you are new to Pulumi, uh I am at Briel on Twitter or you can tweet our public uh Pulumi cop um handle. Uh If you need any help with the kind of getting started with Pulumi, then please let us know. Uh but we'll call it a day there. Hopefully, everybody had a had a great time and learned a lot about infrastructures code with typescript. Uh We do have other workshops coming up and we have lots and lots of content on our website for different languages. So if you would prefer to use Python or go or dot net instead of typescript, all those things are available as well. Thanks very much, everybody. It was really great chatting with you all today. I hope you have a great rest of your day and a great rest of your week.
---
