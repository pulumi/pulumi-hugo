---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Rewriting Requests with Lambda at the Edge | Modern Infrastructure Wednesday 2020-06-24"
title: "Rewriting Requests with Lambda at the Edge | Modern..."
meta_desc: |
    In today's episode, we are exploring how to use AWS Lambda@Edge with Amazon Cloudfront to rewrite requests to the origin. Code for this episode ava...
url_slug: rewriting-requests-lambda-the-edge-modern-infrastructure-wednesday-20200624
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Rewriting Requests with Lambda at the Edge | Modern Infrastructure Wednesday 2020-06-24"
  description: |
    In today's episode, we are exploring how to use AWS Lambda@Edge with Amazon Cloudfront to rewrite requests to the origin. Code for this episode available here:  https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-06-24  The examples are in TypeScript but Pulumi makes it easy to stand up infrastructure in your favorite languages including Python, Go, and .NET - saving time over legacy tools like CloudFormation and Hashicorp Terraform.   GET STARTED https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-06-24T06:00:34Z
  youtube_url: https://www.youtube.com/embed/ZWegAYQ0uwo
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lie Zen. Today we're gonna be exploring rewriting requests with LAMBDA at the edge. So if we look at what we're gonna cover today, we're gonna cover Lambda function versions and then gonna look at rewriting requests with LAMBDA at the edge in case you didn't know you can actually use Lambda at the edge meeting with cloudfront uh in AWS and then use that to rewrite requests, rewrite responses and actually do a bunch of stuff kind of intercepting those requests either from the user to uh cloudfront and changing how that works from the request perspective or even rewriting the request to the uh the origin. And then actually kind of doing the same thing on the way back. You can rewrite the or response or even rewrite the response uh to the viewer uh before uh uh serving that, that content. So, uh if you want to follow along uh visit gib dot com slash Pulumi Pulumi TV, uh all our examples from Pulumi TV, are there, let's get started. We're actually gonna investigate and look at a uh a real life uh example here. This is actually the get dot Pulumi dot com uh code. So, if you actually go to the uh uh rep repository for this, it's, you know, github dot com slash Pulumi slash gets dot Pulumi dot com. This is actually the uh distribution that serves uh all of uh Pulumi uh plugins. And we actually recently had an issue a few weeks ago where we discovered that uh because of the way we were writing certain um file names uh into uh S3 kind of. Uh and, and the way we were, we were treating it, uh we actually had a mistake where uh pluses uh needed to be rewritten as uh the, the HDUR encoded percent two B uh so that S3 would interpret them correctly. Uh And so, you know, we wanted to make sure that existing users weren't affected by this change. And so we, we decided, OK, let's just rewrite the request so that we get the right thing back. Uh Because the cli is trying to make a certain type of request uh with, with the plus sign as it is. And S3 is, is expecting that plus sign to be uh a plus and not necessarily a plus in the space sense uh from an html per uh from a perspective. So, what I'm gonna do today is actually just walk through the request, rewrite that we ended up writing uh and then talk about how it works. Um And uh and Yeah. So, but if you look at index dot ts, uh this is the, the main part of the code that kind of sets up the cloud for distributions and everything else uh within uh get dot plume dot com. The thing we really care about is actually all we did was we added one additional uh set of uh parameters here. We added a lambda function association and we associated that uh uh uh event uh with the origin request. So basically, uh this is gonna say um every time there's an origin request. So in this case, we're going to S3 to grab uh the plug-in uh invoke this LAMBDA uh this request, we write LAMBDA and this is an A RN. And so we can, we'll see from here that uh we actually um we actually, you know, export this uh A RM with a version. So in the uh in the, in the intro, I talked about how we talk about LAMBDA versions in case you're not aware uh when you create a Lambda function uh by default, it has a, a version latest. Um And if you set, publish the true, then every time you uh create a new la, every time you update that Lambda function it's version. And so it'll have a new version number. And so the idea here is that we are referring to a specific version number uh for that request. So what are we really doing here? Uh First we create a rule uh to invoke the LAMBDA function we have. And notice the role is different from a typical Lambda role. It has a Lambda principle which you would expect. Uh And this is this is to allow LAMBDA to assume the role in in case we want to execute the function. But we also have this edge LAMBDA principle. So that, that uh can also assume the role to execute the function. So there's, there's an additional uh assume role statement here. And then uh so is before that role uh has the land the basic execution role. So basically this, this uh is the managed policy from AWS that lets us uh create cloud uh cloud watch logs and also uh actually execute the, the function. Uh We also create a provider here for us East one. And this is because uh LAMBDA at the edge functions had to live in us East one, that's where uh cloud fronts control plane also lives. And then we simply define a callback function here. So uh I mentioned how publish works earlier. Uh We set a time out of five seconds. This shouldn't take more than you could probably even said this to, to to one. And we, we give it the role. Um And in this callback function, we uh using, you know, the magic of the way Pulumi allows us to in line code, we define this AYC function that takes this LAMBDA context. And and the event. And if you go online, you can search for the cloud front uh request uh event reference and that gives us a set of, you know, all the different uh event types and what they look like. And so, in this specific case, uh if we, you know, as with most lambda events, there's a set of records and uh inside that record, uh that first record, there's a specific field for the cloudfront request. And uh we, we can take that request ur I, we just log that and the request ur I uh if it includes a plus sign, which is what we want to rewrite because we don't expect plus signs. Uh Normally in our URIS uh for uh get document dot com, except in the case where, for example, uh we have a plus, you know, whatever flags uh for the plug-in. Uh we actually want to rewrite those as percent two B. So we actually just basically look for the plus uh and we replace it with a percent two B and then that's it. We return the request after it is modified and then cloudfront will then go on and request uh the correct URL from S3 0 at least the one with the one that we want with the actual uh percent two B. And so that's actually all that this does. Uh And actually, we can, we can show you kind of a quick example actually of um how this works. I actually ran Pulumi preview earlier. You can see there's no, there's no diffs, there's really nothing super interesting to look at here. Uh Probably more interesting to look at is um uh if I could find a request, let's let's try this command. And uh if we'd run this, we'll see. Actually II, I had stick this file there earlier where I just, I just wrote some blank bytes to it, uh some a, a bits to this file. But you can see that this plus sign is being rewritten as a percent uh two B and uh as a result, we're getting the correct file from S3. And without this function, uh you, you have to kind of believe me since I already deployed this. But without this function, it would have failed the request as it would have tried to, uh S3 would have tried to interpret that plus as a space. Um It would not have actually retrieved the correct object. So that's it. Uh That's actually all I wanted to go over today. Hopefully, this is super helpful for those of you who are using cloud front and want to be able to rewrite requests to your origin. You can actually also do the, the reverse, you could actually rewrite the response. Uh And so there's lots of ways you can do that and lots of interesting things you can do uh for response rewriting actually, in, in fact, uh uh I built a uh CD N based uh authorization scheme to make sure all requests are first to first have a correct token before passing it on to the origin. So you can do all sorts of fun stuff with uh Lambs at the edge. Hope you enjoyed today's episode, please like the video and also subscribe to the channel for updates and uh make sure you click that little uh notification button to get notified of new episodes and we'll see you next week on Pulumi TV.
---
