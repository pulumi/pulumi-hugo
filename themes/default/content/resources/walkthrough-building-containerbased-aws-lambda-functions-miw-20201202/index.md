---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Walkthrough of building container-based AWS Lambda Functions | MIW 2020-12-02"
title: "Walkthrough of building container-based AWS Lambda..."
meta_desc: |
    In this week's episode of Modern Infrastructure Wednesday, we go in-depth on the container-based AWS Lambda functions demo: https://www.youtube.com...
url_slug: walkthrough-building-containerbased-aws-lambda-functions-miw-20201202
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Walkthrough of building container-based AWS Lambda Functions | MIW 2020-12-02"
  description: |
    In this week's episode of Modern Infrastructure Wednesday, we go in-depth on the container-based AWS Lambda functions demo: https://www.youtube.com/watch?v=gB9T1aW3gSk  We walk through each line of code, showing how it works as well as what's in the `Dockerfile` to build the image.  Code for this episode available here:  https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-12-02  Today's example is in TypeScript, but Pulumi makes it easy to stand up infrastructure in your favorite languages including JavaScript, Python, C#, and Go - saving time over legacy tools like CloudFormation and Hashicorp Terraform.  https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-12-02T05:49:20Z
  youtube_url: https://www.youtube.com/embed/4RC37yZJakM
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. Today, we're gonna be going over the demo that I built for showing how to use container based uh lambda functions. And so we're gonna walk through that code in depth since in the video, it was a kind of a quick take on just how to build an application and kind of show the demo of the application but never, never really walk through it uh in depth. And so we're gonna do that in this video today. If we kind of start at the beginning, we import a couple of libraries. Uh We're building a typescript application today. Uh Pulumi obviously does support uh go dot net as well as Python in addition to no Js. So, but here we're using typescript. Uh So I I create this bucket um you know, simply just call, you know, a new bucket. Uh Here we just name it bucket. But uh obviously, that's just the, the name we're using within Pulumi uh with Pulumi auto naming capabilities. Uh These actually end up being transformed into, into suffixed uh names in the actual uh cloud provider. In this case, aws uh this next line here, we're, we're, we're using this convenience library, Aws X. This is a crosswalk for Aws. It's a convenience library from Pulumi. And then here we just build and push image and it builds a uh the image and pushes it into a repository within ECR. And so actually, if we go to uh our console, the Pulumi console, we can actually see those resources uh here in our stack. And if I open this up, uh we can actually see the, the name of the bucket uh is, you know, is suffix like this. And then the same thing with I, if I go look at the sample app repository, we can actually see uh this particular repository um in ECR and we can also uh oops what's going on here. Uh here, sorry II I had updated something without uh publishing it. But here we can see that the repository names um as well as the images that is what I meant to do uh as well as the images that have been pushed um into that repository. So that's kind of how that works. Um And so again, you know, this is all auto named as part of the plume. And so uh yes, so we, we have the bucket, we have the image uh in order to execute a lambda function, obviously, that lambda function needs to have uh im role and permissions. And so we create that role here, thumbnail role and we attach a policy called uh uh and the Aws Land, the full access policy. So actually, here we're using a managed policy yarn that A LE S provides. Uh You'll note that this is actually a um an OM. Uh And so, so that's how this is how we uh actually bring this in here. So that's kind of, or a, as an rather, it's a, it's a set of constants. Uh So that's how we bring that into there. And so um once we have those, we just create the function, that's what this line is here on line 20. And so the function takes that image uh Ur I. So we have that image UR I from above. Um And this is an output of this particular image and then we also give it the role that we created. So those things combined allow us to create the function that actually executes. And I'm going to go into how that function works in a second. Um After that, the rest of the code is actually fairly simple as well. We, we create a not we create a uh on object created. This is again a convenience in the uh Pulumi library where we hook up the S3 uh bucket notifications to our function. And so uh every time there's a new object created in that bucket in this particular bucket, we will uh the name of the handler is on new video. This could be any name And then uh we give it the, the function that we want to execute uh whenever a new bucket, uh whenever a new bucket object is created. And then we specifically filter for uh this uh MP four suffix. And then finally, just to kind of, you know, for the sake of the demo, I also uh throw in a, an additional um uh a function that, that we create here. So again, uh we can create another ono created uh notification so that you can see it's actually the same thing. But here, we can give it a new handler name. And in this case, instead of giving it an existing function, I create a new function in line actually. And my in line function uh is simply just a typescript code I create here. And, and you can see the in line function is fairly simple. All it's doing is uh providing some additional information about um what's actually being processed. And again, we give it the a policy. So that's, that's pretty much it um here and you can see this is this is looking for that, that thumbnail that gets written uh once it gets written. And so no, no, you know, nothing, nothing too crazy here. So instead of a role, I just give it a uh a policy um uh because this, this actually creates a role on its own um as well. So that's kind of how all that works. And so really the, the only code left to look at is how do we build that container image? And what is the code uh running within that container image? So if we, if we go over here, we can look at our Docker file and you can see up here, I'm, I'm, I'm pulling uh the I, I'm basing this image off of the uh image that A US has published. Uh This is actually uh using their new uh public uh uh their new public ECR. And so we're grabbing that image from there and then we're just adding a few things that weren't present in the image already. So we're including a few uh utilities, we need those to, to install a couple of other things. So we need unzip to install the A WB cli where we just grab this uh CLI and then we unzip it and install it. And then we similarly need Tar Z to install FFM peg. So we also uh grab that file, uh unpack it and then move that, move that binary into uh somewhere on the path. And then once all that's done, um you know, finally we just copy this handler uh and then set the uh set the entry point to be this uh this handler. And so if we look at this handler, uh it's fairly simple. Um This is exactly the same code you would write in a lambda function. And so uh here, all we're doing is uh we have this, you know, simple run wrapper that, that doesn't exact. And so that's simply shelling out to uh take the file that came in and copy it to the, to the local disc. We run FFM peg against it with the correct FFM peg parameters to, to grab the thumbnail uh that outputs to the thumbnail. And then we finally copy that thumbnail, we create uh back into S3. And so that's how all this is wired together, uh fairly simple and straightforward. And so that really, that's how, that's how the entire example works. And, and like I said, in the, in the short video, you know, it really is just a few dozen lines of code to wire everything together. Pulumi makes it super simple and easy to get started doing this. Uh So yeah, I hope you enjoyed this video. Uh Be really curious to see what you do with, with the the lambda functions using container based uh functions. And I hope to see you next week on moderate infrastructure Wednesday. If you like this video, please leave a comment below. We'd love to hear what other content you would like to see as well as uh please make sure you hit that like and subscribe button. So we know uh you're enjoying the content here. Thanks.

---
