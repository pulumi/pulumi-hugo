---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Supporting Kubernetes with Faster, Easier Test Environments"
title: "Supporting Kubernetes with Faster, Easier Test..."
meta_desc: |
    Scott Lowe demonstrates how he uses Pulumi to quickly stand up test environments for the Cluster API project.
url_slug: supporting-kubernetes-faster-easier-test-environments
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Supporting Kubernetes with Faster, Easier Test Environments"
  description: |
    Scott Lowe demonstrates how he uses Pulumi to quickly stand up test environments for the Cluster API project.  To get started, go to https://pulumi.com/start
  sortable_date: 2020-04-30T17:37:04Z
  youtube_url: https://www.youtube.com/embed/EWILzQ7_jMI
transcript: |
    OK. So what I'll show you is um what I have is um I maintain uh my, it's my, my testing environment or my testing framework. I guess, I guess you could call it a sandbox if you want. But what I have is uh a pluming configuration written in typescript that uh manages a consistent configuration across four WS four aws regions worldwide. So I have a AAA single program or a single stack. Um Well, I have a single project which is the infrastructure, um four stacks, one stack for each region and the code is parameterized so that as I change, all I have to do is change the stack and then it'll spin up in that region, looking up resources for that region like the right AMI S and so on so forth in that region. And then building on top of that, I have um another stack which references the first one which then will spin up instant uh some limited number of instances to then enable me to do the things that I need to do. Most of my focus is around cnet's. Um And in particular, working on a project called cluster API which allows you to um define kubernetes clusters as a kubernetes resource. And then you're using the Kubernetes API S to in turn manage kubernetes clusters, which sounds a little of an inception. But anyway, um so uh what I have here is looking at um my get repo in the uh in this um directory here. This is the Pulumi project. Um again written in typescript. You can see that I have four different stacks for each of the four regions that I'm using, right? Um And then uh the one code file. Um And so I just, um and so the actual typescript code um is in here. Um And so it's just written to, you know, basically, you know, like I said, I have maps set up to provide different values for different regions. Um different IP address values in different regions, et cetera, et cetera. Um looking up AMI S per region, so on so forth. Um And then spinning up a VPC, spinning up subnets, both private and public subnets, attaching internet gateways um creating security groups for various hosts. Um And um and then creating one instance which is uh an SSH bashing host, which it's only traffic allowed as SSH into the, into that host. And then that serves as the gateway by which we, we reach everything else inside there. And so what that looks like in a particular region is um it would spin up um all the necessary infrastructure and then create this one machine here. Um And then that one machine becomes the gateway by which I access everything else that's inside that area and then the other. So this is one sta one project with four stacks. And then um on top of that um no sorry reg victory. Then I have this project again with the same um four stacks. Uh And its purpose is to just spin up some um instances which I use is what are called uh management clusters. And so it will go and create instances inside the uh inside the infrastructure that was created by the previous stack. And so we're just using a stack reference for that here to reference the stack. Um And then it will go up and spin up the additional instances. And so that's where you would get these machines here in each region. And then after that, I I use some non Pulumi stuff. Uh you know, kubernetes native tools to bootstrap the initial kubernetes cluster that I use for that region and then that cluster becomes what we call a management cluster. And from there, I can create additional kubernetes clusters as needed. And uh one of the other ways that I use Pulumi on top of this is um I sometimes have a need to um spin up additional test environments um for various testing and you those are are not um regionalized. So I'll usually do my testing in a specific region. And so I don't end up creating multiple stacks. But in this case, for example, I've got a sort of a combined um set of code um in this typescript file that um doesn't use the other previous stacks, but instead spins up an entirely new test environment across some region um that I'll specify and then it will go and create uh an independent VPC, independent subnets, independent internet gateways, net, gateways, route tables, route table, associations, security groups, et cetera, et cetera, that I'll then consume for other testing purposes. Besides the persist the sort of some more persistent um infrastructure that I maintain um that I showed you already. Um So it's not a, it's not a complex environment, right? Um In that it's, you know, it's pretty, pretty simplistic. I I create the base uh AWS infrastructure and uh and then use stack references, plume stack references from there to build on top of that infrastructure to add additional instances or whatever, right. Um That let me then spin up instances in the inside those environments as needed and then tear them down while I can still leave the the underlying infrastructure in place. And one of the things this is this has enabled me to do is um as uh the, the project that I'm working on which I mentioned earlier was cluster API as this has um sort of developed very, very rapidly within the Cober community, I can tear down test environments and uh tear down this underlying framework in a particular region. If I need to upgrade it to test a new build or um if I need to upgrade it to, uh you know, to change some piece of it, whatever, like as the community was using, was moving from V one alpha two to V one alpha three, uh which is their internal sort of version nomenclature. Um There were some changes in there that, you know, you didn't necessarily want to upgrade in place from one to the other and instead you wanted to sort of build a new and then migrate over, right? And so using my uh using this um Pulumi configuration, I was able to do that sort of worldwide in all my test regions in just a matter of like 10 to 15 minutes, right? Literally just the time it takes to run a Pulumi destroy. Um and then the plume um ple me up um to tear down the existing infrastructure and then recreate it from scratch.

---
