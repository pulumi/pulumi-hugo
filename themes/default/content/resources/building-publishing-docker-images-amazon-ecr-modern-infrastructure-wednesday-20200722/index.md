---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Building and Publishing Docker Images to Amazon ECR | Modern Infrastructure Wednesday 2020-07-22"
title: "Building and Publishing Docker Images to Amazon ECR |..."
meta_desc: |
    In today's episode, we build and publish a Docker image to Amazon Elastic Container Registry (ECR). In just a few lines of code, we're able to buil...
url_slug: building-publishing-docker-images-amazon-ecr-modern-infrastructure-wednesday-20200722
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Building and Publishing Docker Images to Amazon ECR | Modern Infrastructure Wednesday 2020-07-22"
  description: |
    In today's episode, we build and publish a Docker image to Amazon Elastic Container Registry (ECR). In just a few lines of code, we're able to build an image and push it to AWS. Code for this episode available here:  https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-07-22  Today's example is in Python, but Pulumi makes it easy to stand up infrastructure in your favorite languages including TypeScript, JavaScript, C#, and Go - saving time over legacy tools like CloudFormation and Hashicorp Terraform.  https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-07-22T05:56:41Z
  youtube_url: https://www.youtube.com/embed/zLxUImoakeM
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lie Zen. Today we're going to be talking about building and publishing Docker images to Amazon Elastic Container registry. Fairly common use case for working with containers communities uh on AWS. You know, you want to publish your images somewhere private repot, you have some applications you're building and then you're gonna use those images within AWS. So uh really easy to accomplish in Pulumi really just able to do it in a few statements of code. We're going to be using Python today uh to accomplish this. And so we're gonna do these three simple things. We're gonna create an ECR repository, gonna build a Docker image uh out of a Docker file that we have on disk and we're gonna push that image uh to ECR. Uh And so before we get started, please make sure you subscribe to Pulumi TV. Click that subscribe button below and love to hear your feedback. Please leave comments like the video. Uh I just want to hear what you're thinking. So, yeah, let's get started. So what I have a empty Pulumi program here, I ran Pulumi New uh Aws Python. So if you run Pulumi New Aws, uh Python, you know, you're gonna create this empty shell program. I deleted what was in the template main, um Just empty that out. And then I also created a my app with a Docker file. Very simple, just from engine X. That's all there is in here. Um And so now we're going to, uh go through the steps of what I talked about. So first let's create the, the registry um and start there. So, uh we're going to uh from Bloomy A a of the US, we're going to import ECR and uh we're going to create the repo so uh create compositor and we can do uh repository and we'll just call it. Uh Actually let's, you know, we should name the repository after uh the application. So let's just create it constant here. Um Let's do this for now. And so this can just be called uh A OK. And um so this repository is gonna hold the images for our app and let's make sure this runs. Let's see how this goes. All right. So yes, let's create that repository. All right. Great. So that worked. And so now let's go ahead and create the image. So that's actually fairly simple too. Uh We're going to create the image and uh yeah, let's, let's, let's see how this goes. So we want the image. Oh Of course, of course, we need Docker. So we're going to uh import uh plume Docker as Docker. So we bring in the Docker provider and so the image is uh image and here we're just gonna give it a name. Uh again, we're just gonna call it uh the app's name and then we're going to need to give it an image name. So let's do that. And the image name needs to conform to the repositories expectation of what the image name should be. And so typically, that's going to be like for ECR, it's gonna be uh repository URL and then colon um you know, some tag, right? That's, that's pretty standard. Uh And so that's very easy to do in plumbing. We can basically do um uh let's import Pulumi as well. So we can get some helper methods and we're gonna concatenate some output together. So we're gonna concatenate as I mentioned, the, the URL uh plus colon actually. So this example works out perfectly for us and then the tag. Um So uh it's the rebo uh repository URL uh colon and then the uh tag we're gonna put latest on there. Um Right, I call it like B one, I don't know this matter, right? So, put this tag there. Um We can, you can use anything, I'm sure obviously you would probably programmatically do something here. But for now, this is just an example. Uh And then um we wanna push this uh sorry, we had to give it a build let's do that first. Um And so you can see one of the primer mistakes is a Docker build. So let's give it that. And this, you can see takes a context and the context is as the docs mentioned, a path to directory. So usually the directory, once the doctor build resides, that's very easy. Uh This is just uh actually, we can just do this. Um So we have this handy the and director here. It just happens to be named this. And then finally, we're going to uh wanna push this to the registry. So let's stick the registry here. And so now the question is like, what do we stick here in this argument? So we wanna stick this image registry thing. Um And this takes a server, user name and password, but we don't have those uh those come from uh this repository and actually, we need to call get credentials to do that. So let's like I'm, this is a place over for now. We're gonna see how we're gonna fill this in in a second. Um So let's get the credentials and uh create and image registry from that. Um So that's what we need to do, right? So we need to get the credentials and create images registry which takes those uh parameters uh from the credentials to, to do this. So let's take a look at the documentation real quick. So we were using repository earlier. Um Yeah, not a whole lot of config here. And then now we're gonna use, get credentials and git credentials, takes the registry id and it gives us back a couple of useful things. One is the proxy end point and that's actually what we're going to fill in for the server uh, argument here. That's the URL we're gonna publish to and then it takes a user name and password and that's gonna come from the, uh authorization token and the a authorization token is going to be a base 64 encoded value that we can decode. Uh And it's gonna be a user name, password uh pair. So let's do that. Uh So creds uh and this is going to be get credentials and uh the registry ID, that's easy. That's just uh we put that ID. But actually here you can see this is an output and this is expecting a prompt value uh and not an app but just wants a string. So the way to actually do this is do this within an apply. So just like we had uh here we use Conca we're gonna use apply here. Yes. And so, um this is the repo ID now and uh we can call ID here. Um It's called, actually it's called this Repo ID. Um One thing we should do though is now, you know, this Lambda can get pretty complicated because, you know, we're gonna get the credentials, we're gonna use those credentials in a bunch of ways, let's, let's just make this a callback. And in fact, like if we make this call back, we can just make this a callback that creates the image registry for us from the credentials. So we're going to call this call back. Uh Something useful like um uh create image registry from credentials. OK. Um All right. Sorry. Let's, let's call it get credentials. Uh And uh well, I don't know. OK, let's just call it create image and it's gonna, it's gonna, it's gonna create image from the repo ID that's actually like descriptive enough, I guess. Um And uh so let's define this. Uh So this is gonna take the rebo ID and so now we're gonna call it the get credentials and this takes the rid and uh if we look back here, um Now we can actually know how to fill in that, that image registry so we can return uh doctor image registry and this is gonna take the server, which is just the creds proxy end point and then it's gonna take a user name and password. So we're just gonna fill that in for now. Um And so the user name and password are pretty easy to get, oh, shoot, I hit this button by accident. So what, what we're gonna do, we're going to uh decode, like I said, using base 64. So we need to import base 64 and we're gonna to decode the value. So we're gonna say um uh uh a token, right? Yeah, off token. Well, it's called decoded. Uh is the creds authorization token. Uh And so we're going to do base 64 decode. Oops. So we're gonna to decode this. So this takes those bites, decodes them. So it takes these bites, uh decodes it. And then we're going to uh interpret that as UTF eight. And then finally we need to split this so user name and password uh using the colon. OK. So assuming I got everything right, which I may not have. Um Now this is no credit. This is actually just the uh registry, right? Because this is this, we're taking the repository id that we created. We're getting the image registry using that repository id. So this, we're getting this registry output uh here which is based on creating an image registry off of those credentials that we're gonna retrieve uh from ECR. And so here we can now fill this in with uh registry and that's it. So let's run this code and see what happens. Uh If I got everything right? Which I probably did, but there's a small chance I did. Uh then this should just work and we will end up. Oh yeah. OK. So I mess something up. Um Let's say it will just work and then we'll end up creating a um registry with an image that we pushed to it. So let's see. What did I mess up? Um what does this say? It says registration he has failed to set as a constraint. So at this, this looks right. Um I call the red. Yes. Uh the get credentials is giving me an error. Uh So I must not have given it the correct ID here. Um ah Yes, this is not the repo ID. It's the registry ID. All right. So, um yeah, I need this. Not the, not the, not the repos ID, it's the registry ID. So let's try writing this again. All right. So this didn't totally bomb out immediately. So. Oh, great. Um And I'm guessing uh what should happen now, assuming everything goes well, this time is now doctor Bill is actually running uh and building my image and then it will uh take that image that it's gonna build and then push it to the registry. So I think I got everything else right? This time, let's wait like one minute and find out assuming my machine builds this image quickly and is able to push uh the image. I think the image should only be like a few, few megs. So hopefully it shouldn't take that long to do the actual, do the actual push here. But in the interest of time, I'm going to pause and let the magic of TV take over. All right, I un paused and actually, I was a little impatient. I guess it did only take 58 seconds. So like I was literally paused for all of like 30 seconds, but it did, it did complete um take a look at this update. Uh So if you look at the resources in the stack, you can see now we have um this image and we have this depository great success. If you open the repository, I should have had the image pushed to it. And there it is with our 1.0 0.0 tag. Um And you can see uh we have everything here. So yeah, just like that. Let's summarize what we did. Um You know, really simple actually, uh we uh in just a few statements, like I promised, uh we're able to create a Docker image uh and push it to a uh elastic container registry uh repository. Uh And yeah, we did it in just 1234. Yeah, count this 15 statements of code. Uh and it's, you know, with some nice, even with some nice formatting. So in, in 25 lines, uh we got all this done in Pulumi. Hope you enjoyed this episode, please make sure you subscribe. Like I mentioned. Uh you can also follow us on Twitter at Pulumi Corp or you can hit me up directly at LM Zen and we'll see you next week on Pulumi TV. Thanks for watching.

---
