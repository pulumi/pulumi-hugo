---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Cloud Engineering Summit 2020: Testing Configuration with Open Policy Agent"
title: "Cloud Engineering Summit 2020: Testing Configuration..."
meta_desc: |
    As developers, we’re writing more and more configuration to power increasingly powerful services and applications. But how do we ensure that the co...
url_slug: cloud-engineering-summit-2020-testing-configuration-open-policy-agent
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Cloud Engineering Summit 2020: Testing Configuration with Open Policy Agent"
  description: |
    As developers, we’re writing more and more configuration to power increasingly powerful services and applications. But how do we ensure that the configuration we write meets community best practices and our internal policies?  In this talk we will:  Introduce Open Policy Agent, an open source policy engine Discuss the Rego language used to write policies for Open Policy Agent Show how Open Policy Agent based tools can be applied at different stages of development, from local testing, CI/CD and through to auditing production Touch on policy as a tool for assisting with tool portability Talk about why reuse and sharing are critical to scaling the use of policy based testing We’ll also show lots of demos of testing different configuration formats, including showing how to use Open Policy Agent to test Pulumi The audience should come away with some useful ideas and tools they can use, whatever configuration formats they are writing and whatever software they are trying to configure.
  sortable_date: 2020-11-11T00:29:07Z
  youtube_url: https://www.youtube.com/embed/SpiT-Xq1cAk
transcript: |
    Welcome to testing configuration with open policy agent. I'm Gareth Rosh Grove. I'm currently the director of product Management at Sneak, as well as uh the curator of the Devops weekly newsletter. I'm also one of the maintainers of the project which is part of open policy agent. Uh You can find me on the internet as Gareth and I thought I'd say hi before we kick the talk off and I'll mainly be talking to slides and showing some demos, but it's nice to hopefully see who's talking behind that in this talk. I'm gonna talk about policy. What is policy? Why do we care? And I'll introduce the open policy agent project too. I'm also going to talk about why is that relevant to a developer workflow? Why is that relevant in the context of cloud engineering? I'm gonna touch on the importance of sharing and then we'll round up with a few conclusions. OK. Let's get the talk started. Why policy? Well, what do we mean when we say policy? Because it's definitely in an overloaded term? Um I'm fond of dictionaries. Uh Aren't we all? Um So uh one says a set of ideas or, or a plan of what to do in particular situations that have been agreed to officially by a group of people, a business organization, government or a political party. And obviously, we're not necessarily a government or political party that we might be, we're mainly around this agreement, an official agreement. So what might be some examples in the context of I guess, software and, well, you might be saying, OK, all of our GO projects should be, have been updated to a specific version of Go. Obviously, it doesn't have to be go doesn't have to be 1 13. But you might have a policy around keeping up to date with the versions of frameworks or compilers. Maybe it's cloud infrastructure. And you're saying, well, all of our EC2 instances should have tanks showing which team owns them or maybe it's in the context of DOCA files like we're saying, OK, none of them should be using latest, they should all be using shas whatever it might be. These are all examples of policies, maybe they're informally agreed and enforced, maybe they're very official in your organization. Open policy agent is a, an attempt to really build a library to help service policy and it provides a the underlying components. I I sort of think it, I think of it as it's really the sort of open source equivalent in a mature sense to the sort of half baked policy engine we'd all make without really talking about as an engine. If we didn't have something like this, it can take uh some data, some policy and give you a response. Give you an answer. Does this, does the data you're putting in match the policy? Um It provides a declarative language called Rio that we'll show some examples of to sort of describe that policy in and it's very much optimized for, I guess modern data structures. Um It's also now a cloud native computer foundation CNCF uh first class project. And there are a number of sub projects as well under that. One of which I'll talk about a bit later and contest is uh a tool that originally started as something built on top of open policy agent. We've recently moved this under the same project banner into the CNCF and and this really provides a a more end user like command line interface while open provides a demon and does provide a command line tool. Conti is very focused on end users. It's very focused on taking any sort of form of input in and providing outputs that are useful locally and and in C I CD environments. Uh Vincent, a good friend of mine uh sort of describes open policy agent in another way. And this definitely resonates with me. It's my new favorite hammer policy is abstract is quite general. This is an advantage. This means we can apply it in lots of different places. Um Hopefully we'll show you a number of examples throughout this talk. Here's one, let's take a, the sort of ubiquitous Q configuration file. Um Again, this doesn't have to be human ease, but it will use that for this example, we can write a policy against that. Maybe we're saying that um in this case, uh containers here must not run as route. We're skipping over some details. But really what we're seeing here is uh input is the document where, where is under test spec template, spec security context. If you're familiar with qfes is that path to in this case, the runner's non root flag. And what we're saying is this should not be true. Um We also saying this applies to deployments. Um That's Rio that's the policy language we're using to in this case, deny something that matches it. Contest, just provides you a nice command line tool to running that policy against arbitrary input files. So here we can do contest test point it at deployment YAML file. And in this case, we're failing that policy and we're getting a clear indication of that we could send that file in via standard in. We could actually address multiple files. Contest is quite powerful and provides that just good user experience over the top of the policies here, the policies have been automatically uh picked up from the policy folder in there, but you could also point that anywhere else and we can output that in different ways too. So maybe you prefer a sort of table view. Um You can also output to J unit XML or tap for C I CD integration. We also have a adjacent format. If you're just doing some sort of glue integration or want to pass things out with JQ. Let's see a quick demo of that in action. We have lots of examples in the uh con repository across a lot of different sort of tools. A lot of them relevant to that sort of cloud space. Um I showed a example there. So let's show a quick doer example. Um So here I have a Docker file fairly standard, nothing uh overly clever about it. And I've got some policies. One of them is saying, OK, let's pass out the command instructions um and look for from uh we're then saying, well, actually let's get the value of uh the from instruction. And we're saying, well, does it contain anything from our denial list? In this case, our denial list just has open JDK. Um And if we match all of those things we're going to deny. So contest test, do a file. And there we see, we, we've got an UN allowed image, we've got a banned image in our uh duck file. So if I go to change my image rerun quite good. Again, simple example. Um the context really, it doesn't care about the inputs. We support a lot of different inputs. So Docker file XML uh Jason Yael, uh BC Hoon Uh And I can't even remember them all off the top of my head. There are a lot of inputs. If you've got a config file, we probably support it or someone's working on a parser for it. Let's see another quick example. OK. The civil framework is sort of again a popular way of deploying cloud applications here. I've got a server configuration file. Um And it actually has a couple of problems. Let's see what contest thinks they are. So contest test again file. Um Well, actually, in this case, we appear to have uh have prohibited the Python 2.7 run time sounds sensible. Given it's out of date, we're also insisting people provide some tags and we can have a look at the policies there. Yeah. Again, examples of Rego like saying, well, if the run time is Python 2.7 I then uh basically deny. Um You can see here we're, we're also able to build up uh functions in Rio that can be reused across multiple uh things. We've even got a set of utility functions here has field has uh to make it easier to write policies. Rio is a language. It's just, it's, it's a logic programming language rather than a more familiar maybe object oriented language. It's powerful and allows you to express really any arbitrary policy, Rico even has its own built in unit testing framework. Um So you can write tests against those policies because you could you're always going to come up to that conversation of, well, yes, we've written a policy but are there bugs in it? Well, now you can write tests for those policies to catch those bugs and sure you're testing your policies and then use your policies to test things. You've got that extra assurance. This is very much a, a software development tool. The documentation for open policy agent and learning the regal language is also really strong. Uh You can go to open policy agent dot org slash docs. You'll find a lot of wealth of examples really of using it for different use cases. I'm mainly here talking about using this for sort of policy and infrastructure as code related cases, but you can apply this to all sorts of other problems as well. Authorization is a great example. Open policy agent also provides the Rego playground. This is an interactive web application. You don't have to download anything and you can just go and play around with the language and this is also a great learning tool. Um Often in the community when people have questions about how to do something in Rio, people can post it here and share an example, share a worked example with input data and showing the outputs. Um It's a great way to get started if you prefer just to dive into trying something. OK. So we've introduced open policy agent and the Regal language and we've talked a little bit about what we mean by policy. But how do we fit that really into a workflow as we talked about really, we can test any configuration file or structured data with this tool set. And when you start thinking about, I guess the both the inputs um and the outputs that are surrounding us as cloud engineers, you start to find lots of places to, to apply this. So maybe it's um your Pulumi code, maybe it's as a resource manager, maybe it's varnish configurations or Docker files. We just saw, we saw several configurations but maybe you also have envoy configurations or circle C I configurations or Ecton. Like nearly all of the tooling we're deploying is configurable and some of that configuration might just be somewhat arbitrary but something that you might want standardized policies around. Um If, if, if your, if it's in any of the supported formats, all can be converted into those formats you can use contest to test it. Anything that outputs R text, input structured data, it's fair game. I showed you U as using contest locally there. Um But we also provide a number of uh C I CD integrations. So there are actions on tasks in the official Teon uh CD catalog. Um There's also a community member wrote a contest of the circle C I. Um There's examples with uh uh GLAB C I as well and lots of other and as a DEV ops and really that long range of C I systems. Any of them are definitely whether there's a first party integration or a community one or it's just using the CLI or the do images provided content is easy to integrate into your C I CD system. If you're testing with any other tools, this should be easy to add in additional tests for your configuration. Let's take an example of that by looking at Pulumi. So as a lot of people will know attending this event is a infrastructure as code tool. Uh you can write typescript Python go or dot net, possibly other languages later, who knows and use that to configure and stand up and manage cloud infrastructure. So here's a typescript, for example, uh creating a small stack on EC2, but this applies to really any cloud, really any API driven infrastructure. This definitely sounds like the type of thing that would be useful to enforce policy around. Luckily Pulumi has a cross guard which also supports open policy agent. You can actually write uh uh tests here in other languages. I'll focus on open policy agent really because of the portability. We can use those same policies with Rio and with other tools that provides a really interesting sort of portability story. But also we can even use those policies to maybe test things direct from the API we've got a a lot more reuse out of the same policies because we're applying them to a generic tool set. It's a really nice way of uh Pulumi supporting something that's becoming widely used in other surrounding use cases. So let's write some policies for our Pulumi provider. Um Here we again, we're back to a community example. Um And we're, we're looking at metadata, we're wanting to say that all of our uh community applications should have the recommended recommended labels. So we're setting a name instance version component part of all of these are now required based on this uh policy. You can see we define the set of labels and then we deny things that not labels that basically don't have those labels. And again, we're saying this must be a deployment. There's nothing specific to Pulumi here. This would apply exactly the same to a raw cum configuration file that you wrote yourself by hand or one been output by another tool as well. Again, that's that policy is portable. Pulumi has a built-in feature for us to apply that um called policy packs. So Pulumi up, which would normally just actually just create that infrastructure by using dash a policy pack and pointing it out our our policy folder. Again, that folder could be named anything that's just the default that contest happens to use. Um before applying, we see here that actually it's run that policy and failed. This deployment obviously didn't have those recommended the label set. Um And we've caught an error well, before, even in this case, touching an API never mind, actually provisioning that infrastructure plum also provides the ability in beta to output to YAML files. So if you, whichever of the providers, you're using a few examples here with Python and typescript, like you might use it instead of talking to the API S to output the files. In this case, you can use the same policy packs or you could just use contest against those output files. There's quite a lot of sort of like reuse and portability built into this toolchain. Let's see, a quick demo of that. So here I have a uh small Python application um and adventure this uh our policies. Let's have a look there. Um This is the policy we saw before it's enforcing the whether we have labels on our objects. Um And we have our Pulumi code um in this case in Python uh creating a deployment. Um Again, you can prob if you're familiar with Plume, you'll see. Well, I'm definitely not adding the relevant labels. I'm I'm adding at engine and that's all. So I can run Pulumi up at policy pack policy. Um And again, we'll see it fail. Uh OK. Content is also useful for checking outputs. Uh So maybe you have a lot of sort of files you're writing, but you probably also have tools that will output to structured data. So any tool that outputs to Jason or YAML or any of the other supported uh tools is also a fair game for applying policy to, we could look at. Um Coop CTL is a good example here. Coop CTL is a tool that will allow you to output to Jason or any of the cloud provider cl I most of those will also as well as give you a nice by default sort of human friendly view. They generally give you data behind the scenes. Um I'm gonna be cheeky and show you an example using sneak, but really this is applicable to any tool that gives you structured output. Um So the sneak container cli allows you to test an image for vulnerabilities. Again, that's not specific to uh this talk. Um And it allows you to output that information that list of vulnerabilities as adjacent document. Well, we can write policies against that as well. So here I'm saying that uh let's get all of the vulnerabilities, let's and then let's say, well for each of them, let's check that if the severity is high. Well, if there's a high severity vulnerability, let's basically again, like fail the bill, let's deny that uh document from passing. We can also be a lot more specific and this is a, this is the real power of Rio and having a programming language that allows you to describe policy, we can get arbitrarily complex. Even these are simple examples to compared to some of them that you would be able to build after a little bit of experience of Rio like with any Ds L there's always a learning curve but the simple things are reasonably straightforward. Once you get the model, um, if you've ever done prologue before, that's gonna be easier or, or other loic programming languages, if not try it for long enough that you get it and then try and build from there, uh, is definitely the, the advice I would give here. We're saying that, um, well, again, like get the list of it, get the individual issues, get the list of issues. Uh We're looking for identifiers of AC Wecwe are types of vulnerabilities in this case, 327 is cryptographic issues. And so here is a policy that's saying actually well fail on any high severity cryptographic issues, but also let's warn on any others. Um This is a new concept uh that we haven't talked about up to now where we, where as well as just denying and saying nope, this is blocked. We can also warn. Uh this is a complex idea that really like allows you to build a sort of nuanced U I for users. So here is an example of something I mentioned before but didn't show of using contest to take a document on standard in. So anything that outputs Jason um or or any other structured document format can just be piped straight into contest. In this case, we run contest test uh the dash thing for uh standard in and we get the output. So as well as thinking about writing policies for, again, like documents, you might write, think about outputs, it's a very flexible tool set in that sense. So we've now introduced what policy is and we've shown some examples of how you might fit that into a workflow. Um But they were generally sort of local or even in C I that, but you might have lots of projects, lots of teams and policy is definitely one of those things that often spans those types of organizations. It's often global even um policy, maybe it's to do with a specific regulatory regime or company wide rules. So sharing becomes really fundamental to adopting policy at scale. So how can you reuse the things you write? The good news is we've built tools into contest to really sort of help facilitate that. Uh conf supports uh downloading policies from a number of different uh sort of remote services. So you can download it directly just from GIT um including downloading individual folders as as shown an example here. Um You can download just from an HTP server. So if you want to, if you have a file store somewhere or anything that's downloading that allowing you to upload files and directors over a TP or it natively supports S3 as well. Um So you can very easily pull down policies from different places. If you want everything into a different repository that will work if you want to have releases somewhere and package them up, that will work too. We also support for that workflow and OC I images. And so if you have a container registry, um or you're using one of the like globally distributed uh container registries from the cloud providers, you can generally pull uh that store policies there and pull them down using contest contest also supports pushing policies there that packages up the bundle, which is how uh policies are shared and it adds a bunch of metadata that means the registries can index and store that correctly. Um This is all powered by the new OC I artifact specification that opens up registries to sharing really any arbitrary content, but in a structured way, um uh open policy agent and contest were one of the first implements of that um on the client side. Um And increasingly a lot of the registries are starting to support that this is really opening up. Um A sort of like being able to reuse how we share container images for other tooling. In this case of policy agent definitely worth checking out. Um And last, but not least that Pulumi itself has a sharing mechanism built in really scoped to organizations. So the example we showed before where I could specify the policy locally, maybe it's not up to me, maybe it's up to a, a central security team about which policies I need to adhere to. And if I can skip out of those by simply pointing that a different directory or not doing dash ash policy path, that's not good. So with Pulumi, we can do uh Pulumi policy publish that will publish things centrally. Um We can then uh Pulumi policy enable that policy and that will affect all runs of Pulumi up whether they're running with policy pack or not. Um centrally, you can't work around that then. So a built into the Pulumi service is a, a useful tool for sharing Pulumi based policies uh using a policy agent. OK. So browning up like if all you take away from this, I guess is like configuration needs tests too. We write a lot of configuration, we write a lot of the infrastructure as code and it definitely benefits from everything we've learned from software development and that's not just down to testing and in this case, using sort of policies, it's true of other. So the other aspects of software development as well. So introducing C I thinking about refactoring, thinking about code quality and repetition, like and refactoring um but definitely like adding tests into your configuration and your infrastructure as code, it helps you go faster by making you safer. Um looking at specifically as an approach to solving some of those problems. I think it's useful to think about the fact that that's useful for lots of different cases. Lots of tools historically have come with a testing approach. They've come with built in testing tools or community provided ones. But then when you move to a different tool. It's a different testing tool and, and the reality on the ground for most cloud environments is you're not just using one tool you're using all of them. Um Open opens up that idea that maybe we can standardize in a different way. The policies we write can be portable between different tools that are doing the same thing. Again, that could be a huge time saver later as well as making it easier to move between different tools and lowering the cost of adoption. Ultimately, conversations around policy have generally been in meeting rooms and with documents and really the implementation of that has been left as a separate thing later to maybe never happen. I think policy needs to shift left. We need that conversation about policy to be part of what we talk about as engineers, building cloud environments or ultimately building applications. Thank you for listening. Um If you did like this talk, do feel free to sign up for sneak um for free over at, at sneak dot io slash sign up. Um And if you do have any questions about this, I'm Gareth are pretty much everywhere on the internet. Thanks for listening.

---
