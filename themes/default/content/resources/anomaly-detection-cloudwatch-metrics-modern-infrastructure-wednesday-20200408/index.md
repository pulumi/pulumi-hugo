---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Anomaly Detection with CloudWatch Metrics | Modern Infrastructure Wednesday 2020-04-08"
title: "Anomaly Detection with CloudWatch Metrics | Modern..."
meta_desc: |
    In today's episode, we explore anomaly detection through CloudWatch metrics. Code for this episode available at: https://github.com/pulumi/pulumitv...
url_slug: anomaly-detection-cloudwatch-metrics-modern-infrastructure-wednesday-20200408
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Anomaly Detection with CloudWatch Metrics | Modern Infrastructure Wednesday 2020-04-08"
  description: |
    In today's episode, we explore anomaly detection through CloudWatch metrics. Code for this episode available at: https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-04-08  The examples are in TypeScript but Pulumi makes it easy to stand up infrastructure in your favorite languages including Python, JavaScript, Go, and .NET - saving time over legacy tools like CloudFormation and Terraform. https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video  This is the second of a two part series. You can watch part one here: https://youtu.be/PF7KnOB3fLk
  sortable_date: 2020-04-08T16:45:00Z
  youtube_url: https://www.youtube.com/embed/WC9ctwQ94bs
transcript: |
    Welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lee Zen. Today we're going to cover the second part of our anomaly detection, uh, walkthrough the first time. Uh last week, we went through using Amazon Guard duty to monitor some of our logs and understand if there's any anomalous behavior occurring in our accounts. Today, we're actually going to do this in cloudwatch. So we're going to use Cloudwatch events to publish a metric and then we're going to monitor for anomalies on that metric. Uh If you like, you can follow along via github, I'll have this example published on github dot com slash Pulumi slash Pulumi TV. All right. So let's jump right into it. Um You can see here, I already have some code pulled up. Uh This is something I already started. Uh just that we would have some data already running in the system uh, before we, we moved on with the, the example. So let me just walk through what I've already done uh in terms of the anomaly detection and then, uh we'll see kind of how it currently works and then we'll add in the actual detection after this So right now, this first part here is really just about uh publishing, publishing data into cloudwatch. So you can see we create a uh schedule event. Um This is uh an Aws cloud watch event rule. So all we're doing is creating a schedule expression that basically says every minute this, this rule is going to fire. Um And uh for reference, let me just pull this up. Um You know, the way I figured this out or the way I found this was, you know, I looked at the schedule expressions for rules in Aws and you can either have chronic expressions or you could have um rate expressions where the rate is, you know, some unit per uh uh value. And so here I have a um or some value per unit or rather, so this, I have one minute um in my, in my code here. So you can see I have a rate of one minute. So basically this, this rule will fire every minute and we use our handy Andy um on event uh listener here. And so we create a handler. Um And I basically just have a very simple function handler it in instantiates uh a Cloudwatch client. Um This actually is a convenience, by the way, you can do aws dot SDK, even though this is coming from the Pulumi Aws provider. So we have this cloudwatch client and then, uh we would just tell it to put some data. Um I've created a name space called Bloomy and uh have a metric name called. No example. Obviously, you could do a lot more here. You could do things, you know, like um uh dimensions uh which you would expect in a Cloudwatch metric. Um You could also add statistical values that you would expect it to be able to do in a Cloudwatch metric. Um You can change the time stamp, you can do all those things uh since we're using the just normal uh Cloudwatch SDK. Uh But in this case, um all I'm doing is uh is I'm just going ahead and, and publishing this value which I got from up here. Um Normally it's 100 and uh every so often it'll be 1000. So that's, that's all we're doing. And so if we go back to my browser and we pull up uh cloud watch, you can actually see that I have this uh metric post that will actually change this to be the last um 30 minutes. And you can see that if I look at the sum over the last 30 minutes, I actually ran this a couple times within the same minute at the very beginning. And then, you know, it's been running on a schedule ever since. So you can see this kind of, you know, every minute we have this 100 100 100 then once in a while we'll have 1000 so that this is gonna be our synthetic metric we're going to use uh for our anomaly detection. So you would expect that normally, uh this is what we want. And then, you know, so anomalous behavior will happen. Obviously, in a real world scenario, you, you might have um data that's not so smooth and data that's not so easily uh detected with a threshold, right. So here we could just use the threshold to detect this. Um and then, you know, we'd be done. But in a, in a real world example, you might have some kind of curve or something like that, that wouldn't be so easy to detect uh with thresholds. So let's, let's, let's figure out how we can actually detect uh events on this. So we want to be an alarm. And so we'll do uh uh and uh we can create a new cloud watch ups, a magical arm. Oh Where did I go? Metric alarm? Call this anomaly alarm. And uh we can take some arguments. Um And so what we want here is we actually want to um uh first give it a name, so we'll give it, you know, a name and a description, right? So we'll give it, you know, anomaly, uh we have a alarm description because that's useful for the person who's getting, who's getting this to say, you know, the uh value was out of expected bounds. I don't know what's in here. Um And for anomaly alarms, there's actually uh the comparison operator and this can be a number of things. Um, in Cloudwatch you normally it would be like less than, or something like that. Uh, but in the case of anomaly alarms, let's actually look this up. Um, so this is, this is what we're gonna see later by the way. Uh, and let's see if it has the not here. Oh, that's not what I want. So I need to find the reference that actually tells me, um, the less than greater than thing that I'm looking for. Let's just search that again and not alarm. Anomaly less than I think I might be here. Yeah, I thought it was just, was it not just reading this? Huh. Well, that's very odd. Let's actually look at our plumbing documentation and maybe we actually have this, um, in our docks. I would expect to have that. Oops, the wrong thing. I expect that to have that in the, oh, what do you know we actually have this, um, here. So you can actually see there's a greater than upper threshold. Um, and actually, oh, here, perfect. So, actually to come to our own docks in the first place. So you can see that the, the possible values are, are these, um, and so I will use the, uh, less than, or greater than upper threshold. So basically this means if it's less than the threshold or it's greater than the threshold, then then we'll alarm. So we'll use this actually we can probably just use most of this example. So we, we have the description, the comparison operator, we have evaluation periods. Um We just need to be uh one period out of alarm, especially because um the way that our synthetic data looks, you know, it's only gonna be one data point at most anyway, uh or statistically could be more, but you know, it's unlikely. Um And let's just copy this. Uh we've modified for our own purposes. So, um this metric, there are no inventions that we had earlier. We, we know the name space uh was from really here. So we actually, you know, do, do the right thing here from a code perspective. We'll make some constants up here for factor that out. And now we can do this uh metric name space, the metric name and down here you can actually do the same thing or actually the other thing we could do is um oh yeah, that's what we want. Yes, the metric name, your name and then uh metric name space and the period here is one minute and the stat will use is some. Um the unit doesn't really matter here. We can go to this. Uh And then, so that that's, we'll call this metric M one and then we'll create an normally detection band uh on M one and we'll call this just, you know, some exceeded. Uh we'll call this E one and you can see we actually you know, have that metric threshold on E one. So that's actually all we need. And so now we can go run, give me up and let's look at this. So uh the things I modified, oh, I modified the code, which I did, I changed the, the values here to, to reference these constants. Um So we'll update that and then we'll create a new alarm uh from, from earlier later. So let's yes, let's make that update. Great. So we updated our code and we created a new alarm. You can see we had the, the new alarm and then we updated the code. So let's go back to the console and let's refresh this. So everything seems quiet so far. Um, we can open our alarms dashboard and we should see our new alarm anomaly alarm. Yeah. And so far it hasn't alarmed yet. So, um, this is the, I guess this is the part of the demo where I should probably just force this to uh start returning on thousands and uh see if we can get this to, to be out of the band. So let's do this in metrics together. So we can actually see and let's do this the last uh hour, right? Interestingly, it doesn't have the band yet. So I wonder if Aws is still uh predicting the model, uh, in which case, this might not be the most interesting demo, but let's try it anyway. Um, so let's do this or let's actually just make it more likely, I guess. So, we still have some very boaty, let's do this. All right. So that should not be ever code again and we'll hopefully see it go into alarm. We'll see. I don't know, I actually, I don't know how long it takes for these models to compute. Um, usually I would expect to see a gray band around this metric indicating that we actually had a detection band. OK. So that updated. So, uh I'm gonna pause the video here and we'll come back in a few minutes. Uh Hopefully see our alarm go off. It's like cooking. It's like a cooking show, right? It's like the, you go to the oven and then the thing is already there. It's already made. So let's, we'll come back in a couple of minutes. All right. And we're back and uh, unfortunately, I guess I'm faking. It is not gonna really work so well. Um I uh I actually uh spent some time reading the documentation. It seems like you actually might need like a day or two of data for this to actually work. I probably should have read the docs before I tried this. Um I will show um example, uh on an existing metric that's kind of pretty long lived. This is just a, you know, c for uh a machine that we already had that was just happened to be running for a long time. And so you can see kind of, uh, what you would expect to see, um, by doing the, the example I showed. Um, but unfortunately, uh, it's not gonna work out in terms of, uh, being able to show it, um, live given just how long it's gonna take to, uh, to have the, uh, detection band show up. So, thanks for watching today. Uh, I hope you enjoyed this episode, please. Uh, follow Ploy Corp on Twitter or myself. Uh You can also submit requests and bugs uh on github. Uh If you have any requests for future episodes, please comment like and subscribe the video and we hope to see you soon. Thanks very much.

---
