---
preview_image:
hero:
  image: /icons/containers.svg
  title: "TTL Stacks and Temporary Infrastructure | Modern Infrastructure"
title: "TTL Stacks and Temporary Infrastructure | Modern Infrastr..."
meta_desc: |
    Infrastructure waste is a common problem. It’s too easy to leave development infrastructure running accidentally and end up with a huge bill. Many ...
url_slug: ttl-stacks-temporary-infrastructure-modern-infrastructure
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "TTL Stacks and Temporary Infrastructure | Modern Infrastructure"
  description: |
    Infrastructure waste is a common problem. It’s too easy to leave development infrastructure running accidentally and end up with a huge bill. Many companies have entire teams devoted to solving this problem.  With Pulumi Webhooks and the Deployments API, we can build a system for tagging and reclaiming temporary infrastructure. Anyone in your organization can create temporary infrastructure with a simple workflow.  The Deployments API can be embedded into your platform to reduce cloud waste and automate cost controls. The full source code is available at https://github.com/pulumi/deploy-demos/tree/main/pulumi-programs/ttl-stacks   
  sortable_date: 2023-03-15T14:00:16Z
  youtube_url: https://www.youtube.com/embed/DK21W0K-0Hw
transcript: |
    Welcome to another episode of Modern Infrastructure Wednesday. My name is Aaron Cow. This is part two of the series on Pulumi deployments and part one, I showed you how to use O I DC. In this episode, we will build att L stack processor uh which is an application that monitors stacks in your organization and automatically triggers a Pulumi destroy through deployments deployments. API when a stacks expiration time has passed, we're using the TT L stacks. Example from the Pulumi deploy demos, repo infrastructure waste is a huge problem. It's too easy to leave development infrastructure running accidentally and end up with a huge bill. Many companies have entire teams devoted to solving this problem. So with our TT L processor here, we're able to have temporary infrastructure stacks that automatically clean themselves up. After a period of time, we are going to deploy two stacks here for this demo. The first stack deploys the TT L processor and the second stack will be tagged with the expiration time and the TT L processor will reap it when it expires. The architecture works like this. The TT L processor is composed of two lambdas and SQSQ. The Pulumi service sends events to the TT L processor to first LAMBDA via a web hook. This lambda looks for update events that have att L tag. It calculates an expiration date and it cues the stack for cleanup. The cleanup key processor uh Lambda pulls from the queue looking for expired stacks and runs a plume destroy via the deployment's rest API and the plume service. Let's get started here. We have the deploy demos, repo with the TT L processor code that we're gonna deploy. OK. We've cloned the deploy demos uh repo here. Um And here is the TT L stacks uh folder and this is uh the program uh for the TT L stack processor. Uh It deploys the lamb does um and it's able to um read from a web hook, um all the uh the events from Pulumi and then it, you know, reads off of the queue and um is able to execute a Pulumi destroy on all expired stacks. So let's start running this. We're gonna do a plumy stack of knit start this. Then we are going to set the region to the US was two. And then we're gonna set the Pulumi axis token though. And to do that, I'm gonna show you how to create an axis token. So here I'm going to a access tokens create token. Let's call this and we're in a day. OK? OK. We got that there and now we can execute a plumy up. OK. Uh So here is the TT L stack processor, um A lot of Laos and this SQSQ. So there's uh 44 resources that it's gonna create. So we're gonna perform that update and uh we'll, we'll let it deploy the stack and we'll be right back. OK. It is done. Now, this URL is what we're gonna use for our web hook. Uh So I'm gonna copy it, then I'm gonna go back to, yeah, the Employment Council gonna go to integrations and then hit create a web hook. Um, do that and, and safe. OK. OK. So now that we've created a web hook, we're gonna um provision another stack and we're gonna tag that stack uh with ATT L and then um it's gonna be shot off as an event which the webhook will pick up. The lambda will pick it up, read it, cue it on to the queue. And then um the cleanup lambda is gonna read from that queue and the ones that have expired, it's gonna use the Plumy deployments API to uh do a destroyer command to tear down that stack. So let's do that now. All right. So let's create a folder here. Um Let's see. OK. Going in here, let's do a Pulumi New, let's just do a very simple Avios Python application. OK. Great. Project name. That's all good. Put it into the demo organization and we will deploy the US was two here. All right. I'm gonna let that run real quick. OK. That is done. Now, what we're gonna do is we're gonna tag this stack specifically and we're gonna specifically set the tag to have att L and then a number of minutes. So we're gonna set it at one minute and then we will do a poly me. Uh So we're gonna let that run. OK. That's done. All, we're gonna flip back to our console, good dashboards And we can see that first. Um There is the TT L stacks, the TT stacks, the TT L processor. Um This is that deployment and then the second stack that we uh just launched uh which has the simple way to be use. Python application is here. So you see that that update has succeeded. It's deployed as three bucket. Now, if we wait a minute, what's gonna happen, what we should see is um a plume destroy command will happen and the TT L processor will reap this stack because it's expired. So let me wait real quick and come back when that starts. So while that kicks off, we can actually do something here. We can just go look at the lambda function and the A to BS console, take a quick look at the logs and see what's happening. Ah Here we go. Um A deployment is kicking off uh from the TT L processor uh and that's gonna destroy a stock. So if we go back here, we should be able to see the web book uh coming in. Uh So let's see, essentially it's a, the stack has expired. The demo miw tt L demo Deb stack. So it's been queued uh for destruction. And um the lambda is executing um to, um, and calling the uh deployments rest api to do to, to destroy stock. So you'll see here that, um that is happening now, uh we'll let it run through and uh show and then we'll be right back. OK? It's done running. So you'll see that um you know, it's executing a deploy o or destroy operation and it's deleted all the resources. So if you go here, the resources are gone and the stack is now uh destroyed. So there we have it att L stack processor that automatically cleans up infrastructure stacks and it is all using uh the Pulumi deployments API. So this video is based on code and our deploy demos, get hub repo, the link is below. And if you enjoyed this video, don't forget to hit the like and subscribe buttons. That is it for today's modern infrastructure Wednesday.

---
