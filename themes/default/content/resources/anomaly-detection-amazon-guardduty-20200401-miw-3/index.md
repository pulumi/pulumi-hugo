---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Anomaly Detection with Amazon GuardDuty | 2020-04-01 (MIW 3)"
title: "Anomaly Detection with Amazon GuardDuty | 2020-04-01..."
meta_desc: |
    In today's Modern Infrastructure Wednesday episode, we explore anomaly detection through Amazon GuardDuty. Code for this episode available at: http...
url_slug: anomaly-detection-amazon-guardduty-20200401-miw-3
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Anomaly Detection with Amazon GuardDuty | 2020-04-01 (MIW 3)"
  description: |
    In today's Modern Infrastructure Wednesday episode, we explore anomaly detection through Amazon GuardDuty. Code for this episode available at: https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-04-01  The examples are in TypeScript but Pulumi makes it easy to stand up infrastructure in your favorite languages including Python, JavaScript, Go, and .NET - saving time over legacy tools like CloudFormation and Terraform. https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video  This is the first of a two part series. Next time, we'll cover anomaly detection via CloudWatch alarms.
  sortable_date: 2020-04-01T06:09:48Z
  youtube_url: https://www.youtube.com/embed/PF7KnOB3fLk
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. Today, we're going to be talking about anomaly detection in particular, looking for anomalies in your infrastructure looking for oddities that uh might be occurring in your, in your metrics. Uh We'll have two parts of this today. We'll cover a guard duty and next time we'll cover, uh looking for anomalies via cloudwatch metrics. So in this particular episode, we'll be using Amazon guard duty to look for anomalies, uh particularly against uh cloud trail events, uh and other, other things like that. And then we'll be connecting that with cloudwatch events to notify us. Uh, we could define a callback that becomes serverless function so we can use that to actually, uh alert us in Slack. Uh So we'll actually hook us up the slack uh via webhooks. If at any point you want to follow along with the code, you can check it out. It's on github dot com slash Pulumi slash Pulumi TV. All right, let's get started. So let's start a new Pulumi project and we'll use typescript today. I'm sorry, let me make a directory first. Let's call it, uh, Amazon. Uh, we'll call it a guard duty. I'll take the default guard duty name. We'll call this, uh, you know, a detect anomalies by a guard duty and we'll, yeah, sure. We'll go with the Devs Deck and we'll go into, let's go with the US East two today. So, while this isn't selling are no dependencies. Fire a visual studio in a separate window. All right. And here we go and we open the visual studio code here. I'm ready to rock and roll. All right, let's make this a little bit bigger and we want to create some guard duty stuff. So let's actually uh I don't remember how to do that on top of my head. So let's look at some documentation. So we'll go to uh the A US docs. We look for the guard duty package module right here and I'll bump this up in case you can't see and uh we want a detector. So let's look at uh what we need to do here. All right, that's gonna copy and paste this. Actually, this looks pretty straightforward. Give us a better name, they'll call it one, it's called detector. And what else do we need to do? Finding publishing frequency? OK. I think probably don't need anything there. Um And in addition to that, uh we also want to set up uh a cloud wash. So now we have detector, we also want to set up a cloudwatch event. Um And this, I happen to know off the top of my head to do so we'll do a new cloud watch events and we want to invent rule actually. Um, so we'll call this like the, you know, our guard duty rule and, uh, we'll look for an event pattern, uh, and we look for in particular the source of, uh, aws guard duty. I'm pretty sure that's right. Let me, let's actually double check that. So let's Google for a guard duty um events and this is probably it, yeah, so we wanna, we wanna look for this particular format of the, of the uh source. So this is this this cloudwatch event rule that we're creating here will match on any events that match this particular source type, which is the, the source type here in this, in this uh particular event that's gonna fire. And so now we'll, we'll actually have this, this, this cloudwatch event rule that we can, we can uh work against. So this will generate notifications of cloudwatch events rather uh from that detector. And now we can actually create a callback to work against this. So we'll um uh what we 11 way to do this, we could do rule on event. So we name this, you know, guard duty call back and we can actually just give it our handler straight here. So we can actually, you know, have this be um our event and this could be if you look at the typing, this is actually what we expect it to be, it's the event, rule event. Um but we can actually declare what we wanna do with it here. Uh And uh we actually want to post this to slack. So we're going to actually import um XO and actually need to, so we actually gonna make a post call here to do this. Um And so in our code, we, what we wanna do is we would like to actually, uh you know, any time we have an event, notify ourselves that, you know, something happened, so we can do something like this and realize we need a URL here. So let's put in a temporary placeholder here. Let's call it URL and we'll figure that later. Um And we'll have a text, you know, uh on guard duty has detected uh you find it and let's actually wrap this up. So we can actually see what happens if anything bad happens. And that's it actually, this is pretty simple. And um so now the question is, how do we get this URL? Um So what we really want to do is pass in a slack uh Webhook, URL. Uh So we can post the slack. And so if I go back to my browser, um you can see I have this handy dandy incoming webhooks thing set up and I can create a webhook and I can copy it um And uh post it into uh post it into a channel. So you can see here, I'm actually gonna post it into this security channel. So uh to do that, I probably actually want this to be an environment variable instead of just putting our secret in here. Right. So let's actually configure this as a secret. So we will do this, which will give us a config object to work with. And then we'll call uh slack, we called the URL will require the secret. We'll call it. Uh You know, we'll be not too creative here. We call the slap, we Slack, we URL. Um And so what you would do here is you would do uh Pulumi config, make this a little bit bigger in case you can't see Pulumi config and you can see actually, I have my little handy uh I have my handy little uh helper here to tell me what uh stack I'm on. Uh Pulumi config. That's a custom thing you can add. Thanks and shout out to uh Community Slack for mention for telling me how to do this uh community config uh Pulumi config and we'll set the slack web hook URL to for now is, you know, put a placeholder here and we'll say secret. So now we have this URL that would be in our application. I would actually normally get that from this page, but uh I don't really want to copy and paste something that you're gonna see that will actually post into our Slack channel. So I'll just put that placeholder there for now. And since we want this to be, so we can't actually pass that into here because this, if you look at this, this is an output and we're not gonna do that here. So what we do want to do is instead I'm going to actually create a callback function so we can pass in. Um So we can actually pass in uh the, the URL is a, is an environment variable. So I mean that's actually better for from a security perspective as well. So let's do that. Um OK, let's callback function. And it takes this event type which if I recall correctly was uh I need to look at my types again. So it's a Aws cloud watch event rule event. Did I misread the type it Aws cloud watch event event boy? Ah sorry, this is, this is not type this way uh as she might be mostly. So we give it some arguments. So we give it a call back. This will be our events to the actual code I had earlier. Oh, I already have that get this and now we can actually say give it our event and we can pass in our environment variables. Now I can give it the thing from up there. So what this will do? Let's see. Uh Let me see what's going on here. Oh It's because I need this is variable. There we go. So now we have this probably just auto complete in general. So, yeah. Ok. And what's the complain right here, uh, could be undefined. So, well, we know this is defined, so I'm just gonna cheat a little here and just do that. And actually, I think that's pretty much all we need to do. So, at this point, what we've got is we created our little detector and, uh, we have this event rule that, uh, actually just looks for these particular events. And then we hooked up this callback function to this rule so that every time this rule fires, we will basically post to our uh web hook URL um that we have new findings. And uh and then we finally hook up this call back to that particular rule at the very, at the very end. So we can actually run glu preview here, see what it tells us. And there we go, we create all these different uh resources and yeah, and then we'll, we'll be learning on, on any anomalies that cloud uh that Amazon guard duty has detected. Cool. So that pretty much sums up this episode. Um In next week's episode, we'll actually talk about how to use uh cloud watch alarms for anomaly detection as well as using guard duty to uh detect anomalous uh behavior in your, in your Aws accounts. Thanks for watching. I hope you enjoyed this episode. Please like and subscribe uh also interested in what you want to see for the next episode uh after, after the next one, obviously, so feel free to leave some comments, follow us on Twitter. Uh And yeah, as I mentioned at the beginning, if you want to check out the code, it's available on github. Thanks very much.

---
