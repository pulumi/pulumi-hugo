---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Creating CloudWatch Metrics from GitHub Actions | MIW 2020-11-11"
title: "Creating CloudWatch Metrics from GitHub Actions | MIW..."
meta_desc: |
    In this week's episode of Modern Infrastructure Wednesday, I live code an example of creating AWS CloudWatch metrics from GitHub Actions workflow r...
url_slug: creating-cloudwatch-metrics-from-github-actions-miw-20201111
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Creating CloudWatch Metrics from GitHub Actions | MIW 2020-11-11"
  description: |
    In this week's episode of Modern Infrastructure Wednesday, I live code an example of creating AWS CloudWatch metrics from GitHub Actions workflow runs using TypeScript. The metrics are updated on a scheduled basis via AWS Lambda functions.  Today's example is in TypeScript, but Pulumi makes it easy to stand up infrastructure in your favorite languages including JavaScript, Python, C#, and Go - saving time over legacy tools like CloudFormation and Hashicorp Terraform.  https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-11-11T18:35:05Z
  youtube_url: https://www.youtube.com/embed/F8Q1bwwuJcA
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lie Zen, doing some live coding. I actually realized I should probably start recording as I was going in the middle of this. Um And so, uh what I'm doing today is uh trying to build out a quick little project to uh shove metrics into uh club watch based on BUILD status. Um So I started playing with the github API. Um And so, you know, I was looking at kind of uh Pulumi Pulumi as an example of doing this um the Pulumi repository and I was kind of looking at the workflow runs API and then also playing with some Curl uh and JQ and then um really just trying to figure out how I wanna do this. So I think right now, you know, so far this all makes sense like I want to use Octa and list the runs uh for a rebo um based on, you know, the ones that are completed and then basically looking through those uh workflows to kind of uh make sure that uh we publish metrics for each workflow based on um the most recent uh status of one. So I think the tricky part right now is really um the fact that the API is kind of a little awkward, I think like uh you can list the workflow runs for repository, uh which is what I'm doing uh here. Um And you can also list the workflows uh for repository. So if we look at the, you have API can also list the workflows. Uh but it's not clear that there's a way to um list the runs for a workflow. Like I couldn't, I didn't see that. Um this is kind of even more of the jobs for workload, which was not what we want, we want to see given a workflow ID, give me the runs for that workflow. I guess that's what this is. OK? So maybe I can go the other way. Um Turn work returns workflow run triggered by the event you specify. But then OK, I see. So maybe we can go that way. So let's go II I missed this. So let's go back and take a look at this because, you know, we really want to be able to track this on a per workflow basis. Um So let's do that, just look at that. So, so let's do this. So first we're gonna get all the work flows to the repository, then we're going to list runs for that workflow, taking the latest completed one and then publish that as the status. That's our pseudo code. So OK. So let's do this. Um And we only care about these uh types of workflows. So first let's get the work flows for repository. Uh And that's pretty easy. I think that's action's list will close. Here we go this, we, we close. Um And this takes owner which is our org, takes the wipo which is our rebo. Oops, we have that ready. Um I think it doesn't take anything else. Yeah, we don't need any of this. Uh, and for now we can just assume that, uh, so we're just gonna assume that we only have one page. It's a pretty reasonable assumption. I think github typically pages by like 100 or something. Um, and say here, but I think typically the page size is 100 and, and even, you know, here we definitely have fewer than 100. I guess we can test that real quick, um, to see if we get, you know, all of these workflows. Uh, we can call this, uh, this kind of closes. Oh, sitting to find at the top. What is it called then? Uh, well, total count is 15. So, ok, I don't even need that, but that's weird. That didn't work. I might have messed me up. That's ok. Uh Either way, I guess we know that this is, uh, 15, so we definitely get everything back. All right. So, um, let's do that for now and then we can go through each of these workflows. Hello? Is this not OK. This is now uh there we go. Let's just clean this up. Call us more close response. We can also pair her out. All right. So um great. So for each workflow, then I can move this in here. Now, uh we can, when we look at those and we wanna list the workflows runs uh for that workflow with those events. So let's do that. So list workflow runs and this takes again the owner Delio and now workflow ID and that should be our workflow ID. Um And ideally, we wanna only have it on certain events. So you can see we have these two events though, I can't filter by multiple event types, it seems. Um So I guess we can just, we'll have to do this. OK? Uh OK. This is OK. It's reasonable. Now, I guess um let's call this get up event just to be a little clear, delete all this and we want this to be the ones that are completed. So there should be a status need it. OK? So that seems pretty reasonable. Um OK. So I think this should probably give it to us in orderly as you'll see. Um in test that, I guess we can probably see what it says, we can look at the examples. So 48 30. OK. This is not actually a helpful example since those are the same time. Um let's look at our own repository here. Uh oh wait, this is the wrong one. That's why, that's awful. Let's look at uh yeah, runs. OK. So that only is one. OK. Well, let's just call it ourselves then. Uh so and what we wanna give it, we wanna give it work flows, we'll flow ID and then run. So um let's pick this. OK. So let's see. This is in hopefully reverse order still is completed. That's right. Um So this is 2 27 and if we come up a bit, uh then we're at, OK, it's still 2 27 come up a little further. Uh Yeah, so it's, it is reverse order, which is great. So we can take the head of that list and um get what we want. So OK. Um And here, now we actually finally have the information, we can finally decide if we want to publish a metric or not. Um Or we always want to publish a metric rather. So, um here I'm going to actually import because eventually we're gonna use the cell lambda function. Um But for now we're actually gonna use this a different way. So we're gonna have uh just um actually will clear this client outside of here since we're gonna use it more times. And actually, no, this is, this is, let's not do that. That will be, this is, this is our compute. So we're not gonna do any cloudwatch stuff here. So here I guess here is when we will, we'll use the call like we'll have a call back here. Um Or we can build a, build a map. Maybe that's actually maybe be easier. Let's just do that. Uh So we'll build a map from these uh these different workflows to uh to the metric. So let's, let's do that. So, um let's create a map up here. Um We call this uh results, OK? And it will be a map from a, I guess it's really from the number which is the uh workflow ID. But I think maybe we want it to be named. So let's let's call it the, let's give it a, let's give it a string. Um And we're gonna map that to a number uh which is the number of build failure uh minutes uh or seconds. Um And so here, let's calculate this number. So we just run, should be the runs response, it runs, you know, we know we have that here since the total count is more than, more than zero. And you can basically look at uh the time between now and the latest run or if it's successful, we'll say zero. So, um so we hear about this conclusion. So if the conclusion is, so here, let's call this um failure, minutes, failure seconds. And oh, this is not a, this is not typed. Interesting. OK? Well, we know the conclusion um should be, you know, success, I believe. Uh Let me see. Yeah, So if the, the conclusion should be success, um if you, if it succeeded, so if it's success, then, you know, then it's, it's zero seconds. Otherwise, um, we know that it should be the time between when this run ran and that should be call this a con guess update that, that I completed it, update. It will use the last when it finished. Um And this is a string, OK? This is like in this time format. Uh And so we can convert this um to a time. Just make sure that actually works. I believe it should out of the box. Oops, I numb trying a node. Yeah. Great. Um Yep. OK, great. And I think it's called, I think I want uh get time on the phone. Correct? Yes. OK. So yeah, so this is in milliseconds. Um And I wanna subtract now from that, right? So uh uh I don't know, I thought there was a date. Uh Now am I going to match anything? Oh, there it is. Ok, great. Let's see. Yeah. So, and that gives us a reasonable number, right? This is, it's hours, times days. Oh, this is in milliseconds. Huh? So this is like 203 90. OK, great. So we want this. So this isn't this is failure milliseconds. Um Oh, let's make it seconds. II I think that actually makes more sense. So we can just take this whole thing to the 9000. OK. And yeah, So if its success zero, otherwise this OK. And now we can finally stick this into our map so we can do uh results set. Uh And we can do the uh here, we wanna use the Brooklyn name and we can set the value to the failure seconds. And when we're all done with all this, we can return results. Great. And so we can subtype this to be a map of string. Uh And this is as essential as promise. All right, great. Um And actually here I realized uh we don't passionate either, but that's actually like on purpose since we only just need the first one. So we can, let's, let's test um running this real quick. Um And we can, I'm just gonna make a quick like and I was on this file actually, so we can just do um uh we can use my, you how we can use environment variable. We'll use uh Pulumi for me. Uh And then we can like this. I'm at the top level here. Let's just do this uh map dot Preach. Um All right, let's just try this and see if this works. Have this, get her personal. So I happened to have this on the show. Oh, and I can run Ts note from um oh OK. Map has. Where did I mess up up here? Do not like this? 49. Yeah. OK. So, but yeah, and it's not a sound like 49 that seems odd, undefined. It's not a sign with the string. This is happening at this line 49. Why does it think that? Oh, because this is no. Yeah, then yes. Ah, ok. I flipped the, it should be value string. No. Give us a call back of, uh, yes. To void. It seems correct, I guess. Let me just try. This said it's just going crazy somehow. Um, ok. No, still not something, something happening here. Uh where I don't see what I'm doing wrong though. Is this a different type? No, this is map string of number. Is it when I stick this in here work flow? The name is defined, defined said string number. Yes, results. Uh But because this throws, is that what's throwing this off? Trying to see where I'm, I've gone wrong here. Is it not like this? Because they could not, they could be undefined potentially. I guess that might be it. Yeah, that seemed to be it. Ok. Everything else was actually Kosher before that. All right. Let's see. Uh If this works. All right. Great, cool. So we can actually see the various uh, names of the workflows and then kind of how, how long ago, um, this thing was failing for and it's actually some of these aren't, aren't bills we care about anymore, but that's, that's maybe that's ok. Um, I can recognize some of these are old names that we don't really use. Um, like I don't think I, I don't recognize this workflow, for example, for a while. Um So we can probably filter those out or that. OK. Great. So that's working. Um So far I haven't shown any of the stuff related to actually getting this into AWS yet. Um So maybe let's do that in a sec. Uh But let me just delete this. Now, we know that this is working the way I wanted to. So basically, we have each workflow name uh followed by the actual uh metric. So that's, that's, that's good. Um And we probably wanna do a little bit more. Uh So we'll do um we call this confusion for bill during your time. Uh Actually, let's, let's just skip that for now. We can manually define a set of repos and orgs. Uh We're gonna try this against for now and then kind of just make sure it all works and then we can iterate from there. So, and now let's go back to this. Now, let's let's actually get that function uh shoved into Aws as a thing. We just call uh all the time. So let's import. So let's actually export this function. Um And now we're gonna create uh a fun uh a schedule of function. So, um I would watch uh on schedule and they'll call this um you know, uh build metrics event, a couple schedule rather, let's just be slightly more descriptive. We call it with the metric schedule and this takes what does this take? This takes some kind of schedule. Uh So I think that's the actual schedule. We'll call this rate and we'll do this every hour. Uh seems reasonable enough. Um And then it takes a handler uh in which case we can create the handler. Um And so this is, this will be our event handler. Um And this is typically, it looks something like this. Um And so you can see this is an event rule event. Um And we don't actually really don't care about what's in the event, but all we really need to do is just call our thing um with our token uh org. And for now I'll just click gloomy and for now I'll do, do this and later we can add more to this. Um And so we can actually make this in a function so we can await this that in lambda, this actually runs completely. And then now the only question is like, well, how do I get this token thing? But actually we can just do this. Um And he used, he used the process uh here and so this is where I can assume we have this and then now we can actually give it those arguments. Um So, oops, so that I could, yeah. So now I can give it these AGS. It's odd that it's not uh completing um these are the event subscription ags. Oh, and those are, yes. Ok. And finally, these are the options. OK. So actually, uh I need to change the way my callback works a little bit. So I need to actually create a callback function so I can pass it environment variables. So we'll call this call back function. It's cool and this takes um an event in this. So we, we actually know what the event type was uh here. This is, you know, you can see this expects a um this effect, this kind of handler event will avoid. So we'll just copy that and this takes a name. So we'll call this um build metrics, callback and take some RS. Um And here we can actually, now we can do what I wanted so we can give a call back as uh just that ay function I wrote earlier. Um And uh here it will just be if this takes this event, uh This should be a US cloud watch the moment that we actually end up ignoring that. And then we end up um calling the function. So wait compute and now we can do a process and you have token and we'll just hard code this for now. All right. And then now we can give it the environment and here we can actually pass in uh a config so we can do um uh here we can use blue config so we can, and um here we'll have this uh github token actually, I think just say variables. Yeah. And this can be um from like in fig, so fig require a secret and we can ask for uh get hub. OK. All right. And this, this is, this is in, you know, in an input. So we can use this, which is an output into the input. So here we just have to do this. All right. So this will actually create a callback uh that gets called every hour uh for us. Um And then that will actually compute everything that uh that we want. So let's actually uh try running that. Um let's actually change this to one minute for now. Um So we can actually run it more often. And let's uh let's see. I read the, the I, I forgot that what I didn't do is so this, this call, this generates, this creates um that map, but we don't actually post to uh the Cloudwatch. So we actually need to do that. So let's do this. And now we can iterate through this map uh and uh post the club watch. So here we can do the uh value and this is the name and we can do so we have this new cloudwatch uh uh client and then we can do cloud watch, put metric data. And here um this says it expects a callback. I believe there's um let's do this. Uh Yeah. So it's, it can give it like metric data. And then, right, so, and we can probably just um then we can define the metric data. So data uh it's called paras and this should look like this. Um Actually, I wonder if like this has the type we care about. Yeah. OK. So here, so we can do this so we can make sure this is nicely typed A BS SDK cloud watch. Yeah, let me get around here. Is it OK. There's no types being exported like that. I do that. No. All right, let's just uh do this for now. We'll come back to that. Um All right, here we go. So now it's gonna give me the typers. All right, that's, that's pretty good too. Um Yeah, so it's not, not the right type. So we need to actually give it the metric data and here uh we can say metric name uh and the metric name should be let's call it um to know failure feeling. Uh And then uh give it some dimensions and by the way, I'm just reading off screen some documentation for how to do this. Um And the is a name. So in this case, the name should be the uh work flow because there's two dimensions we care about. One is the fact that there's a workflow dimension. There's also the repo so the repository repository and the value for this is uh so this is not our map. Um We'll fix that later, but I'll put this here for now. I guess like let's abstract that away real quick. Let's just abstract all this away. Look because we're gonna use that as well. Um Yeah. OK. So we have that, this is actually Lipo and this is um the name and then we have storage resolution 60 seconds. Uh and the unit we have is seconds. Finally we post the value which is just the value. Uh And I think, oh, I'm missing a comment here. Let's see. Did I get everything? All right, we need a name space. Um And I guess for now we can just call this Pulumi. Uh I don't know, like for me um build, I guess that's fine. Uh Let me call like let me what it was. OK. So I think that has everything. So let's, let's um actually add our gin up token uh which is this oops set, get a token to this. All right. And now it's looking fig and let's run pulling me out so we can see it's gonna create uh this set of things. And um yeah, I think that should be everything we need. Let's run this and hopefully see it work. Yeah, pop this person this little ul open. Uh We have great. So if we kind of follow our little thing here, um Great. So the skull got created and if we go to cloud watch, which I actually had open already, uh If we go to metrics, this is not what I made. This is a different thing. May have to refresh this. Let's see if this even ran, um, modern. It's possible. I have a bug in my code. It says it just ran, um, took 25 seconds. Ok. I guess I probably should have put in some more, um, logging there. But, ok, that's ok. Ah, there we go. It is here. Great. And it worked and so we can graph this metric, um, which obviously is not gonna show very much since it posted one data point, I assume. Um I don't see it anywhere unless it just last last five minutes. Interesting. Well, must have some data somewhere because uh it's because I'm showing the wrong thing here. So maybe it needs to have the one minute here here. I don't see. Where are we, let's look at the last 15 minutes. Expect to see a metric somewhere in here. But it's odd that, uh hasn't posted anything but clearly we posted something since, um, since the function actually succeeded. And the fact that this got created is a pretty good sign. In any case, I think I'll stop there. I think there's a lot more we can expand on here. But I think this hopefully shows kind of how easy it is to, uh actually just write some, just plain old javascript, uh type script code and then actually have it run uh regularly on the schedule um in Po using Pulumi. And hopefully, I, uh, you know, like I said, I'm gonna, you know, just using this to compute some uh metrics. But uh yeah, hopefully you enjoyed this episode and uh join us next time on Modern Infrastructure Wednesday.
---
