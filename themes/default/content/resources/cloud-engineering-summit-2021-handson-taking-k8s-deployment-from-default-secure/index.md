---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Cloud Engineering Summit 2021: Hands-on: Taking a K8s Deployment from Default to Secure"
title: "Cloud Engineering Summit 2021: Hands-on: Taking a K8s..."
meta_desc: |
    A Shodan search can quickly reveal over 17 million Nginx servers currently returning a 200 OK. One would think with such adoption that building a s...
url_slug: cloud-engineering-summit-2021-handson-taking-k8s-deployment-from-default-secure
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Cloud Engineering Summit 2021: Hands-on: Taking a K8s Deployment from Default to Secure"
  description: |
    A Shodan search can quickly reveal over 17 million Nginx servers currently returning a 200 OK. One would think with such adoption that building a secure Nginx Kubernetes deployment would be easy. Surely one would be overwhelmed with online content! Whilst best practices are in abundance and security scanning tools for helm and k8s yaml are available, it can be truly difficult to find example code or solid advice on how to successfully follow security best practices. In this session I'll start with a blank canvas of a default Nginx deployment and leverage Checkov's Kubernetes yaml scanning capability to show my own experiences with the easy, the hard and the plain confusing elements of creating a secure Nginx deployment.  Talk by: Steve Giguere
  sortable_date: 2021-10-20T23:02:23Z
  youtube_url: https://www.youtube.com/embed/ouj_0Yx4Mg8
transcript: |
    OK. Super happy to be here at the Cloud Engineering Summit. Uh My name is Steve. It should show up down there. I'm a developer advocate for bridge crew more about that in a moment. But let's let's get cracking with the subject. All right, I am going to be securing an engine next deployment for COTIS uh using check off which is an open source infrastructure code scanner. And I'm gonna try to explain why, why that is like, why, what was my challenge when I first started this? That is I needed a website. This is a real challenge for my Twitch show. Uh I was gonna host it on a raspberry pie. There's all sort of challenges I've already got here, right? And it seemed obvious to use engine. Uh The big problem I had was really just trying not to look like a total idiot because uh I work for a security company that specializes in infrastructure as code security and I have history and clouding of security, but that's what the show is about. So it would be horrible giant face palm moment if I didn't pass our own check off YAML scan. So and it was insecure. That would be bad. So, a little bit more about me. I'm a developer advocate for bridge crew. I'm a raspberry pie geek. I like to suck ups. I've worked for a bunch of places that focus on security and that's that Twitch Show is talking about. You can learn more about me at my website. Um Yeah, there we go. All right. So this is kind of some of the motivation uh is, I guess it's fair to say that engine X is popular. And um if you look up their 18 18 million uh live deployments that seem active, not all of them are containerized, of course, not all, all of them may maybe on COTIS maybe that first one is, it's on Digital Ocean, but it just kind of shows that if there's a weakness, some baddie out there or the bot is gonna find it. So I kind of feel like we should do best efforts if you don't know what show is, show is like duck, duck go. But looking for all the stuff you can't see. So it's used by researchers and baddies alike uh for good and bad things. So the problem with engine X if compromised, what could I do? Right. Well, if I took a look at the image itself, just the default image, just pulling engine X, right? Not specifying tags, just seeing what happened. I, I jumped in there and it's got some things that if you're unfamiliar with NS center allows me to execute commands in name spaces other than like Linux name spaces, other than my own, it's kind of bad there. It, it was an attack vector for a while and thankfully, there are things in place to stop that being useful curl is there. So if there's not anything, I, I basically have everything. If I have curl, I can get anything that I might be missing from an attack perspective or I can install it. So, and there's loads there. What was weird though? I noticed is that there was no PS and I thought, well, whatever I can get around that. Uh So what I can do the image can as a result, I can num the network, I can n environment, I can even break out to the host. Recently. There was a CV that was announced 2021 22 555 that uh has an exploit that you can run and exploits a out of bounds, right? That pops you out into root. I tried it, it does a bunch of stuff. If you get it wrong, you can actually the underlying node and you do all sorts of stuff with it. So interesting. And of course, I'm on an engine server so I can serve malicious content. I have control over what is being sent to other people. So that's bad. So I think we've established, let's just go to our happy place for a moment and let's get going. What's the plan? Well, step one of course was go get Engine X. I was gonna do that in a containerized form and I was actually interested recently to see that it hit number one. So I saw this graph in an article about three months ago and they were saying, oh, look, Engine engine X is almost more popular than Apache. And hey, look at that as of about June, it is cool. I'm gonna wrap it into a Kubernetes deployment. So where do I get started? This is where I put on my newbie hat. And I thought, what would somebody do if they wanted to create a web server and from scratch and they wanted to put it into communities? Well, they probably search, I would imagine Google or Duck dot go. It doesn't really matter, you get slightly different results. And so if we can do that, I can click that and it's gonna bring up search and there's lots of ads, OK? Some articles that are a little bit more in next focused at protect. Sure, great, a lot of videos. But I didn't, I, I know there's the blog actually, there's the blog that sel works. How about that? That this talk is based on. But as I went down the first time I actually got some actual code was pure. So that was a live search and it's still still there. The applications with services, this is IO documentation. That was the link I had there just in case. And here is where I get my, my deployment. And then down here, I've got an example of how to create a service to connect it. Now it serves that somebody might just cut and paste that and go. Well, that was my starting point. And I thought, well, that's what I'll do. I'll just, I'll just cut and paste. That seems good. Right? So the next step was to check that it's secure. Can I use the default image? Is it secure? Do I need to make changes to it? Do I make, do you need to make changes after I look at the deployment are my defaults and my deployment secure? That is pretty much step one or step one of securing things. So what does secure mean what when I say secure, I'm talking about, I'm gonna make a like a, a pretty old school almost info reference to the CIA what they call the try out of security, which when I say try out, it always sounds a bit weird but confidentiality, integrity and availability, generally, whatever it is you're doing can fall into these categories. I loosely here tried to map it to something that was a bit more cloud native or uh and said, all right, least privilege, immutability and resilience this, that roughly summarizes what I'm after uh in terms of security in cubes. And I tried to break everything down that what we're going to see in a moment. Now, my, my tool of choice, other tools are available was checkoff. I would be remiss if I didn't say I work at Bridge. So obviously I use check off, but independent of that, I used to use it. I just, I think it's, I think it's good. It's got lots of checks. It works for, I can also use it for Tara and a bunch of other stuff. Right. It covers most infrastructures, code languages. So why not? And it's got a VS code plug in. It's all the stuff. Great. So I'm gonna talk about least privilege in a moment. But just before I do that, I'm gonna flick over here and I'm gonna show you what I've got here. So I've got the, if I look, I've taken that index and here it is, this is exactly straight out of what we just saw on the docks and over here, I can scan it with, check off so I can type compact and quiet, just makes it easier to read on the screen and I'm going to pick out the engine dot L and I can see what I've got wrong. Now, what it's gonna do is not, not show you the things that I have passed. We don't really care about that. That would be a whole other presentation to see what we did there. And I've, I've got a few things right. Specifically about, I think it's 20 things that were wrong. Of 90 things that it checked. 78 or 90. Sounds like a good score and a test. But insecurity maybe not. Right. And we can see making sure that I have a set comm profile. I'll get into why that is uh a high U ID to avoid host complex. Making sure I have a security context. That's what I always have an issue with. There's never a security context in there by default. And that, that says, well, I'm gonna apply something that looks secure and you can take things away afterwards. We don't do that. We have a tendency to just give lots of examples that are technically insecure by default or easy by default so that we ease the friction of adoption. But I think we can probably start changing that these days. Some stuff that you might not know about like ensuring service, account tokens are only mounted where necessary you might think really uh is my surface account token mounted? I didn't do that. Yeah, it is. If you don't say not to, it is um name space. All of these things, I've gone through all of these memory limits that would doesn't CPU and memory limits and requests are like the number one always missing because there's a bit of a paradox there. How do you know what there should be? And then an interesting one about using Digest. Let's go back and I've summarized a lot of these and I've categorized them adding that sitcom profile. That's, you'd be surprised how important that is and how rarely it is done. It disables a ton of 6 44 system calls. I, I likened it to the, uh, expel, uh, Harry Potter spell. Getting rid of all. Disarming your opponent. Mount Petra reboot, rebooting the host, changing the name space, the Linux name space. There's a bunch like, well, we talked about an enter earlier quota CTL messing with CP MS, all sorts of stuff. There's tons of stuff that, that just gets rid of and that you could like, you don't need to be a white hat hacker to look at that and go Yeah, I don't want any new, I don't want any of that stuff. Uh And it's a great default defense in depth. Like a lot of these features are it doubles up when you remove capabilities like caps admin? But why not? If I can add a one liner that does this for me? Of course, I'm gonna do that right. So that's, that's right off the beginning. We can do that very quickly set the allow privilege escalation to false. You're probably thinking of course, why would I want to do that? Must, it might be a surprise to you to learn that ping uses that. So you'll be disabling ping. Why do you need ping in a container? Most of the things you might want to use that? This would disable are debugging related, uh, debugging related. So understanding that like pseudo, for example, anything that set U ID, uh you won't be able to use anymore. So keep that in mind, but it's still, it still should be a default. Don't run his route, uh, and assign an appropriate user in group id. Now that that might be harder than you think. And I'm gonna show you how I did that because engine X by default was running. I think it was running on U ID and JD 101, which is really low and actually can conflict with other things. So I had to push that out and I had to do some tinkering the docker file to make that happen. So we'll talk about that in a moment, drop all capabilities. We'll see that in a moment. There's a very, you don't have to know the capabilities. You can just say drop dash all. And then I feel like nine times out of 10, nothing will break. And that's good. Right. Then you can start investigating and learning what capabilities you need after the fact, too often back in the old days, people would actually run as privilege, which gave you weight, all that stuff, keys to the kingdom or they would add all just because they didn't want to sort it all out. So dash is a good way to say Lee's privilege. We'll talk about immutability, a read only file system. That sounds good. Why do I need to write to the file system? Typically, containers are considered to be immutable by default. Well, in my case, actually, I'm running a web server that needs to do some cashing and have attempt files. So I do need to find a way to be mostly read only at the very least. And we'll look at that unmount that service account open. If you don't specify what service account you're using, it will use the default service account. And if an attacker gets in there and get the token associated with that account, then they can impersonate that service account and abuse the rest API S from within there, which means they can start messing with all sorts of stuff. So if you don't need it, which quite often you don't, one line gets rid of that one line, one line security. That's what we like uh avoid supply chain attacks. This was the best image I can find. Sorry about that. Uh It's kind of gross, but when we're talking about what images we're using, we often know a lot of us know that we shouldn't use latest, right? But and then we'd start using, for example, in engine X, I would use 1.21 maybe that's one of the latest ones. But that still can be a problem from a supply chain attack perspective. Because if I get hold of the build environment, the ci I can build a malicious version of this, I can push it into its destination and I just tag it again with 1.21. Now, the shaw, the digest will change. But if I'm just using the tag, I'm vulnerable. Right. So let's just let's be diligent and use the tag and we'll see how to do that. It's, it's not hard, you can even do it in C I, you don't have to go manually, do anything. It's not a lot of extra work. OK. Resilience. This is one of the things that is often, well, I would even say easily avoided. I mean, understanding what readiness and liveness probes you need. This can be hard. It's not always totally clear which things how, what commands will do what. But if you can come up with those letting communities know you're alive and you're ready is great because that it'll help you stay alive and it'll help that make sure that your availability is high. Uh In the case of genetics, it is actually not that hard. So we'll see how, what that looks like shortly. CPU and memory requests and limits again. It's, it's like a chicken or egg scenario. What should they be if I don't know what they are, how can I set them before I start deploying? But the reality is so you can come up with sensible limits. It's really quite important to have requests in there because more than just requesting a piece of CPU and memory CIN looks at that as how much of the pie do you want in comparison with other running pods on this note? So it's more than just me, me, me, it's about working as a team with other paws on the note. So I will, I will put some sensible defaults in there for and we'll see what those look like. Oh, ok. So let's, let's do it. Let's apply all of these security controls to our engine X and see if we can get a clean slate on check off. That would be awesome. So low hanging fruit out of the box would be here. I can just add my name space. Yeah, I'm gonna call it Cloud in Summit and I, I really should add it here as well. So let's add it in there. That'll give me some low hanging fruit out over the box. Um I can, I add re resources right now. Let's do that. So let's do it in that order. Uh That was associated with my container. So let's add some space there and let's add some default resources. Cool. Let's talk a little bit about those. So I've got my limits of one CPU and 0.5 CP US. Maybe that's a little bit much, but I'm not running anything else on this one note. So this should be fine and I know that memory is pretty reasonable, but I can really, I can scale this way down if I wanted to uh and it doesn't really matter as long as I have something in there that is my portion of what we want. Right. I might leave my memory, I might leave my limits really high and my requests really low at the start just to be absolutely certain that I am recognized that I am part of the team. Right. So those are, that's a perfectly reasonable starting point just as long as it's there. What I can do afterwards is I can use metric server and I can do a top and I can see what I'm actually using and I can create a buffer plus or minus around that. That is what I really want to do. But let's not leave it blank to start. Great. So seeing as I'm on resilience right now, let me add the probes and you can see what those look like. Ok? But I think I'm the fastest typer in the world, right? I've uh worked out these beforehand and I typed, I actually programmed them into my stream deck. So, on my liveness probe, I'm just checking to see the engine um process is live and running and I'm doing that at a reasonable cadence and my readiness. Well, this is kind of is it actually serving up a some, some web, some of my website you'll see, I've got 80 80 here and actually I'm gonna go back and this isn't something that is being checked for. And I think it might result in a new rule is that sharing a kind of a system level port directly from the pod isn't necessarily great. I should be doing that from the service down here. So I should have a target port in there and that would make a lot more sense, but we'll do that after. So that adds up. So there we go. I've got that done now. Now let's just, let's just do another track, right? So I was at 20. What am I at now? Hopefully, maybe like 16 or something. That would be, that'd be already good progress, right? All of these, a lot of these cu limits ones, like there's tons of them, they're gonna go away. I'm not on one page yet. Darn I was kinda open. I was but I got 12. Ok. That's not bad security context. When I add that is really gonna take care of a lot of this. It, it, I I've already said this. It kind of upsets me. No, it doesn't upset me, but I think we, we don't, we don't add security context by default often enough. And it is confusing. Definitely because there's two different security contexts. There's the one for the pot itself and then there's the one for the container. So if we're looking at, for example, the pot, let's just let's do that right. Let's pop this here. So here's the security context for the whole for by default, this will be for all containers so I can have multiple containers in a pod. We know that uh I'm gonna run as non route, which is important, right? Maybe I'm already running as non route, but to specify it to communities is important. I've got, I'm gonna run as user 10, 10,014 and group 10,014. And you might be thinking, how on earth is he doing that? This is I'll at the very end, I'll end by showing you what I did in the Docker file to make that happen. And I'm using the second profile runtime default. See that that to me is a no-brainer because it does so much. And I don't have to think it's, I have to make up a profile. I can just use Docker default or runtime default and I'm gonna get a ton of good stuff from that. So just with that alone, if I save, there's nothing wrong with those defaults quite often. If you've already got a sensible user id in your container, just add that information means that I've got a declarative definition of, of security in place almost on one page. I bet eight checks were on the edge. So we're gonna add the other security context now down within the container. So let's move down here and go after our probes. I'm gonna pop it just there. All right. So what am I doing within the container itself? I am establishing that it will have a read only file system. This is good. This will cause me problems for next. And I will show you how I overcome that. I've blocked allow privilege escalation and I have dropped all capabilities. But I've been specific about net raw now. I don't necessarily think that's something you necessarily have to do because it's sort of redundant. But because I've noticed the checkup has two checks. It checks for specifically for net raw and for all capabilities. I added them both just because I like to have a clean slate. And now we're gonna be really close to the end. Yes, service account tokens under this account was covered. So the one liner that is also at the pod level. So let's go up to the top where we're doing our things with the pod. Let's pop it just here and let's get rid of that service account, auto mount service account token, false. Awesome. Right. And the last two were to do with the image. Look at that. How often do we see this like in lessons or um tutorials? They just say say um cosy tail run my ipod dash dash image equals engine X. We're not encouraged often enough to have a tag or have to be specific about it so much so that not until you get further down the line, do you suddenly go? Oh, this is bad. Like I have nothing here, which will default the latest, but I need to have something if we go and look at Docker Hub, we can see there's loads of tags here. I've got all the tags present. We're gonna have our latest and there it is. And I can actually at a glance see that this, this image is already tagged multiple times. So it's tagged this main line. I also happen to know that it's 1.21 0.3 which is, which is one that I should really, if I was using tags and being specific, I would use this one here, but that's not really what I want to use. What I want to do is I want to come in here and I want to get this information here and I want to put that in there. It is a slightly different format, but it does make sure that I'm always definitely use the same built image. It does go in there a little different. Normally you, you'd put colon, but in this case, you're gonna put it in like that with an at shot 256 and then colon version. So I think we're kind of there. That wasn't too painful. And if we're done, we're done and then I'll, then I'll, I'll end by showing you how to make it actually work because I've got my clean slate. But it's now really a bit of a tick box exercise because the reality is engine E won't be able to write to the drive and it'll just crash loop back off fail in order to make that happen. I, I do actually need to create some volumes. So I'm gonna have to do this, create some empty door volumes and then immediately above it, mount those volumes and those are the directories that I need. So I, I I've just created some temporary space. I still have a read only file system and I've solved that problem where this is actually going to run now, which is great. And then finally, the last thing I had to do with my doctor file was do a little bit of jiggery pokery here. You can see I'm installing something called shadow. The reason I've done that is because these are mod and group mod don't exist in this engine X Alpine. And that allowed me to change the engine X's identity to a decent user ID and group ID. It does some of the permissions, but it took care of the rest of the permissions down here and being a good boy, I then deleted shadow afterwards. And that meant I was able to switch to user X and work. Uh So that is essentially all the different steps I took to secure this engine X which did take some time to work out even though I just did that pretty quickly. So the key takeaways I want you to get from this is that finding secure examples sometimes can be really difficult. I have put all of this into a repo um which I can, I should have put it on here. Uh But it's in my blog. So if you Google Secure Engine, next deployment, you'll find the blog and you'll find the repo where, where all of this stuff is basic best practices can be easy if you use tools, all of those, all of those errors I found in, check off actually refer to documentation that points you to good suggestions and good best practices or even to the documentation itself. So they're available. Know that many of the defaults aren't secure and there is always an easy way to make that happen. All right. All right. That's the end of this talk. Thank you very much. Happy to take questions, more information about check off. You can find at checkout dot IO. Thank you very much.
---
