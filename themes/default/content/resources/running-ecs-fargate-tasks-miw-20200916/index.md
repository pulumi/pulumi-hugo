---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Running ECS Fargate Tasks | MIW 2020-09-16"
title: "Running ECS Fargate Tasks | MIW 2020-09-16"
meta_desc: |
    In today's episode, we see how easy it is to write an inline function that becomes an ECS Fargate Task. Just as easily, we're able to execute that ...
url_slug: running-ecs-fargate-tasks-miw-20200916
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Running ECS Fargate Tasks | MIW 2020-09-16"
  description: |
    In today's episode, we see how easy it is to write an inline function that becomes an ECS Fargate Task. Just as easily, we're able to execute that task both on a schedule and via event notifications by executing the task via AWS Lambda.  Code for this episode available here:  https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-09-16  Today's example is in TypeScript, but Pulumi makes it easy to stand up infrastructure in your favorite languages including JavaScript, Python, C#, and Go - saving time over legacy tools like CloudFormation and Hashicorp Terraform.  https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-09-16T06:50:13Z
  youtube_url: https://www.youtube.com/embed/neaV1iccI7E
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lee Zen. Today we're gonna talk about running ecs Farge tasks and just how easy it is actually to run a far gate task uh by really not having to create an image at all and, and writing some code. Um So what are we gonna cover today? We're going to cover creating a far gate task definition from a function uh like right in our Pulumi program. Uh So we're gonna write just javascript code that's going to let us uh run as a, as a, as a far task. And then we're going to do two things. We're gonna execute that task on a schedule and we're also going to execute that task on S3 object creation. So the idea here is to kind of give you two flavors of how we could, you could imagine, you know, setting up some kind of task. Um and then having that task get executed for, you know, a couple, a couple of reasons. So let's get started. I already have a, an example built uh prebuilt and then we're gonna kind of continue from here. So you can see, I I am using uh Pulumi a SX in typescript today. Uh And so we have a VPC that we've already created along with a, a cluster. This is an ECs cluster that uh uses that VPC. And then we create a far a task definition. It's a very simple definition. All we're doing here is we're basically saying um you know, just generate some random value uh for whatever reason and just log this log this to the console. And this will actually end up in cloudwatch logs with the way this is constructed. So, um by default, basically, this, this container will log to a log group that's attached to this container when we're using AWS X. So I'll show you that in a second and then I, I create a callback uh to execute this task. And so uh this callback just uh takes that task. So this is the task we defined above here. Uh And it, it runs the task. Uh This is, this is my Lambda that's gonna run. And so this is a Lambda function that's gonna get executed and it's going to run that task uh on that cluster with a count of three. So, um and then the Lambda itself will have its own logging. That's gonna say, hey, it's running the task and then over the set of tasks really. And then it's gonna log the output and then we'll schedule it so that every minute uh we do this. So I, I already, I already uh ran this um uh uh pulling program. So all of the infrastructure is already created. And we can actually see um in my console uh here, we can actually see the various uh resources that's already created. So we have the VVC along with uh the, the task, the, the, the event and everything else. So let's take a quick look at the task. Um And we can also take a quick look at the function. So first let's look at the function. So this is the task callback. Um And so that's what was defined here. The task callback. And uh the task callback is actually I'll, I'll probably make a note. It has two policies attached to it for the role. So one is the lamb the basic execution role which lets us uh execute and also log to Cloudwatch. Uh And then this also we have this EC2 container service access uh policy so that it can execute the, the actual uh uh task. So if we look at the monitoring for this and we look at the logs and cloudwatch, uh we should see uh this logging, we should say we should see running task and then done. Uh and we should see that, you know, uh once a minute. And so yeah, we see that, you know, running task done, running task done. So this is happening uh every minute per hour uh schedule uh that we defined here. And if we now go and look at the law group for the task itself, and you can see that's defined here for the counter task. Um so that this was automatically created for me as part of uh defining this this particular container, uh this particular task definition. So I clicked that, that popped this open. And so this is my counter task. If we look at the kind of, you can see these are some recent runs of this task and you see, you know, every minute I'm getting three of these. So here's 123, here's another 123, here's another 123. And if we open up these logs, we should expect to see uh exactly uh what uh the task does, which is just to log a random value. So you could totally imagine, you know, adopting a pattern like this for something like a batch job or some kind of scheduled batch job where, you know, every hour, every minute, every day, you have to fire off some set of container tasks. You could totally set something like this up where, you know, you write all your code right in here, you know, do whatever processing you're doing. Um And then, you know, simply have a Lambda that, that gets executed every, you know, on, on the minute, on the hour or whatever it is and then have all those containers fire in and just go off. Um and you can, you know, set it up so that you have three containers, you have five containers, whatever however many you need. Um And so that's kind of 11 pattern. Um The other pattern would be like we talked about earlier. Um you know, having some way to uh run the tasks on some event. And so, you know, technically the the schedule run is already an event, but I just want to quickly show how easy it is to actually wire this up to some other type of uh of event as well. So let's create a, an S3 bucket. Uh So we're gonna set up an event where every time we create a new object in an S3 bucket, we'll, we'll fire the uh the task as well. So we'll have a bucket and uh that's uh S3 bucket, let's call this uh task bucket. And then we can kind of do something similar to on schedule here. We can just say a bucket on object created and we'll say this is a uh object created. Um So this is the subscription we're creating and it takes a handler. Um And so the handler will be uh this same event handler here, this callback. And so we're gonna have to change the here. You can see the type is, is cloud wash. So we can, we're gonna change this a little bit because this, this gives us a different type of event. This gives us a uh you can see here it's an S3 bucket event versus here. Um This is an event rule event. So we're gonna accept both types of events, bucket event and we can actually kind of change this up a little bit, right? We can actually change, um uh we can, you can imagine like passing different parameters to the task uh based on what kind of event is running or, you know, for now, we'll just, you know, for the sake of demonstration purposes, we'll just log something different here. Uh Instead of changing what we pass to the task. Um But you can, you know, you can imagine uh changing some of the stuff we pass to the, to the, to the task itself. So, but we're not gonna do that. Like I said, uh here, we're just gonna do, we can, we should be able to do that. So if, um and we, we cast the uh the event as um as this particular event type. Uh And if this, you know, has, you know, some specific thing. Uh So in this case, like detail, uh then we know it, then we, we can log in this is a uh event, uh scheduled event. Uh Otherwise, um we'll do this as a check here. Uh We have this. So if it's a bucket event, then we have something else, right? So we can log this. Uh And you can imagine, um like I said, using this to help inform, you know, what we pass to the task or, you know, do something different. So, ok, so now let's, now that I think I fixed that correctly, let's run, blew me up. So this will again update the function and then actually update the, uh, should that should, that's all I should update actually and just give it a second. So it initially thinks there are three things to update because it, it may have to update the ARN, uh, for the notification and target. But, uh, in reality, um, it's being conservative since it doesn't know, uh, how that a might change, you can see it actually ends up in practice only changing, uh, one thing. Ok. So, uh, let's, uh, do our, uh, copy again to something new and we'll call this, you know. Right. So we have a new object now in the bucket and so now we can go look at our logs again. Uh, so we'll go back here, I'm here and you can see we have the scheduled event. Uh, that's because the event is scheduled and then we should hopefully in a second, uh, see our, uh, food event, uh, as well. That's a log somewhere else. I hear. There we go. So bucket event. Ok, great. So, um, we kind of see those are the two, we have both scheduled events, uh, which is expected since we have this, this scheduled thing running, uh, over here. And then we also at the same time, uh, from, from oops, uh, from, um, running our, our copy and actually let's just do that one more time. Yes. So we'll upload to, uh, bar this time. And if we go back to the console, uh, we refresh. So we pop open here, uh, should show up, see if we can schedule event and then we have the bucket event that just fired just now. So, yeah, that was, that was pretty much what I wanted to show you. Um Just how easy it is to have Fargate tasks run both on a scheduled event and also on a notification event and really just how easy it is to write Fargate tasks in line uh in Pulumi. I hope you enjoyed this video. Please make sure to like the video and subscribe to Pulumi TV for more videos in the future and we'll see you next week on modern Infrastructure Wednesday. Thanks very much.
---
