---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Building container-based AWS Lambda Functions in Python | MIW 2020-12-09"
title: "Building container-based AWS Lambda Functions in Python..."
meta_desc: |
    In this week's episode of Modern Infrastructure Wednesday, we port last week's example of using container-based AWS Lambda functions to Python.
url_slug: building-containerbased-aws-lambda-functions-python-miw-20201209
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Building container-based AWS Lambda Functions in Python | MIW 2020-12-09"
  description: |
    In this week's episode of Modern Infrastructure Wednesday, we port last week's example of using container-based AWS Lambda functions to Python.  We walk through each line of code, showing how it works as well as what's in the `Dockerfile` to build the image.  Code for this episode available here:  https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-12-09  Today's example is in Python, but Pulumi makes it easy to stand up infrastructure in your favorite languages including TypeScript, JavaScript, C#, and Go - saving time over legacy tools like CloudFormation and Hashicorp Terraform.  https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-12-09T07:35:51Z
  youtube_url: https://www.youtube.com/embed/o-_pDWaGDNw
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lee Zen. And today we're going to be covering how to build container based Aws LAMBDA functions using Python. So we actually did a very similar walkthrough last week using node uh specifically typescript in node. Uh This week we're gonna be going, going over it in Python. A user comment suggested, hey, can you cover some of these examples in Python and go uh and oh, you ask and you shall receive. So here we are covering an example in Python. So, uh yeah, we start off by importing uh some of our, our libraries that we're gonna use. We're gonna be using Pulumi obviously, uh SDK along with uh Aws and Docker um doc, you'll see why in a minute. So, uh you know, fairly simple, we create a bucket and this is where we're gonna, we're gonna go through the thumbnail example again, uh just like last time. So the objective here is to uh create a Lambda function that uses a, a uh that's based on that, that, that has a container as the underlying image uh where the container has FFM peg in it. So we don't have to figure out how to get that uploaded into Lambda as a, as a layer or anything. It just, it's just part of the container image. Um And then uh you know, we're gonna upload videos into this bucket and then those videos will get a thumbnail created uh as a as a result of that upload. So, uh yeah, we create this bucket that's gonna host our, our videos when we upload them. And then uh we're going to create a repository uh for hosting our our container images. Uh So that's, that's all these first two lines are doing. And then we uh grab an authorization token from ECR and we use that to feed into this image, uh this image resource. And what this image resource is doing is you can see it, it has a build parameter and this is taking uh this is an actual a context we're gonna build. So later on, I'll show you this uh doc context, this exact same one I showed last week. Uh But I, I'll show it, I'll show it briefly here as well. And then we, we give it the image name which is just gonna be the, the URL, the repo and then uh the registry information. So here this is where I need the credentials where I need the user name and the password that we can actually, you know, dock or in to push our, our image. Uh after that. Um So you kind of, you know, at, at that, at this point in the program, what will have happened after we run pulling me up is we'll have created the bucket, we'll have created the rebo and then we will have pushed this image um into that, into that rebo. Next, we want to create the function that's based on this image. So we create a role uh in a policy attachment for that role. So you can see we're using, you know, very simple assume role policy here. Uh And then actually here kind of showing off some of the new uh enum support we have across all our languages. Uh So this is enum is projected into all of the languages. Um And it's, it's, it's available uh in C# and go and, and uh Python here and obviously uh node as well. So we get to use this, which is great. So that's a nice convenience. Uh So here we're using the, the full access managed policy yarn. And then we finally create the function uh specifying the, the image package type along with the actual image name, which is the full uh fully qualified URL for um the image that we uploaded earlier. So combine all that together, we have this function now. And the final thing to do is to really just wire up that lambda function we created uh with uh S3 bucket notifications. And this is also fairly simple uh all we're doing here is first giving permissions uh for the bucket uh to invoke the function. And so here you can see we have this, this, this permission that would allow it where we allow uh invoke function from the S from S3 uh from that bucket that we created as the source. And then, you know, it's going to invoke this function that we've just defined and then we have to define how we actually want to uh invoke. And so we create this bucket notification and in the bucket notification again, we provide the bucket that we're actually going to, to invoke from uh along with the functions that are gonna be invoked uh off that notification. And so here you can see uh we give it this, this uh function arm and then we give it this event, this is for object creation uh because, you know, obviously we care about uh any videos that get created. And then we, we filter on uh this MP four suffix. Since we're looking for specifically video files, we as a, you know, just because it's easier, we, we actually write J pegs uh into the same bucket. So we ought to obviously wanna make sure we're, we're not uh infinitely recurs on ourselves. And so we're, we're just um just looking at the uh the video files and uh this depends on uh having this permission obviously. So we have this explicit uh dependency we define here. So that's, that's how this all gets this wired up and then we finally export the bucket name for convenience. Uh And so I actually ran this earlier, so I ran Pulumi up. It provided all the resources, you know, shoved them all into uh into Aws. And uh when I, when I run, you know, this copy of the sample file uh into um into the bucket, if I show uh the output, this is running Pulumi logs, I'm just tailing the logs uh from cloudwatch. Uh And you can see here this is the thumbnail or task or, or function that's getting invoked. Uh And here it's copying the file from S3 into the uh temporary directory on, on the container. Uh And then uh it's, it's running FFM peg to extract that image. So you can actually see this, this new uh this, this thumbnails is getting, is getting saved here and sample that J peg. So you can see here it's copying it as well. So let's actually copy this locally and see that it actually worked. And if we open up that sample there is the thumbnail. So, and this is a video of a waterfall. So great success. It all worked. Uh I mentioned, I would take a quick look at the uh the actual, the Docker built context here. Uh And this is just the Docker file uh exact same one as last time. Uh didn't touch anything here. So actually one of the cool things that I'm showing here is that we authored our polluting program in Python. But our LAMBDA function and the Docker file that you know you can see is building off this node Js uh based LAMBDA image. So actually the the function is written the LAMBDA function itself is still written in in node. And so here, you know the critical line here, we're installing FFM PEG uh and then copying it uh copying this, this uh this actual function handler and the function handler is very simple. It's really just shelling out to copy to S3 running FFM PEG and then uh copying the result of the, the thumbnail file back into S3. So yeah, really, you know, again, uh it's super easy to get running with uh Pulumi. Uh and it's super easy to use Pulumi to, to create your uh container based uh lambda functions uh in AWS. So hopefully you enjoy this video uh as as as always love to hear your feedback, please leave them below in the comments. And if you like this video, please make sure you, you like hit the like button, make sure you subscribe to Pulumi TV for more updates. And yeah, like I said this, this was the result of uh a viewer feedback. So open to more feedback and, and willing to make more videos that you guys want to see. Thanks for watching and we'll see you guys next week.

---
