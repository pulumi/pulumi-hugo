---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Static Website Failover using Route 53 DNS | Modern Infrastructure Wednesday 2020-06-17"
title: "Static Website Failover using Route 53 DNS | Modern..."
meta_desc: |
    In today's episode, we are exploring how to use Route 53 DNS Failover to provide site availability. Code for this episode available here: 
url_slug: static-website-failover-using-route-53-dns-modern-infrastructure-wednesday-20200617
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Static Website Failover using Route 53 DNS | Modern Infrastructure Wednesday 2020-06-17"
  description: |
    In today's episode, we are exploring how to use Route 53 DNS Failover to provide site availability. Code for this episode available here:  https://github.com/pulumi/pulumitv/tree/master/modern-infrastructure-wednesday/2020-06-17  The examples are in Python but Pulumi makes it easy to stand up infrastructure in your favorite languages including TypeScript, JavaScript, Go, and .NET - saving time over legacy tools like CloudFormation and Hashicorp Terraform.  https://www.pulumi.com/docs/get-started/?utm_campaign=PulumiTV&utm_source=youtube.com&utm_medium=video
  sortable_date: 2020-06-17T05:55:32Z
  youtube_url: https://www.youtube.com/embed/sO2RK-H-p1M
transcript: |
    Hello and welcome to another episode of Modern Infrastructure Wednesday. I'm your host, Lee Zen. And today we'll be talking about a topic mere and dear to my heart site availability with DNS fail over. It's a, it's a long mouthful, but it's really quite a simple concept. We want to be able to have our site to have a fail over option. Uh ideally like, you know, in the worst case, a static website to at least uh display some information uh in case something goes wrong with our website, uh in case something goes wrong with our, our main, our main system. So uh what we'll be covering is building that static website that fail over site and then how to set that up with DNS fail over. Uh This. Yeah, like I said, this topic is really near and dear to my heart since I was actually on the team at aws that uh originally helped build this feature. So let's let's get into it. Uh We're gonna start here with some pre-built stuff so we can kind of skip through some things. Uh We create, we get an A uh from AWS. Uh We choose a size. Uh And then we create a security group to allow uh ingress on port 80 uh set up a super simple web server here. Uh spin up an instance and we create that instance, create a health check for it and then set up a set up a RAV three record to point a domain name uh at that IP. So basically, all we've done so far is basically uh create this instance running this very simple uh startup script. And then we have our, our health check, checking the IP and then we have a DNS record pointing at that IP. And so at the end of it all, uh we should be able to curl this record and get back the uh server response. So we can do curl fail over dot dot TV. And we get hello world uh as we expect. So now let's go ahead and, and set up our uh fail over site and uh to do that, we first create a S3 uh uh website. Uh And we'll do that with an alias record. So first let's create the site. Uh So we'll go up here and do it and we'll say this is the uh fail over, that's three side uh bucket. Uh And we'll make a L BS S3 uh bucket. Um And we'll call this like fail over bucket. Uh And uh let's check what we need here actually. Um So if we go to the docks, go to S3 and bucket, so we can see to remember all the right arguments. Um So we actually have to name it right. So we need to name it the same thing as our site because that is what helps with the routing. So we'll call it Bao dot Pulumi dot TV. And if I recall correctly, there's something in here like uh uh website, uh domain. Um And so we need this as well. Um And uh the end point which is gonna be uh index dot HGL. And we're also gonna stick obviously an object in there uh for um uh index dot html. So let's, let's try that. Um Actually, sorry, we don't need, we don't need this. That's, that's an output. Sorry, I take that back. So I think we should just need these things um If I recall correctly. OK. OK. So let's try this. Um Still run for me up. Oh, and I, I forgot to create the, the uh the site. Sorry, let me do that real quick too. So let me touch the next and we have to create this bucket object. So we'll call this the uh object and uh let me just double check the stuff there. Uh And so here it's the bucket we have to put it in. Uh And then the content, um in our case, we can actually just use uh I believe the um uh we can just, we can actually point to a source and this could be a plum object, so we'll do that. So, uh, here it's gonna be bucket is, uh, fill over S3 bucket dot uh Lady, uh, I believe to go look at the, uh, it's the, it's the name, so it's actually a good name and then we can give it the source and that's going to be a gloomy, uh, file assets and it's gonna be indexation. Ok? And then we're gonna edit index dot html and we're just gonna put some things super simple in there. Uh We'll just have, you know, html uh party. Oh, no. Right. Because this is the fail over site. So that's, it's not good if we ended up there somehow. So let's, let's uh plu me up that, oops, there's no attribute name. Uh I believe it's uh now what is it called? Why is my memory so bad? Uh Oh, it's just bucket. OK. Silly thing. Oh, and I, yeah, I had it right here. So, yes, we could just, I could have just done that. OK. So, uh now we have our, our object there and we can actually test to see if that works. Uh We can actually uh curl um uh website. Let's see. I remember the web S S3 website URL. So uh set end points. Uh So it's bucket name S3 website region. OK. So let's try this. So it's uh uh fail over dot bloomy dot TV S3 website US West two, uh Amazon here a second. Oh, no website configuration. OK. So I think I actually did need the uh additional thing here. Website. Uh What was the configuration website, domain uh website. OK. Uh This is what I was missing. I got this website. So actually you don't need any outfit. This is actually wrong. This is the out. So I need this website and then I need the index documents. Is this right? Uh Let's see. What is it like about this? Oh, and this is, this is this? Oh, well, I'm, I'm in Python. I keep thinking I'm in node uh when obviously I'm not. So that's, that is why uh OK. So now we have that uh that's the key and uh then we have the value. So let's try this. So that should change our bucket configuration. You can see we add the website. So, yes. OK. So now that we've done that we can actually now do this. Oops. Oh And uh Right. So now it's configured but we didn't have this uh this bucket object uh set for public greed. Uh Nor do we have this site set for public greed. So let's do that. So kind of like uh uh so ac L right? So we should uh set that to uh public read uh if I recall correctly, that's the correct term. Um And then also on this, we want to set the object ale uh And then also you can see speed. OK? Now, let's try that. Oh And the key does not exist. Oh Because they did not give this a um I didn't give it a name so you can see uh we actually need to uh give it a key otherwise it's not gonna put it in the right place, do that. OK? Sorry. A little bit of bumbling here. But I think we'll have this uh static site up and running in no time now. So we'll place this object put in the right place. And now when we query this record. Oh No. OK. So that's now, now we're good. So, so now we have our two things set up. We have both uh we can, we can curl fail over dot Pulumi dot TV. Uh that gives us hello world and we can also uh have we also have to set up. So now, what we have to do is configure uh this bucket to be our fail over option for um for this, for this record. So that's actually very easy to do. Uh We can create, let's rename this variable to uh serve a record and we'll also create a fail over record. Uh We call this the secondary record actually, let's let's be consistent. Let's call this primary secondary and this will also be a rep three record. Uh But this will be our fail over target or let's call it the S3 uh record. Um And the name is the same. So you can have multiple uh records of the same name and uh the records here, so you can see, we can, we can set a primary record, uh sorry records. Um And here we're going to have an alias. So if we go back and look at our resource records, you know, we can look at how we set up an alias and we're gonna do that by uh uh actually just having aliases instead of record. Um And so we'll do aliases and you can see here, uh We'll just have this one target for this, for this thing and it's gonna be um the name and the zone id. And so this, this comes from actually our bucket. So this is gonna be the uh fail over S3 bucket here. And that's where we're actually going to get the uh website domain. So you can see this is used to create RD three records. So it's website domain and then the zone uh here we need to have the zone id. It's the uh same thing. Uh But in this case, it's the, it's the as zone, of course. So we'll use that, OK? And then the other thing we need to do is actually set these up to be primary secondary. So right now, uh they don't have any routing policies attached to them. And so we want, we want to have routing policy so we can have both these records. And so we go back to resource record. Um There's these routing policy things we can do. Um And so if we take a look at uh this, we want a fail over routing policy. And so we'll set that up and it's actually very simple, just a primary or secondary uh policy. So, um and the type is simply uh primary and then we can copy this and place it here and here this is the secondary. OK? So let me run Pulumi up here. Yeah. So this is gonna update our website configuration. So we got assuming I got everything right. And you can see now we, we have two records of missing property type I Oh, here. Yes, I need a record type. This is a a, this is an a alias, of course. Um The other thing I forgot to do actually, I just realized is this has no health check associated with it. So I need to also to do that. So um you can see we can associate a health check ID. So this is the health check ID and that's actually equal to uh we created a health check earlier up here. HC. OK. So now we can do this. Oh, and I'm missing. Oh, silly me, I'm missing in this guy. OK. So I think hopefully I got all the type errors figured out uh required. OK. Right. So I need to evaluate target health set up correctly on this and really evaluate target health. Here is kind of uh meaningless. Um because the S3 health is always going to be like true with like S3 generally should not ever evaluate defaults in terms of whether it's up or down. But let's just uh do that. And so you can see we are creating this additional alias record uh that we're sitting here and then we're also updating this to include a failure writing policy. And so we created those, oops, oh I right. set identifiers. So, right, when you have multiple records, you need to have set identifiers. Um And these are just really just tags basically to let raft three differentiate between the two, the two different uh the two different records. So let's do that. And you, you, you might wonder like, OK, well, it's kind of silly like this is already here, but uh the red policy doesn't really set the set identifier like the set identify is additional identifier on the key effectively uh for 53. So you can, you can definitely blame me as one of the people who uh was there when we made that decision. And what did I miss this time? Her building change set? OK. Because I, I'll wait for this to air around. I wonder if I missed a additional parameter here. So it's a alias 2 S3 have the zone id identify a secondary and marked as a secondary as a non fill over R. So with the same name and type already exist that's odd. Oh, I wonder if, um, it's actually pretty interesting. So I think, I think this was like an ordering issue where, uh, because I was trying to update an existing record, uh, I updated this, which was not set as primary yet. So it tried to create this one as a secondary, uh, record. Uh, but before I had the primary record. So I think if I just run to pull me up again, uh This should just work uh if I understood reading the error correctly. So I think it, it didn't like the fact that I think it tried to create this first. Um uh before um it had the other one. So I think this should just work. We'll start to find out. Yeah, if, if I read this, if I read this this way, it's, it's basically saying like the other name wasn't a uh wasn't a fail over uh record. Um So I didn't like the fact that I was trying to create a secondary without a, a uh primary first. So I should have actually, uh because I was making that change in the same change. Like you can see this, this change, this, this record didn't have a depends on, on this record. Uh So kind of like the correct way to do this would have been to include an additional option um Here where I have ops and then I would have, I would have included a depends on, on the uh on the other one. But ok, so we, we kind of uh went through that. And so now if we, if we curl uh server dot uh sorry uh fail over dot plume dot TV, we should still get our hello world uh website because it's succeeding. And uh we, we can actually go look at our health check in the rep console and you can see it's, it's healthy. So things are, things are working the way we expect it to. So now let's go ahead and fail our health checks. So let's, let's, let's maybe just turn off this uh security group. So let's um, let's not allow, let's change this to like, you know, uh not allow ingress from port 80 to some other port. We'll just like maybe we'll just, I don't know, comment this out. So we just remove the security group. They actually not sure it's gonna like that. So maybe, maybe it's actually easier to just change the security group to be, you know, from port, I don't know, 80 80 to port 80 80. And this will fail our health check, right? So let's, let's do that. So we're gonna change the security purposely so that we can't access the site anymore. Ok. So now let's, let's try curling the, the IP directly and you can see like, you know, no response, it's gonna time out. Uh The only reason I'm showing this first is because I'm waiting for DNS to kind of update and respond. Um, so now if we try to curl, uh, the site again, it's timing out. Uh, it's because we had att L of, I think, uh, 60 seconds, 05 seconds. And our, our health checked fail over was, uh, let's see, at 10 seconds. So maybe if we wait, uh, a few more seconds, let's dig this and see what we get. Ok. So now we're getting a different IP because it's, it's a 52 address, whereas before, um, the public IP was 34. So it's, it tells us that we've actually failed over. So now if we do this, oh, no. And so now we're actually using the S3 website bucket, uh, that, uh, that we had set up earlier with our, with our index dot html file in there. And so now we're actually getting the fail over response where 53 s health check has detected that the website is unhealthy. So, if we refresh this, uh, you can see it's, uh, it's no longer healthy. Oh, wait, why is this? It's interesting. The, the website is not even showing the right thing. Let me refresh this. Oh, here we go. Yeah. So unhealthy. Right. So, now it's unhealthy. Uh, I wonder why this refresh didn't do that. Uh, so it's unhealthy now. And so that's, that's also why we're failing over and we're getting the site that we wanted to. So, yeah, hopefully this was a cool tutorial for you. Um Very easy as you can see to set up uh just to refresh kind of what we did. Uh Let me get rid of this stuff. We started off with a very simple website. Um That was just an EC2 instance uh with the health check on it. Uh Just serving something super simple from the uh the data. So let's put this back and see how that fail over works in action. So, you know, there's with no action necessary. Let's just undo our little thing here. So let's assume the website became healthy again. Um We'll see how it comes back. But yeah, so we just created this instance. Uh And then we had the health check and then we had the record point to it. And then all we did was, then we created a S3 bucket with a SIM with a single index document inside it to act as our uh fail over static website. Uh you know, in case things went wrong. And then when we failed the site, uh kind of, you know, the health check and 50 threes fail over, took care of the rest. And we were able to uh put up our, our little uh you know, uh failure message. Uh you know, and you can totally imagine kind of having like a, a stripped down version of your site that helps uh customers understand what's going on or, or perhaps still gives them some level of functionality uh rather than nothing at all. So, let's see if, uh, I talk long enough to have this, uh, health check refresh. Ok. It's still reporting as unhealthy. So it typically takes like 10 seconds, um, since it has a health check interval of 10 seconds and, uh, then it pro it requires multiple checkers uh to report back as uh healthy, oops, check this person out. Uh, so you can see now it's actually succeeding. Ok. Ok. Ok. Ok. Across the board. Um So if we, if we refresh this, we should see this as uh as a, I don't know why this U I is weird, but you can see definitely here. It thinks it's healthy again. Um And so if we, if we, if we curl, uh if we curl uh fail over dot Bloomy TV, once again, we're back to the Hello World. All right. So, yeah, I hope you enjoyed this episode. Uh Please subscribe uh and like the video and we'll see you next week on uh Pulumi TV. Thanks for watching.

---
