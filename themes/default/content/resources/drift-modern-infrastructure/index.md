---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Drift | Modern Infrastructure"
title: "Drift | Modern Infrastructure"
meta_desc: |
    In this video, David walks us through the different ways in which a Pulumi program can help reconcile drift: from the command line, to CI/CD with G...
url_slug: drift-modern-infrastructure
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Drift | Modern Infrastructure"
  description: |
    In this video, David walks us through the different ways in which a Pulumi program can help reconcile drift: from the command line, to CI/CD with GitHub Actions and CircleCI, to Kubernetes with the Pulumi Operator.  Want to propose something for us to talk about? Drop a request in the comments or head to this GitHub repo to add a topic request or vote for your favorite with emojis: https://pulumip.us/pulumitv-github  Watch the whole Modern Infrastructure series at https://pulumip.us/modern-infra  Learn more about Pulumi at https://pulumip.us/home
  sortable_date: 2022-03-23T18:00:48Z
  youtube_url: https://www.youtube.com/embed/7nJBFEtqTl8
transcript: |
    Hello and welcome to Modern Infrastructure Wednesday A TV. My name is David Flanagan. Oh, you may know me from across the internet at rock today. I want to follow on from my awesome colleague, Laura who introduced you to the concept of infrastructure drift and the latest quick bait video. Not seen it. Click here. Now, let's see how poli can help us with drift by taking a look at a few examples. And let's use an example from everyone's favorite infrastructure book with three little pigs. No Poli provides a flag dash dash refresh that allows the state of the world to be refreshed before building a plan for what Pulumi needs to change without the refresh. Polymer relies on its existing snapshot of the world and really only updates things when the polymer program changes. The challenge here is well covered by Laura, but I'll quickly recap. If there are no external factors that can modify the state of your plum created resources, then you don't need to refresh. Of course, if you think this is actually true, I'm either extremely jealous of your setup and infrastructure or you're playing face lying to yourself. Either way reach out. I'd love to chat with you. If external factors are a concern such as click happy engineers and cloud portals, cu control malicious actors or even cosmic rays, then you'll likely want to ensure that your preliminary program refreshes the state of the world with a cadence. That makes sense for you. Now, let's get back to our three little pigs. First. We have the House of Straw. This is your first step and to reconcile and drift and your infrastructure and that's just manually running Plu Me up dash dash refresh. This is definitely the easiest way to get started. And depending on the wealth in your domain could be a perfectly valid solution. If you're a solo developer working on a side project done, forgotten your Aws credentials and can actually log into the portal and only have an EPA token left locally. Sure. So let's take a look at Blew me up dash dash refresh here. We have a Pulumi type card program that creates a digital lotion spaces bucket as well as a digital lotion spaces bucket object. If we jump over to the command lamp and run Pulumi up, it will create both of these new resources. Also, if you run off again, it tell us there's no change. Now, if we move over into the spaces you, I refresh the page, we'll see we have our new space and say the space, we have our object. Now as a random team member making a little bit of a mistake. We're gonna delete the second. And if we come back to Pulumi and say, hey, run, pull me up. It says, hey, we're good man. And that's not the case. Now, we can add dash dash, refresh to the command to have Pulumi look out to digital lotion and make sure that what we want is there and if it isn't reconcile. So we run the P let me up refresh. It tells us, hey, we actually need to recreate this object. We say, all right, go for it and it's done. We come back to our space. We hit refresh good and you OK? Next up the house of sticks, you're probably no longer as below developer and there are other people or other teams involved running plume up dash refresh on your machine isn't going to cut it anymore because others can commit to your repository and you need confidence that they won't forget to update the stack. And this is where we layer in continuous integration using Janken get actions, circle the eye or your Bell tool of choice using workloads embedded in the repository. You can ensure that whenever the code changes your stack changes. Perfect. Let's take a look at this. So for integrating plume into your continuous integration system, I'm actually gonna lean on real world example that I use in my own infrastructure. What we have here is my Rockwood dash Rockwood repository on github dot com. And I have a preliminary project called infrastructure which has its own github actions workflow just available in dot github slash workflows slash infrastructure dot yaml. What you can see here is that we actually run this on a daily cadence where it's a con scheduler that runs at six minutes past six, every single day. Not only that we run it whenever code is pushed through the repository that affects the main branch and my infrastructure code. So we have two different ways to do continuous reconciliation to get help actions. And we're using the PLY action, which is really, really a breeze and easy to use. We say use poly actions version three. We want to run a PMI up, we provide the stack name, production or whatever you need it to be. And we include a refresh to ensure that we're refreshing the state of the world every time we run this up looking for that infrastructure drift. And there we have the preliminary access token and that's all it really takes. You can integrate Pulumi via gaub actions. We're using the action and just a few lines of Yaml, we also have a circle C I orb. So even if you're not using gaub actions and you're using circle C I, then you can go to Pulumi slash circle C I on github and you'll see the instructions to do something very similar using the ARP. No, it doesn't matter if you're using circle, I got have actions Jenkins or anything else. There's always a way to pull Pulumi in and run it to reconcile. Drift on a change of your plum program. All right. Finally, the host of bricks, those things are getting pretty serious. We really need to protect from many of the external factors listed previously. So we need a better system than waiting for a push to men. We need real time reconciliation and I'm going to show you how I would do this with our Cooper Netti operator. But if you're not, if you're not using cober nets, I will discuss some alternatives after let's take a look at the operator approach. The first thing I'm doing is storing the stack state inside the cluster just using a directory within the pod. So I'm just setting up the stack secret as it's secret. Next, we have to defend the stack itself. So here I'm calling that my production stack and uh I'm passing in are secret as the state pass rates. Next, I'm telling it to use the drift stack with a fail back end and I'm pointing it to my project repository. So this is my infrastructures code on github dot com at rock code slash ballum dash operator dash digital solution. This is the exact same code that deploys the digital otion space with the digital solution space object. Here, I'm telling it that as this stack is created within the COTIS API to delete those resources. We also need to enable continued rethink on commit match. What this means is that we set up a rethink frequency of one minute and there have been no changes to the get repository. We still want to tell it to rethink and that's why that's then when the commit matches. Yep, still check things. We also pass in a refresh dot True. This is very similar to what we were doing on the command line only. now we have a control loop within another system that will run on a 62nd interval to ensure that the state of the world and what we want is reconciled appropriately. If we jump over to digi illusion, you'll see that we have our space here. And all I'm going to do is delete our object like we did with the previous demo. And then no, at some point within the next minute, this will be recreated and this could either be the longest minute or the shortest minute of my life. All right, we'll just wait 30 seconds before I go refreshing again. Has that been 30 seconds? Hurry. So without me touching any dials, knobs command lines, anything our control loop within our cluster, the Pulumi operator detected that our file was missing and reconciled it, given us exactly what we need. All right. So that was, there are many starting materials to build a house besides brick, such as concrete, timber, stone or even iron. What it comes down to is that it really depends on the external pressures. Our house needs to stand up to perhaps cabernets isn't the right approach for you. So what are your options? But those are automation api you could check your preliminary program as a binary that has a built and reconciliation loop. This control loop could be tailored to your environment by running in an infinite loop with a sleep for 5 30 or even 600 seconds before checking and refreshing the world. But it could also be smarter than that. It could run as a blocking network server that receives real time events from your AWS auto filters and matches for managed resources or tapes and then performs a stack up it. When you understand your constraint, you can control the reconciliation and our automation API is the perfect tool for that. We'll be covering more examples of the automation API NS context and future modern infrastructure videos. I'll include a link below when it's available. Well, that's that I hope you found this useful. Let us know by clicking the link button, leave a comment and maybe even subscribe to our channel. We want to help you be successful with Pulumi and we hope you found this video useful. See you all next time.

---
