---
preview_image:
hero:
  image: /icons/containers.svg
  title: "Securing Deployments with Policy as Code | AWS Immersion Day"
title: "Securing Deployments with Policy as Code | AWS Immersion..."
meta_desc: |
    Poorly configured cloud infrastructure can be an unwelcome source of security, reliability, and cost issues. In this session, the Pulumi team will ...
url_slug: securing-deployments-policy-as-code-aws-immersion-day
featured: false
pre_recorded: true
pulumi_tv: false
unlisted: false
gated: false
type: webinars
external: false
no_getting_started: true
block_external_search_index: false
main:
  title: "Securing Deployments with Policy as Code | AWS Immersion Day"
  description: |
    Poorly configured cloud infrastructure can be an unwelcome source of security, reliability, and cost issues. In this session, the Pulumi team will show you how to enforce best practices by creating policies that scale from a single infrastructure stack to your entire organization. From properly secured S3 buckets to mandatory resource labels, Pulumiâ€™s CrossGuard capability helps you to prevent defective configurations from reaching production.  
  sortable_date: 2023-03-08T14:00:35Z
  youtube_url: https://www.youtube.com/embed/mkt1_0q1xc0
transcript: |
    My name is Josh. I'm a Solutions architect here at Pulumi. Uh, with me is Marina Maria. If you want to introduce yourself to the folks again. Yeah, for somebody who just joining, uh, I'm Partner Solution at E AWS and I work with our, uh IC partners on technical aspect of relationship. So, uh, if you're going to follow along, uh, there's some prerequisites that you'll need. In order to, uh, in order to complete this workshop, you'll need an aws account. Uh, you can get a temporary account that will be good for the next, uh, 70 hours or so. Uh, that should be on the handouts tab, you'll need to supply the event engine hash ID. And that is, uh, the sticky, uh, the sticky thing in the, in the chat, um, starts with a 55. So, uh, if you go to Event engine and you enter that hash ID, you'll be able to create a temporary Aws account. And, uh, if you don't have one already, uh, you'll also need, of course, Pulumi, which is the tool that we'll be using today, uh, to do policies code. Uh, you'll also need Python 3.9 or later. And uh I neglected to add to this slide, you'll probably want a Pulumi account as well. Um So just a little bit uh about Pulumi. So what is Pulumi Plumy is an infrastructure as code tool, although we'll be exploring its policy as code capabilities today. Um Essentially what plume uh the, the things that make Pulumi unique in this space are that you are able to use real programming languages. Uh Pulumi supports a pretty wide range of the most popular programming languages out there. Uh We have support for uh nodes uh being typescript and javascript uh uh Python C# go. Uh We have java support that is in preview. Uh And we also have a YAML option as well for folks uh who might prefer that you can use Pulumi uh with a wide range of uh cloud back ends including of course aws. Uh But we also have like a, a KTIS provider that a lot of folks enjoy using uh as well as integrations with uh a number of SASS tools uh such as data dog, new github, things like that. Uh Pulumi is open source. Uh Most of the stuff I'll be demoing today is available in the open source version. I will uh be sure to uh call out directly anything that is a paid option and that'll be like the last part of this workshop. Uh But you know, Pulumi is open source and free to use. We also have a, a uh back end what we call Pulumi service. Uh And uh we would uh we'll get into some of those features a little bit later. We definitely encourage everyone who's following along to create an account at Pulumi. It is free uh for individuals, for individual use, it's free forever. Uh So that will allow uh the plume service will provide you with like state file management, uh secrets management and unlimited updates and it uh is free forever uh for individuals to use. Uh If you would like to try out some of like our, all of our features, like the enterprises of enterprise features uh that we call our Business Critical Edition. You uh after you create an account at Pulumi, you can create an organization and sign up for a, a two week free trial. Uh That'll give you again all the features that the Pulumi service offers and there is no credit card required. OK. So what is policy as code? Um So some of you may remember that at one point, the term de setups uh became really popular. And so like if DEVS is um largely about bringing like software development techniques into the operation space dev set ups and policy is code brings that extends that to like security and compliance. So when we're doing policy code, uh just like infrastructure is code, um you know, we are using, we're writing essentially software and uh so we get all the benefits of describing our policies in software. Uh Our policies are going to be repeatable. Uh They're going to be viable, it's gonna be an automated process to check compliance. And so that's gonna be really fast and accurate. Um In addition, when we are doing policy as code, there are two essential types of controls. There are preventative controls and detective controls and preventative controls are uh policy checks that execute before we actually provision infrastructure and the majority of what we're going to be showing today uh with Pulumi uh are preventative controls. In addition, there are detective controls. Uh So like if any of you are familiar with Aws config detective controls um will uh verify infrastructure after it's already been provisioned. So you might create an S3 bucket and then a Aws configure will fire and check whether or not that bucket is in compliance with your organization's policies. Uh And so each of these types of controls have different advantages. Uh for preventative controls, you typically have to like execute those controls through a pipeline. And if you're ever, you're doing everything through I AC, then that's going to catch the overwhelming majority of any noncompliant infrastructure. Uh And so like these preventative controls will also give you fast feedback. However, um detective controls, so you get, you know, slower feedback because you have to wait for the actual infrastructure to be provisioned before you can check it. However, it will check everything because even if you create those resources, not through a normal process, like your I AC pipeline and you create it through the console, that infrastructure will get checked. So um let's move along. So uh examples of policies uh that we might want to create uh if we are in a regulated field, let's say that we are working in health care. Uh We may want to ensure that our uh infrastructure is only using HIPA compliance services. And so we might want to write a policy for that. We might want to have policies around uh data loss prevention. So you might wanna have backups, ensure the backups are turned on. Uh for R DS instances in your production environment, we might have rules around data security. So we might want to ensure that uh our S3 uh that we have encryption at rest turned on. Uh For an example, we might wanna create a rule for network security. So we don't wanna allow SSH access from uh from all IP addresses. We might want to have uh tagging rules that allow us uh to, to ensure that all of our resources have correct cost attributions. So this EC2 instance belongs to the accounting department and this S3 bucket belongs to our analytics team, things like that. And likewise, we might want to have budget control. So like we might want to ensure that in dev environments, we're not spinning up like really heavy EC2 instances. Uh And that we only allow that in our production environment. So uh Pulumi policy is code tool is called cross guard. Uh And some of its features are that you can write cross guard uh policy packs in either typescript or Python. You can also write them in javascript. So essentially node or Python, uh you can use a policy pack against Pulumi infrastructure that is written in any language. So even if your infrastructure is written in, let's say, go lang uh you can run any Pulumi policy pack against that infrastructure because it works off of uh you know, this abstract uh Pulumi, it basically works off of like, like the Jasons kind of generated behind the scenes rather than uh the, the running code itself. Uh Pulumi individual policies have uh configurable enforcement levels and we demonstrate all of those uh just uh pretty soon those uh enforcement levels. So uh they can be mandatory which will fail the Pulumi command and prevent any, either the preview or update from going forward. Uh They can be advisory where they essentially print a warning uh or they can be disabled altogether. Um Likewise, we, the Pulumi policy packs have a shortcut that will allow you to set a default uh enforcement level for all policies in the policy pack, there are two types of uh uh policies that can be created, there are resource based policies so that would execute, for example, against a single S3 bucket. Um And so that and those execute pre deployment. So those are the preventative controls that we described. And that is the majority of what we'll be showing today. Uh possibly the entirety. Actually, I think it's the entirety. Uh In addition, there are stack validation rules uh which will work against an entire plumy stack. And so like an example of Pulumi stack, you might create uh within a stack like a VPC, uh some EC2 instances and a load balancer. And you would put all those things together in a Pulumi stack. The stack validation um policy will validate all the resources in the stack at once, but those generally happen after the deployment. So those are a little bit closer to like the detective rules that we described. Uh So within Pulumi policy is code solution cross guard. Uh The open, just pure open source uh will allow you to uh consume any existing policies that folks have written out there because those are just uh essentially Python or uh node libraries. Uh You can author your own policies and you can uh you can do de uh self managed policy integration. Um And we'll demonstrate that later. But essentially when you run a Pulumi command, you can supply a list of policy packs that you want to run against that command. And so that will validate your infrastructure um in our page features. Uh You can publish policies to the Pulumi service uh and you can configure them via the U I within the, the Pulumi service, uh you can establish policy groups. So you can essentially say um all production stacks have to comply with this production policy. And then those that po those policies are enforced uh automatically when you run Pulumi commands by virtue of your stack being a part of the organization. Uh that might sound a little esoteric, but we'll, we'll demo that later and hopefully it will become clear. All right. So let's get started with some code. Uh So folks who are following along at home, uh We are going to start with module one. So the first thing we're gonna do is create a directory. OK? And we're gonna change into it. Uh We're gonna make a couple of directories here. So we have an Infra directory, which is where our Pulumi program, our infrastructure is going to go. And we also have a policy directory, which is where we're going to be offering our policies that work against that infrastructure. OK? So now I'm going to change into the info directory and I'm going to initialize a new Pulumi program by entering the command plume new A Os Python. And we're gonna give this thing a name, workshop policy as code. OK? So we're gonna accept the defaults here. Stack name of DEV already exists, unfortunately, because I forgot to delete that. So we'll make a DEV two. That's fine. And uh when, if you were following along at home when you get to this prompt, just pick the region that's closest to you. Yes. Each one should be fine. All right. So this is gonna download and install some Python dependencies and Sting Gr PC always takes just a little bit more time. Uh Maybe while we're at it. Uh I'm gonna skip around just a little bit and I'm gonna initialize a preliminary policy here. It's gonna do its thing and hopefully your R PC. Yep, still installing in the meanwhile, in the chat. How are folks doing? And you see any questions? I, I posted the link to workshop guys if you like. It's very easy. Very, thank you, sir. Um You, it's very easy to copy paste comments from there. There is a button to copy um it um and then you can keep uh the uh webinar on one side and like the instruction on another side. Um Hopefully you have two monitors. Um Yeah. Uh Let us know we have time to help you. It's gonna fire up digital studio code and I'm going to bump that font size up. I also need a, how big do we need it? Actually. Let me just do a double click there. All right. So that should be readable. I hope for most folks. Let's see. Are we done installing? Nope, hope you don't have any issues, network issues again, you might change an internet provider. Yes. Uh my uh my internet provider which I remain nameless. Uh uh bit me at the worst possible time. Last, last workshop we did. So how are folks stay along? Did this, did this actually finish installing for them? In the meanwhile, we can actually go on a little bit of a uh a tour here. Um So within the Infra directory, right, we have a Python virtual environment. Uh And then we have our main dot py and this is where uh we're gonna be defining our infrastructure. In fact, uh let's give this thing, it changes import statement just a little bit and then we're gonna go needs to be a S dot Has three bucket dot Has three it parks and go AC L. There was public raid, I believe. So, China is asking if there is um let's try it, Josh, probably let's go for like why we have two folders and like what one folder for and what is second and like what we are doing? Um Not sure if everybody catch it up. OK. So it looks like, OK. Um So uh we can explore these uh these files. So um this uh this workshop assumes like some basic familiarity with Pulumi, but I can quickly go through what we have here. So this info directory again is the um is the uh the Pulumi infrastructure code that and I have just spilled my water. Uh It's always an adventure. Um So this is the Pulumi Infrastructure code. Uh The uh this is the um config file for our stack that uh config file includes the region to which we are deploying and I'm going to use my shirt to dry my water. Uh Next, we have the Pulumi program configuration file which gives the, the basics of like what are um of our infrastructure code. Uh Next, we have our standard PP requirements dot TXT file. Uh So that includes the uh Pulumi uh SDK and the uh the library Pulumi aws which gives us um which gives us uh access to create AWS resources. So, in the policy directory, so this is a, this is a, a policy pack. Uh We again have a Python virtual environment. Uh We then have the main uh function here. Uh This is our basic uh So Pulumi has um Pulumi has uh created a kind of skeleton for us of an AWS policy pack. Uh And we can explore that a little bit. So the first thing we do up here uh is we uh we import the necessary objects from the Pulumi policy library. Uh And then, so this, this is what allows us to create our rules in our policy pack. Uh The next thing we have is our validator function. So this is a resource validation function. Uh And it takes uh a standard signature of uh resource validation arcs and a function to call uh if we find that our resource is in violation of a policy. Uh So the first thing we do in this function is we check to make sure that like we're actually looking at an S3 bucket. Uh And we look at whether the user has defined an AC L. Uh And then if that AC L happens to be public read or public read, right, then we report the violation and the level of violation that we report is dependent upon whether we configure the enforcement level to be mandatory advise or advisory if it's disabled. Uh then the check won't, the violation won't be reported at all. And again, we'll demonstrate that shortly. Uh So, and then once we define the validator function, we create the actual policy. Um the way we write this essentially take uh And, and you can do this, you can define this the, the validate uh function in line if you want, it's just a little bit easier to read if you celebrate, if you excuse me, if you separate the validator function uh from the, the policy. So uh this adds, this gives it a name and then this name will print out when we violate the policy. Uh And uh we give it a description, uh this description uh I believe displays in the Pulumi service U I if we want to configure it through there. And then finally, we create the policy pack which is kind of like the library as a whole. Uh This policy pack only has one policy in it. Uh But we will be adding uh additional policies later as time goes on. Uh So let's take a look here. We should be done pulling down. Yeah, we're all done pulling everything down. Cool. So um coming back to uh the tutorial here, uh we are going to uh yeah. Ok. Let me, let's see if we can get this policy to run. Where is? Ok, cool. No, not the the book. Give me the terminal. There we go. OK. So let's move to the Infra Directory. Uh I'm going to add a dependency to uh requirements of TXT in the Infra directory. Uh This is like a little bit of weirdness with um with how uh this works in Python that you have to have the plume policy library uh there before um before you can run a policy in a Python program, it works a little bit differently in uh typescript. So I'm gonna start my virtual environment uh And then I'm going to install my requirements. OK? Cool. So those are now installed. And so let's take our infrastructure which we have here. OK. So we have the AC L set to public read. We have the policy here that says you can't set it to public read and then we're going to run the Pulumi preview command and we're going to set the policy pack uh flag to run the policy pack in our policy directory. And hopefully that makes sense everyone. So let's give that a run and we'll see what happens. Ok, great. So the preview command failed and we get in here with our policy violation uh that we are, that we have violated the policy rule that we set. Uh, let's go into our policy, which we still have up here and let's change this enforcement level to uh to advisory. All right, and then let's run this again. All right. So now we see that this policy violation comes through as advisory. However, uh we can see that our command did not fail. There would be a uh let's take a look, scroll up a little bit here, right? So you can see the, it might be a little tough to see. But the arrow here in my prompt indicates that the previous command returned a non-zero exit code when I ran this with the mandatory flag. Uh And so the command failed and that would typically fail like our IC deployment pipeline. But here we have a clean output, this return zero. And so the command would succeed. Uh If we want to, we can see what it looks like when we disable it altogether. It's all and we'll try it one more time. Ok? And then we get no output whatsoever. Uh It does say that it ran the policy pack, but we don't get any indication that we're in violation of a policy because our enforcement level is disabled. So while it's disabled, let's actually deploy it by running the com uh Pulumi up command. Ok. So our infrastructure has been created. Hm. All right. That makes sense. So now let's change the enforcement level back to mandatory and we're not pulling me up again. So what do we think is gonna happen here? Uh Well, it's definitely gonna succeed because I didn't tell it what policy pack to do. Ok. So now we're gonna run the plume off command again, but this time we're going to pass it the policy pack um uh path. So this is a all right, run an update which there will be no changes in because we haven't changed our infrastructure code at all. We've only changed the policy. And so here we can see that our policy pack still runs uh against infrastructure that has already been deployed. And this is a very good thing because this will allow us to introduce policies in our organization after infrastructure has already been deployed because the ultimate goal of our policies is that everything is in compliance. So in a production, you might want to start to introduce your policies as advisory first and then give your infrastructure and application teams uh a chance to catch up with those policies and then you might eventually make them mandatory. OK. So uh scrolling over to my notes, I think we've covered. So that, that pretty much covers all of the material in the uh first module. Uh So now we're gonna move on to the second module. Uh And in this module, we're going to be offering uh some uh policy or two. And we're gonna see like what, what that experience is like. So um let's write a new resource policy here. Uh Let we're gonna add the uh force destroy flag to. So we're gonna go back to our infrastructure here and we're going to add the force destroy equals true. OK? And what this does is uh this will, this will kill all of the objects in the bucket along with the bucket when you delete it. Uh And so this is obviously not something you would wanna do uh if there is data that you want to keep. So uh let's add a function uh to our policy that ensures that um that this flag cannot be set. So we're gonna define a function. We're gonna go S3, no force destroy. And then, uh as I mentioned earlier are uh we have the signature of AGS which is resource validation ARG and then report violation, which is the uh function that we'll call. If we are in a violation of the function, I forgot my column there, port violation. OK. Great. OK. So the first thing we're going to check is the resource type. So all um all resources get passed through all resource validation functions. So uh there are some cases where you might want to use a single validator against multiple resources. Uh I can't think of any off the top of my head right now. But I could, could if I had more time. So we can do arcs that resource type equal or is not equal to PWS S3 bucket. And, uh, this identifier is like you'll, you'll get the pattern of these, um, these, uh, I, I if you really want to do a deep dive, uh, within the, so part of the internal magic that allows Pulumi to work with multiple languages is that we have a uh an internal schema to our providers like the AWS provider. And this is just the identifier within that schema for a bucket. So, uh buckets have a resource type. So if we are not looking at an S3 bucket, we wanna quit. We're not, we're not interested in validating this any further. So, uh and now we have to say if force destroy is not in Arcs dot Props and Arcs dot Props will be and then we're going back to the infrastructure here. Arcs dot Props will give us, for example, the AC L and the force destroy value. Uh If, if force destroy is not specified, we're good. We don't need to validate any further. Uh You may be wondering again why we're using uh lowercase F capital D destroy uh instead of force underscore destroy as it is in our Python program. Uh Again, this is uh because we are using the identifier that's in the Pulumi schema A again, the, the identifiers in the schema follow a pretty regular pattern uh that which should be pretty easy to pick up. But this is kind of part of the magic that allows us to use a policy pack written in any language against infra infrastructure written in any other language. So uh if we are, if force destroy has not been set, then we can return. OK? And now finally, if ours do props, yeah, if force destroy is uh set to true, now we're gonna call report violation and we'll say forest destroy must be disabled for S3 buckets. Um Alternatively, so you, we could throw additional um conditions on here. We could maybe look at the tag and say if the tag is uh if the tag is not equal, if like environment, if we had an environment tag that is not equal to production, uh We might, we might want to um allow force destroy or we might say if the, the tag environment must be set to the value dev uh There's a lot of different ways we could slice and dice that. But for now, we're just gonna do a simple rule. OK? So the next thing we need to do uh is we need to create the actual resource uh validation policy object that we've written our validator function. And actually let me take a moment right now to pause. How are folks getting along in the chat? Is uh is this clear to everybody? We have one question from Daniel. So Daniel asks, do you have advice or best practices for writing tests to test your policies? Um So you would be able to uh export these functions uh using, you know, whatever uh either using the, the in Python, you could import, um you could import the module in typescript, you could export these. But um as you can see here, like, you know, you would be able to test these just by passing through uh resource validation arcs and um and report violation and writing uh unit tests just the same as you would with any other application code. Um You don't really, you wouldn't really need much um special stuff beyond that. If you wanted to write integration tests against that, uh you certainly could do that it. Um I'm gonna mention this a little bit more later but Pulumi has this uh has a library called Aws Guard uh that does have integration tests that tests like full Pulumi programs against this. But um for the purposes of offering a policy pack that's probably not necessary. Um you will probably be able to do this just via simple unit testing. Uh If that answered your question, could you throw me a thumbs up? And also if anyone else has questions, uh Please do, let me know um how are folks co uh following along is, is everything clear so far? All right. Well, I am uh cool. All right, I answered Daniel's question. And again, if anyone else has any questions or you need me to go over anything, just say the word and I'll be happy to do that. But uh as long as the chat is clear, uh I'm going to uh move along here. So let's create our um our actual rule which we'll call S3 uh no force destroy. Uh And we're gonna call the resource validation policy constructor. OK? So we're gonna give it a name. Uh And this is just an identifier that's going to spit out. Uh So, you know, for the uh prefabricated rule that we ran earlier, uh We have this S3, no public read. That's exactly what's going to spit out the command lines. We're gonna go S3. No force destroy. Cool. OK. Let's give it a description and we can say prohibits force destroy on F three buckets. Cool. And then we need to say what the validation function is valid date equals. Uh And that's gonna be the function that we defined above. And then finally, we need to add it to the policy pack. OK? Uh One more thing I'd like to show is that uh so I mentioned that this enforcement level here at the policy pack level that uh that enforcement level uh is uh is the, it becomes the default for all policies, however, you can override this at an individual policy level. So uh let's make this one. OK? Enforcement level equals. Yeah, so I just copy this line, think that's one advisory. So we have saved this and uh back in the infra uh back in our infrastructure uh file. Uh We note that for story is set to true. So let's see what happens when we run Kalume preview against our policy pack. OK? And just as we expect, uh we're still in violation of this no public greed policy. Uh And our new policy uh indicates that we are uh in violation uh at an advisory level. And hopefully, if we change this to be false, which is the fault, we could also admit it and we would have the same effect. And we run this again, we only see the previous mandatory uh violation for our uh for our AC L. And so we are now in compliance with the new policy we've written. Uh and it's really that simple. Uh So I'm gonna take another pause for questions. Uh But if there are no questions, we uh can move on to demoing some of the enterprise features. Um How are folks getting along in the chat? Is there anything else I could explain uh anything else that was unclear? Do you want me to go over anything you want me to change anything in the code? Uh Happy to, to do whatever I can to illustrate uh the utility of, of Polu policy packs. And Marina has just posted a link to some of the, the documentation. That's our, our cross guard, uh, guide in, in the Pulumi docks. All right, I'm gonna give it last call for questions for the moment. Ah, we have a question from Raul. Uh, would this also work for Kate's Provider? Resources? Yes. Yes. Uh, so any Pulumi, um, yes. And for any third party provider. Yes. There's nothing that's AWS specific about policy packs. We're just demonstrating them with AWS resources. Uh, if you were writing a Kubernetes policy, uh you would be checking against, uh instead of, let's say you would be checking against uh instead of AWS S3 bucket. Uh you would be doing, I think it would be like Cooper Netti V one, blah, blah, blah, blah, blah. And maybe you'd be checking uh deployment or the replica sets, uh you, you and then you would likewise be able to go through the uh properties of your, your replica set to find like, oh, like, you know, you're not allowed to deploy, you know, a single replica and, and replica set. Uh And it, it will work with, uh it, it should work with any other provider uh in the, in the Pulumi ecosystem, uh Any other questions? Ok. That's good. Let's move on. Then guys, you can post any question any time and I, oh, we have a meal from and uh so is Aws Guard updated to match changes in Aws trusted advisor or SCP Guard rails. Uh So the answer is not at present. Uh A W guard is still in preview, I think it's at like 0.4. Um However, uh if you want to submit uh github issues to like get those things uh to get those things in there, uh that's, that's stuff that we would love to uh provide for you. So, um and there's definitely, there's no, there's no like automated uh update, but we uh our intent is to eventually make a US guard like a pretty complete uh set of rules uh that should help you, uh ensure that your, um, that your infrastructure is, is in good shape before it goes to production. Ok. So, uh, at this point, I am going to uh bring over uh the Pulumi App, ok? And I will, ok. So this, uh, is the Pulumi Service uh in the Pulumi Service, you get a list of your, um, stacks. Um You can see here. So the way that, um, the way that, uh you, if you want to do the two week free trial uh in and you sign up for your plume account, you'll have an individual one. So that's, that's my individual. And then if you want to uh sign up for a trial, you can go create organization and then that will take you to the trial um initialization page. Um In the Pulumi, uh in the Plumy App, we get uh a list of stacks. We get, uh, you can see like the update history, you can see what resources are in your stack, you get convenient links to open those resources in the A DS console. If you want to inspect them, uh You get a history of all the updates that you uh did uh along with the um along with the uh output from the command line. Uh So this kind of provides visibility when you're working in a team context as to like who changed what and when always very important when you're dealing with infrastructure, and you can see that even our attempted uh update, which failed our policy uh is also included in here. So essentially all the output of the command line is also available within the plume service. Um So what I'm gonna do next is we are going to make a new directory. And what we're gonna do is we're going to leverage the uh Pulumi Aws Guard library and I'm going to go uh Pulumi uh give me one second to make sure I type this command, right? So the first thing I'm gonna do is set my uh default org which is to my personal, my, it's, it's an organization, but I'm the only one in it. Uh And we're going to go ploy policy new and uh just like when you run a ploy new, uh you're gonna be able to choose from a list of existing templates. And so, uh what we're gonna do here is we're gonna select Aws Guard typescript um as you can see, we have, uh, about a dozen or so, uh, different templates for you to start writing your policies from. Uh, but Aws Guard is going to, uh, bring in the, uh, Pulumi Aws Guard Library which has, I think something like, yeah, it's got, it's got dozens of rules, uh, at least. So, let's see, uh, what that generated. Let's fire our visual studio code. So, yeah, we don't need to do that. We can reuse the existing window. I'm gonna close all of the previous stuff and so we're gonna go here and let's see what it created. OK. So, um this, so we're jumping languages a little bit and I hope folks are able to follow. If anything is unclear, please just call it out um in the chat and uh we'll, you know, try and get that answered for you. So, uh so we're pulling in this Aws Guard uh class, which is the, so what we're doing here is a little bit different rather than authoring a policy pack. We're actually consuming one. And so the Aws Guard library and typescript is a published pluming pack uh that's available for you to consume. And so within Aws Guard, uh you have a whole bunch of rules and if we, so you can see here, we have like for example AC M certificate, expiration, uh and then for each of these rules, we can configure uh the um the enforcement level for each rule and So at present, so like we might want to uh disable, for example, AC M certificate. Expiration. Um So you can, so essentially what we're doing here is like we're taking an existing set of policies and we are consuming them and configuring them the way we want. Uh And uh someone in the chat is getting an error when executing. Uh OK. Uh If um I ask it to push me in there, OK. Great, great. So, uh, we'll try and get you helped out as soon as possible. Uh, so what we're gonna do now is we're gonna take this policy. So, yeah, imagine in your mind that we're going to, you know, look through all of these rules and we're going to either make them warnings or disable them. Uh, you know, as we, as we see fit. Ok. And then we're going to move to the directory and then we're gonna go, um, the command text. So I don't have to hunt and peck here. Oh, and you will probably not have to do this, but I do because I have published an identically name policy many times. So we're gonna a version 0.0 0.4. Um, you at home will, if you're following along, will not have to fill this in unless you've already published a, a policy pack by this name. But, uh, my organization has a little bit of leftover state from previous times. I've run through this demo. So Uh Now let's publish our policy. Ok, great. So, uh you can see the uh Pulumi command line gives us a nice handy Perma link, but I'm just gonna jump to the service. And if you go under policies, uh you can see that this is the um this is the policy pack that we have published. Uh We can click into it and see a nice display uh of all of the um all of the uh the rules and their enforcement level and their description. Um just like uh you might remember earlier when we were offering our own policy pack. Uh These are the, the attributes that we were defining, right? Because we gave it a name, we gave it an enforcement level and we gave it a description. So this by itself is not going to do anything. Uh It's not going to via uh it's not going to validate any of our uh stacks, our Pulumi infrastructure uh in order to do that, we need to go to the policy groups. And so what policy groups do are they allow us to uh automatically enforce a policy pack across a group of Pulumi stacks. Uh And when you uh when you enable the business critical features, if you sign up for that, for that two week free trial, uh you will get a default policy group. And so the uh default policy group will by default include all of your stacks. So you don't need to do anything extra to ensure that your stacks are covered by whatever policies you associate with the default policy group. Hopefully that makes sense. Someone give me a thumbs up in the chat. If that did make sense to them, I can only assume that silence means that it was perfectly understandable. So, within our default policy group, there we go. There's all right. There's a thumb up. So, uh, what we're gonna do is we're going to add the policy pack that we just published to this policy group, Pulumi Aws card. Uh And then we're gonna select the version. So in a more production scenario, uh you will be able to safely roll out these policy versions uh and not have them like be automatically applied everywhere. So you can sort of like, you know, if you want to canary, canary deploy uh new policy packs and only apply them to like one or two stacks just to make sure that, that they're not gonna cause all hell to break loose. Uh You can do that, you can roll these things out in a very controlled way. So we're gonna select version four, which is the one that we just published. And then when we do that, you'll notice that uh we can configure each of these individual rules um in uh in, in this U I now, uh we didn't cover this because we didn't offer them because it's, it's, it's a little bit tricky to to offer them within, within this workshop context. But every individual policy rule, uh you can define a configuration schema and that configuration schema allows you to essentially pass parameters to the rule. Uh So you might say, for example, uh this, this is for um for IM access keys uh that you can set the advi the enforcement level which we've already covered. But you can also set this parameter that says the max key age must be 90 we might change that to say 30. Um This uh the, the details of this are in the Pulumi docs. Uh but it's a little bit more of an advanced feature and uh you might want to wait a little while until you get comfortable using policy packs before you add the configuration scheme as to each rule. Um But you can see that we can have sort of numerical parameters uh in it. We, we can have uh bullying stuff. So, you know, this is a, this is a rule that controls which api gateway types we allow. Uh Let's see if there's anything else interesting in here. Uh looks pretty much like. Uh so uh for encrypted volumes, you can say that they must be encrypted with a particular K MS key uh looks like we can, yeah, we can create lists of note types that are allowed in our red ship clusters, things like that. So let's enable this policy pack. And then you can see that within the U I, we also get a nice list of the configuration. And so, um let's see what happens. So what we're gonna do is we're gonna go back to our infrastructure and we're gonna change directories back there and we're just gonna run Pulumi preview. Um I'm gonna check my configuration one last time. So we did. All right. So yes, so we added that good. So we're gonna run the Pulumi preview command now and let's see what happens and you can see. So we added this policy pack to the default uh the the default policy group. And so that means that it will apply by default to every stack in our organization. And so it is running right now, you can see that it downloaded and installed the policy pack that we just published and automatically ran it for compliance. And so this is kind of so like we no longer have to include this dash dash policy pack flag to ensure that the policies are, are applied. Uh The way we would like. Uh So that is the end of the demo of the business critical features uh with Pulumi policies. So at this point, I would like to know, do you folks have any questions? Is there anything else you'd like to see me demonstrate? And it is quite in the chat at the moment. Any other questions folks would like to see answered about plenty policy packs. Uh Another question uh is the only way to enforce a policy pack by using the Pulumi service. If you don't use the plume service, you have to trust the developers to use the policy pack, right. Uh That is essentially correct. There are other ways around that. If your infrastructure team controls the pipeline, you might be able to define the command so that it forces you to use the policy pack. Um But that is yes and that's essentially the value prop of using uh using the Pulumi service is that you get that uh that enforcement uh kind of automatically without having to manage the policy pack command itself. Uh Are there any managed ploy policy packs for SOC or ISO uh not at present? Uh If that's something you'd like to see, please provide us some feedback. Uh You could do that via github issues. Uh That would be one way to do it. Another way is to reach out in the Pulumi community slack and that will definitely get the eyeballs of some Pulumi employees. All right. Does anyone else have additional questions? Please do not be shy because we are finished a little bit early. Although I don't think if I let everyone go early, anyone would necessarily complain but happy to stick around and answer questions. OK. So um if you would like to continue your journey uh with Pulumi or oh, we have another question. The Q and A uh when the policy is applied, does it apply to pre deployed infrastructure or only infrastructure deployed after the policy is applied. Uh That's a great question. It applies to infrastructure, all infrastructure, whether it's been deployed or whether we're planning to deploy it. And that way, um but that way, like we can introduce policies after the fact because in, you know, in a lot of orgs that you may have experienced, you know, there's maybe not a lot of policy around, around cloud uh usage. Uh And then hopefully before an incident happens, we, we realize that we need to put some controls around these things. Uh And so you can apply policies after the fact and they will apply to infrastructure that's already been deployed. Uh It, the, the plumbing policies will not necessarily remediate it, but it will essentially stop your infrastructure pipeline uh from proceeding until the infrastructure is remediated. I have one more in the chat. Can we use Plumy to create an Sts resource token service? Uh Jose, if you could explain a little bit more, I'm not sure what I mean there is presumably, let me check here in the registry. I mean, I would assume. So, uh I can't think offhand of uh which uh which resources you might need. Let me look at the A DS classic documentation. There's not an sts name space per se um which uh which resource? Uh All right. So if you get back to us in the chat, I'll uh I'll continue my spiel on continuing your journey and uh just let me know if there's anything we can do to clarify that answer. Uh So we have uh workshops at the Pulumi um at the Pulumi website. Uh Most of the workshops we give, have a self guided component. You can check those out. Uh So you can go to Pulumi dot com slash resources. Likewise, uh this um we have, if you go to Pulumi dot aws workshop dot IO, uh you can view the self guided version of this workshop in addition to a lot of other material we have out there uh including stuff that'll get you started writing infrastructure in Pulumi. Uh We also have documentation on all the like cross guard core concepts that will help you author your own policy packs. Uh There is a lovely examples repo that will give you a whole bunch of um full Pulumi programs uh that spin up infrastructure that uh is, is uh they'll demonstrate the use of all the various services. Uh We also have a new thing. There are these Pulumi templates. Uh They also live in the examples uh repository. But if you go to, I think it's Pulumi dot com slash templates, uh They're like a little bit more fleshed out. So um we uh today demonstrated like just, we just went um Pulumi New Aws Python, which uh creates like only a single S3 resource. But um we have a template that will do like for example, an entire static site and there's a whole bunch of templates out there. Uh They should cover all of the major architectures that you might want to try. We have one for container, one for serverless uh static sites, probably a few others uh that I can't remember off the top of my head, but go check it out. Um Those templates are like really, really useful and I think they're really gonna be great. Uh maybe for coming like from the policy side and then want to see uh a little bit more of like the infrastructure uh creation abilities. And then finally, we have a AD US guard which is a kind of prefabricated uh list of AWS rules. Uh And so, um that's what we demonstrated uh when we pushed our policy pack to the Pulumi service. However, you can also use AWS guard in an open source way if you just supplied the dash dash policy pack flag uh to the um to the A W guard um policy pack that we created. So a few more questions in the chat have come through and let's take a look at those. So, Eric says, uh I believe I saw there was an integration with open policy agent. How does this relate to the set up here? So I have not used the op A integration. Um I think at this point it's fairly rudimentary. Um but there is some interop uh between Pulumi and OP A but I'm not sure that the full compliment of, um, uh, I forget the name of the, of the OP A um, of the OP A like a declaration library. If someone wants to throw that in the chat, I will be happy to mention that. But, um, I don't think we support all the constructs in OP A but some of them are, uh, if you want to give that a try uh and give us some feedback on it, that would be, that would be stupendous. Uh Daniel asked follow up from the previous question. Is there a way to enforce policies, new resources as mandatory but existing resources as advisory. Good question. If you want to join the Pulumi Slack or DM Me on Twitter. Uh My handle is at the top of this slide, I will be happy to run that for you. I don't know offhand. Uh If, when a resource is passed through to that validator function, uh if you're able to tell whether it is new or existing, uh You might though maybe um that's actually, that's a great question and maybe I'll, maybe I'll add that to the uh to the um tutorial. Uh If, if I can figure that one out, uh how does cross guard compare it to Sentinel? Um So, uh that's a great, great question sent for those that don't know Sentinel is uh hasp's um policies, code tool uh to uh to my knowledge, uh I believe Sentinel only works with um HCL uh configurations. Uh Likewise Pulumi cross guard uh will only work against uh Pulumi programs. Uh And Eric noted that Rego is the uh the policy language for OP A which is, thank you. That's the one that I could not remember. OK. So any more questions from anyone uh If you, if you do think of any questions uh afterwards, by the way, uh please feel free to um to um DM me on Twitter or, or at or mention me on Twitter. Uh My handle is it again at the top of the slide? It's my name Josh Kara. Uh You can also find me on the Plume Community Slack. Uh Feel please, if you're gonna ask a question, the Community Slack uh do ask that in a public channel so that other folks uh both have an opportunity to answer uh and also uh not only to answer but also to um uh not an answer but so that other folks maybe with the same question are able to view it. OK. Well, if that's uh there are no further questions, I wanna thank everyone for joining us today. I really appreciate you spending some time with us. Uh And we hope you have a great time uh using Pulumi policy as code.

---
