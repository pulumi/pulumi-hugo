<nav class="toc pl-4">
    {{ if hasPrefix .RelPermalink "/docs/" }}
        {{/* Render a top-level menu for our major docs sections */}}
        {{ $toc_page := . }}
        {{ $toc_sections := slice "Download & install" "Get started" "Clouds" "Concepts" "Using Pulumi" "Languages & SDKs" "Pulumi CLI" "Pulumi Cloud" "Support" }}
        {{ $toc_menus := dict "Download & install" .Site.Menus.install "Get started" .Site.Menus.getstarted "Clouds" .Site.Menus.clouds "Concepts" .Site.Menus.concepts "Using Pulumi" .Site.Menus.usingpulumi "Languages & SDKs" .Site.Menus.languages "Pulumi CLI" .Site.Menus.cli "Pulumi Cloud" .Site.Menus.pulumicloud "Support" .Site.Menus.support }}

        {{ range $index, $element := $toc_sections }}
            {{ $sidenav_selected := "" }}
            {{ $toc_name := . }}
            {{ $toc_menu := (index $toc_menus $toc_name) }}

            {{ $toc_section_link := "" }}
            {{ range $toc_menu }}
                {{ if (eq .Name "Overview") }}
                    {{ $toc_section_link = .URL }}
                {{ end }}
            {{ end }}

            {{ if (eq $.Page.RelPermalink $toc_section_link) }}
                {{ $sidenav_selected = "active" }}
            {{ end }}
        {{ end }}

        {{ range $toc_sections }}
            {{ $toc_name := . }}
            {{ $toc_menu := (index $toc_menus $toc_name) }}

            {{/* If this section has an "Overview" page, link to it from the header */}}
            {{ $toc_section_link := "" }}
            {{ range $toc_menu }}
                {{ if (eq .Name "Overview") }}
                    {{ $toc_section_link = .URL }}
                {{ end }}
            {{ end }}

            {{ $toggle_class := "toggle" }}
            {{ if or (hasPrefix $.Page.RelPermalink $toc_section_link) (eq $toc_name "Clouds") }}
                {{ $toggle_class = "toggleVisible " }}
            {{ end }}
            <p class="no-anchor toc-header toggle-topLevel {{ $toggle_class }}" id="{{ $toc_name | urlize }}-toc-header">
                {{ if and ($toc_section_link) (ne $toc_name "Download & install") (ne $toc_name "Get started") (ne $toc_name "Clouds") }}
                    <span class="toggleButton-topLevel down">
                        <i class="fas fa-angle-down"></i>
                    </span>
                    <span class="toggleButton-topLevel right">
                        <i class="fas fa-angle-right"></i>
                    </span>
                {{ else if (eq $toc_name "Clouds") }}
                    <span class="header-no-children">
                        <i class="fas fa-cloud"></i>
                    </span>
                {{ else }}
                    <span class="header-no-children">
                        <i class="fas fa-file-alt"></i>
                    </span>
                {{ end }}
                <a href="{{ $toc_section_link }}">{{ $toc_name }}</a>
            </p>

            <div class="top-level-container">
                {{ template "toc" (dict "page" $toc_page "menu" $toc_menu) }}
            </div>
        {{ end }}
    {{ end }}

    {{ define "toc" }}
        {{ $page := .page }}

        {{ range .menu }}
            {{/* Note that we skip "Overview" pages, since they are linked to from above */}}
            {{ if or (ne .Name "Overview") }}
                {{ $toggle_state := "toggle" }}
                {{ $sidenav_selected := "" }}

                {{ if or (eq $page.RelPermalink .URL) (and (not .HasChildren) (hasPrefix $page.RelPermalink .URL) (ne .Name "Troubleshooting")) }}
                    {{ $toggle_state = "toggleVisible" }}
                    {{ $sidenav_selected = "active" }}
                {{ else if hasPrefix $page.RelPermalink .URL }}
                    {{ $toggle_state = "toggleVisible" }}
                {{ end }}


                <ul class="{{ $toggle_state }}">
                    <ul class="collapsed">
                        <li class="sidenav-topic {{ $sidenav_selected }}">
                            {{- if .HasChildren -}}
                                <span class="toggleButton">
                                    <i class="fas fa-angle-right"></i>
                                </span>
                            {{ else }}
                                <span class="toggleButton-topLevel header-no-children">
                                    <i class="fas fa-file-alt"></i>
                                </span>
                            {{- end -}}
                            <a href="{{ .URL }}" data-track="toc-{{ .Name | urlize }}">{{ .Name }}</a>
                        </li>
                    </ul>
                    <ul class="expanded">
                        <li class="sidenav-topic {{ if .HasChildren }}sidenav-parent{{ end }} {{ $sidenav_selected }}">
                            {{- if .HasChildren -}}
                                <span class="toggleButton">
                                    <i class="fas fa-angle-down"></i>
                                </span>
                            {{ else }}
                                <span class="toggleButton-topLevel header-no-children">
                                    <i class="fas fa-file-alt"></i>
                                </span>
                            {{- end -}}
                            <a href="{{ .URL }}" data-track="toc-{{ .Name | urlize }}">{{ .Name }}</a>
                        </li>
                        {{ if .HasChildren }}
                            <div class="sidenav-subsection">
                                {{ template "toc" (dict "page" $page "menu" .Children) }}
                            </div>
                        {{ end }}
                    </ul>
                </ul>
            {{ end }}
        {{ end }}
    {{ end }}
</nav>
